<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INFINITI KAPITAL - Journal Profesional</title>

  <meta property="og:title" content="Infiniti Kapital - Journal de Trading Profesional" />
  <meta property="og:description" content="Una herramienta profesional para registrar y analizar tus operaciones de trading." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://journal-infiniti-kapital.netlify.app/" />
  <meta property="og:image" content="https://journal-infiniti-kapital.netlify.app/logo-infiniti-kapital.jpg" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


  <style>
    :root{
      --primary:#0f172a; --secondary:#1e293b; --accent:#d4af37;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --card-bg:rgba(15,23,42,.86); --border:rgba(255,255,255,.12);
      --text:#f1f5f9; --muted:#94a3b8; --backdrop:rgba(0,0,0,.5);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      display:grid; grid-template-columns:260px 1fr; grid-template-rows:64px 1fr;
      grid-template-areas:"sidebar header" "sidebar main";
      font-family: sans-serif;
    }
    header{
      grid-area:header; display:flex; align-items:center; justify-content:space-between;
      background:var(--secondary); border-bottom:1px solid var(--border); padding:0 16px; z-index:20;
      position:sticky; top:0;
    }
    .left-h{display:flex; align-items:center; gap:12px}
    .date{color:var(--muted)}
    .user{display:flex; align-items:center; gap:12px}
    .avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#111;display:grid;place-items:center;font-weight:800}
    .burger{display:none; background:none; border:0; color:var(--text); font-size:22px; padding:8px; cursor:pointer}

    .sidebar{
      grid-area:sidebar; background:rgba(15,23,42,.96); border-right:1px solid var(--border);
      display:flex; flex-direction:column; height:100%; position:relative; z-index:30;
      transition:transform .3s ease;
    }
    .logo{padding:16px 18px; border-bottom:1px solid var(--border)}
    .logo img {
      width: 90%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .nav{padding:10px}
    .nav a,.nav button.nav-link{
      width:100%; display:flex; align-items:center; gap:12px;
      padding:12px; border-radius:10px; color:var(--muted);
      text-decoration:none; background:none; border:0; cursor:pointer;
      font-size: 15px;
    }
    .nav a:hover,.nav a.active,.nav button.nav-link[aria-expanded="true"]{
      color:var(--accent); background:rgba(212,175,55,.12);
    }
    .nav .icon{width:22px; text-align:center}

    .submenu{display:grid; gap:6px; padding:6px 0 6px 34px; max-height:0; overflow:hidden; transition:max-height .25s ease}
    .submenu a{padding:10px 12px; font-size: 14px;}
    .nav button.nav-link{justify-content:space-between}
    .caret{transform:rotate(-90deg); transition:transform .2s}
    .nav button.nav-link[aria-expanded="true"] .caret{transform:rotate(0deg)}
    .submenu.open{max-height:500px}

    main{
      grid-area:main; padding:20px; overflow:auto;
      display:grid; grid-template-columns:repeat(12,1fr); gap:18px; grid-auto-rows:minmax(100px,auto);
    }
    .card{background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.15)}
    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:14px}
    .card-title{font-size:1.1rem;font-weight:700}
    .btn-icon{background:none;border:0;color:var(--accent);cursor:pointer; font-size: 16px;}

    main > .section{
        display:none; 
        grid-column:1/-1; 
        grid-template-columns:inherit; 
        gap:inherit;
    }
    main > .section.active{
        display:grid;
    }
    .welcome{grid-column:span 8}
    .metrics{grid-column:span 4}
    .factor,.rr,.wins{grid-column:span 4}
    .dist{grid-column:span 6; grid-row:span 2}
    .recent{grid-column:span 6}
    .balance{grid-column:span 6}
    .risk{grid-column:span 6; grid-row:span 2}
    .news{grid-column:span 6}
    .challenge{grid-column:span 6}
    .chart{height:300px; margin-top:10px}

    .metric-card{background:rgba(30,41,59,.5); border-radius:10px; padding:12px; text-align:center}
    .metric-val{font-size:22px; font-weight:800; color:var(--accent)}
    .metric-lab{color:var(--muted); font-size:13px}

    .fab{
      position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:50%;
      background:var(--accent); color:#111; border:0; font-size:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:25;
    }

    .modal{
      display:none; position:fixed; inset:0; padding:20px; background:var(--backdrop);
      z-index:1000; align-items:center; justify-content:center;
    }
    .modal.show{display:flex!important}
    .modal-content{
      width:min(92vw,560px); max-height:85vh; overflow:auto;
      background:var(--card-bg); border:1px solid var(--accent); border-radius:16px; padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .modal-content.modal-lg{
      width: min(92vw, 900px);
    }
    .modal-header{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--accent); padding-bottom:10px; margin-bottom:14px}
    .modal-header h2{margin:0; color:var(--accent)}
    .close-modal{background:none;border:0;color:var(--muted);font-size:22px;cursor:pointer}
    .close-modal:hover{color:#fff}
    .form-group{margin-bottom:12px}
    .form-group label{display:block; margin-bottom: 4px; font-size: 14px; color: var(--muted);}
    .form-control, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:rgba(15,23,42,.6); color:var(--text); font-family: inherit; font-size: 1rem;
    }
    textarea{min-height: 80px;}
    .modal-footer{display:flex; justify-content:flex-end; gap:8px; margin-top:10px}
    .btn{border:0; border-radius:10px; padding:10px 14px; cursor:pointer}
    .btn:disabled {
        background-color: #334155;
        color: #64748b;
        cursor: not-allowed;
    }
    .btn.primary{background:var(--accent); color:#111}
    .btn.secondary{background:#334155; color:#fff}
    .btn-link{background:none; border:none; color:var(--accent); padding:0; text-decoration:underline; cursor:pointer;}
    .btn.secondary.active { background-color: var(--accent); color: var(--primary); }

    .drawer-backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:25}
    @media (max-width: 1024px){
      .welcome,.metrics,.dist,.recent,.balance,.risk,.news,.challenge,.factor,.rr,.wins { grid-column:1/-1 }
    }
    @media (max-width: 860px){
      body{ grid-template-columns:1fr; grid-template-areas:"header" "main"; }
      .sidebar{ position:fixed; left:0; top:0; bottom:0; transform:translateX(-100%); width:280px; max-width:85vw; }
      .burger{ display:inline-flex }
      body.sidebar-open .sidebar{ transform:translateX(0) }
      body.sidebar-open .drawer-backdrop{ display:block }
      main{ padding:16px }
    }
    @media (min-width: 768px) {
      [style*="md:grid-column: span 4"] { grid-column: span 4; }
      [style*="md:grid-column: span 8"] { grid-column: span 8; }
    }

    #calendar-container .fc-daygrid-day-frame {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 8px;
        height: 100%;
        position: relative;
    }
    #calendar-container .fc-daygrid-day-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 4px;
        text-align: right;
    }
    #calendar-container .fc-daygrid-day-number {
       font-size: 12px;
       padding-right: 4px;
    }
    .calendar-day-content {
        text-align: center;
    }
    .calendar-day-pnl {
        font-size: 1.2rem;
        font-weight: 700;
    }
    .calendar-day-trades {
        font-size: 0.8rem;
        color: var(--muted);
    }
    .fc-day-other .calendar-day-content, .fc-day-other .fc-daygrid-day-top {
        opacity: 0.3;
    }
    .fc .fc-toolbar.fc-header-toolbar {
        margin-bottom: 1.2em;
    }

    .hidden{display:none!important}
    .only-admin{display:none}
    body.is-admin .only-admin{display:block !important}
  </style>
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <img src="logo-infiniti-kapital.jpg" alt="Logo Infiniti Kapital">
    </div>
    <nav class="nav" id="nav">
      <a href="#" class="nav-item active" data-target="dashboard">
        <span class="icon"><i class="fa-solid fa-chart-line"></i></span>Dashboard</a>
      <button class="nav-link" aria-expanded="false" aria-controls="sm-cal">
        <span><span class="icon"><i class="fa-solid fa-calendar"></i></span> Calendario</span>
        <i class="fa-solid fa-caret-right caret" aria-hidden="true"></i>
      </button>
      <div id="sm-cal" class="submenu">
        <a href="#" data-target="calendario">Vista general</a>
        <a href="#" data-target="reportes">Reportes</a>
      </div>
      <button class="nav-link" aria-expanded="false" aria-controls="sm-acc">
        <span><span class="icon"><i class="fa-solid fa-wallet"></i></span> Cuentas</span>
        <i class="fa-solid fa-caret-right caret"></i>
      </button>
      <div id="sm-acc" class="submenu">
        <a href="#" data-target="cuentas">Gestión</a>
      </div>
      <button class="nav-link" aria-expanded="false" aria-controls="sm-op">
        <span><span class="icon"><i class="fa-solid fa-exchange-alt"></i></span> Operaciones</span>
        <i class="fa-solid fa-caret-right caret"></i>
      </button>
      <div id="sm-op" class="submenu">
        <a href="#" data-target="operaciones">Historial</a>
        <a href="#" id="quick-add-trade">Agregar operación</a>
      </div>
      <a href="#" class="nav-item" data-target="analiticas"><span class="icon"><i class="fa-solid fa-chart-bar"></i></span>Analíticas</a>
      <a href="#" class="nav-item" data-target="seguimiento"><span class="icon"><i class="fa-solid fa-tasks"></i></span>Seguimiento</a>
      <a href="#" class="nav-item" data-target="estrategias"><span class="icon"><i class="fa-solid fa-chess-knight"></i></span>Estrategias</a>
      <a href="#" class="nav-item" data-target="configuracion"><span class="icon"><i class="fa-solid fa-cog"></i></span>Configuración</a>
      <a href="#" class="nav-item only-admin" data-target="admin">
        <span class="icon"><i class="fa-solid fa-shield-halved"></i></span> Admin
      </a>
    </nav>
  </aside>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <header>
    <div class="left-h">
      <button class="burger" id="burger" aria-label="Abrir menú" aria-expanded="false"><i class="fa-solid fa-bars"></i></button>
      <div class="date"><i class="fa-solid fa-calendar"></i> <span id="current-date"></span></div>
    </div>
    <div class="user">
      <div class="avatar">AT</div>
      <div class="user-name">Invitado</div>
      <button class="btn-icon" id="btn-login" title="Iniciar sesión"><i class="fa-regular fa-user"></i></button>
      <button class="btn-icon hidden" id="btn-logout" title="Cerrar sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
  </header>

  <main id="app">
    <section id="dashboard" class="section active">
     <div class="card welcome">
        <div class="card-header"><div class="card-title" id="welcome-title">Bienvenido</div></div>
        <p id="welcome-message" style="color:var(--muted)">Inicia sesión para guardar tus operaciones en la nube.</p>
        <button class="btn primary" style="margin-top:10px" id="btn-open-auth"><i class="fa-solid fa-right-to-bracket"></i> Acceder</button>
      </div>
      <div class="card metrics">
        <div class="card-header"><div class="card-title">Resumen</div></div>
        <div class="metric-card">
            <div style="display: flex; justify-content: center; align-items: baseline; gap: 8px;">
                <div class="metric-val" id="total-profit">$0.00</div>
                <div id="total-profit-percent" style="font-weight: 700; font-size: 1.1rem; color: var(--muted);">(0.0%)</div>
            </div>
            <div class="metric-lab">Beneficio Total</div>
        </div>
        <div class="metric-card" style="margin-top:10px"><div class="metric-val" id="win-rate">0%</div><div class="metric-lab">Tasa de Acierto</div></div>
      </div>
      <div class="card factor"><div class="card-header"><div class="card-title">Factor</div></div><div class="metric-card"><div class="metric-val" id="profit-factor">0.00</div><div class="metric-lab">Operaciones: <span id="total-trades">0</span></div></div></div>
      <div class="card rr"><div class="card-header"><div class="card-title">R/B</div></div><div class="metric-card"><div class="metric-val" id="risk-reward">0.00</div><div class="metric-lab">Promedio</div></div></div>
      <div class="card wins"><div class="card-header"><div class="card-title">Ganadoras</div></div><div class="metric-card"><div class="metric-val" id="win-trades">0</div><div class="metric-lab">de <span id="total-trades-2">0</span></div></div></div>
      <div class="card dist">
        <div class="card-header"><div class="card-title">Distribución</div><button class="btn-icon" id="refresh-distribution"><i class="fa-solid fa-rotate"></i></button></div>
        <div class="chart"><canvas id="distributionChart"></canvas></div>
      </div>
      <div class="card recent">
        <div class="card-header"><div class="card-title">Recientes</div><button class="btn-icon" id="add-trade-btn"><i class="fa-solid fa-plus"></i></button></div>
        <div id="recent-trades-container" style="color:var(--muted)">Sin registros.</div>
      </div>
      <div class="card balance">
        <div class="card-header">
            <div class="card-title">Saldo</div>
            <div>
                <span id="balance-growth-percent" style="font-weight:700; margin-right: 10px;">+0.00%</span>
                <button class="btn-icon" id="expand-balance-chart"><i class="fa-solid fa-expand"></i></button>
            </div>
        </div>
        <div class="chart"><canvas id="balanceChart"></canvas></div>
      </div>
      <div class="card risk">
        <div class="card-header">
            <div class="card-title">Riesgo</div>
            <button class="btn-icon" id="export-risk"><i class="fa-solid fa-file-export"></i></button>
        </div>
        <div class="metric-card" style="margin-bottom: 14px;">
            <div class="metric-val" id="risk-profit-percent">0.00%</div>
            <div class="metric-lab">Beneficio / Pérdida (Periodo)</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
            <div class="metric-card">
                <div class="metric-val" id="daily-risk">0.0%</div>
                <div class="metric-lab">Diario</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="weekly-risk">0.0%</div>
                <div class="metric-lab">Semanal</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="monthly-risk">0.0%</div>
                <div class="metric-lab">Mensual</div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px">
            <div class="metric-card">
                <div class="metric-val" id="max-win-streak" style="color: var(--success);">0</div>
                <div class="metric-lab">Máx. Racha Ganadora</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="max-loss-streak" style="color: var(--danger);">0</div>
                <div class="metric-lab">Máx. Racha Perdedora</div>
            </div>
        </div>
        <div class="chart" style="height: 200px;"><canvas id="riskChart"></canvas></div>
      </div>
      <div class="card news" style="height: 450px; padding: 0; overflow: hidden;">
        <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
          <div id="tradingview_f928c" style="height: 100%; width: 100%;"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
          new TradingView.widget(
          {
            "autosize": true,
            "symbol": "FX:EURUSD",
            "interval": "60",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "es",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_f928c"
          }
          );
          </script>
        </div>
      </div>
      <div class="card news">
        <div class="card-header">
          <div class="card-title">Calendario Económico</div>
        </div>
        <div class="card-body" style="padding: 0; height: 450px;">
          <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
            <div class="tradingview-widget-container__widget" style="height: 100%; width: 100%;"></div>
            <script async src="https://s3.tradingview.com/external-embedding/embed-widget-events.js">
            {
              "width": "100%",
              "height": "100%",
              "locale": "es",
              "colorTheme": "dark",
              "isTransparent": true,
              "importanceFilter": "0,1"
            }
            </script>
          </div>
        </div>
      </div>
      <div class="card challenge"><div class="card-header"><div class="card-title">FTMO Challenge</div><button class="btn-icon" id="edit-challenge"><i class="fa-solid fa-pen"></i></button></div>
        <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <span>Progreso</span><span id="challenge-progress-value">0%</span>
            </div>
            <div style="height:10px;background:#334155;border-radius:6px;overflow:hidden"><div id="challenge-progress-bar" style="height:100%;width:0%;background:var(--success)"></div></div>

            <div class="metric-card" style="margin-top: 10px;">
           <div class="metric-val" id="challenge-current-balance">$0.00</div>
           <div class="metric-lab">Saldo Actual</div>
        </div>

            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
                <div class="metric-card"><div class="metric-val" id="challenge-profit">+0.0%</div><div class="metric-lab">Beneficio</div></div>
                <div class="metric-card"><div class="metric-val" id="challenge-drawdown">0.0%</div><div class="metric-lab">Drawdown Total</div></div>
                <div class="metric-card"><div class="metric-val" id="challenge-trades">0</div><div class="metric-lab">Operaciones</div></div>
                <div class="metric-card"><div class="metric-val" id="challenge-win-rate">0%</div><div class="metric-lab">Acierto</div></div>
            </div>
            
            <div class="metric-card" style="margin-top: 10px; border: 1px solid var(--warning);">
                <div class="metric-val" id="challenge-residual-risk">0.00%</div>
                <div class="metric-lab">Riesgo Residual Diario</div>
            </div>
        </div>
      </div> 
    
    </section>

    <section id="calendario" class="section">
      <div class="card" style="grid-column:1/-1">
        <div class="card-header">
          <div class="card-title">Calendario de Operaciones</div>
        </div>
        <div id='calendar-container' style="min-height: 600px;"></div>
      </div>
    </section>
    
    <section id="reportes" class="section">
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div class="card-title">Generador de Reportes</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; align-items: flex-end;">
          <div class="form-group">
            <label for="report-account-select">Seleccionar Cuenta</label>
            <select id="report-account-select" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="report-start-date">Fecha de Inicio</label>
            <input type="date" id="report-start-date" class="form-control">
          </div>
          <div class="form-group">
            <label for="report-end-date">Fecha de Fin</label>
            <input type="date" id="report-end-date" class="form-control">
          </div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn primary" id="generate-report-btn" style="flex-grow: 1;">Generar</button>
            <button class="btn secondary" id="download-csv-btn" title="Descargar CSV" disabled><i class="fa-solid fa-file-csv"></i> CSV</button>
            <button class="btn secondary" id="download-excel-btn" title="Descargar Excel" disabled><i class="fa-solid fa-file-excel"></i> Excel</button>
            <button class="btn secondary" id="download-pdf-btn" title="Descargar PDF" disabled><i class="fa-solid fa-file-pdf"></i> PDF</button>
        </div>
        <div id="report-loader" class="hidden" style="margin-top: 15px; text-align: center; color: var(--muted);">
          <i class="fa-solid fa-spinner fa-spin"></i> Generando reporte...
        </div>
      </div>
      <div id="report-results" class="hidden" style="grid-column: 1 / -1; display:contents;">
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-total-profit" class="metric-val">$0.00</div><div class="metric-lab">Beneficio Neto</div></div></div>
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-total-trades" class="metric-val">0</div><div class="metric-lab">Operaciones</div></div></div>
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-win-rate" class="metric-val">0%</div><div class="metric-lab">Tasa de Acierto</div></div></div>
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-profit-factor" class="metric-val">0.00</div><div class="metric-lab">Profit Factor</div></div></div>
        <div class="card" style="grid-column: 1 / -1;">
          <div class="card-header"><div class="card-title">Detalle de Operaciones</div></div>
          <div style="overflow-x:auto;">
            <table id="report-table" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="padding:10px; text-align:left; color:var(--muted);">Fecha</th>
                        <th style="padding:10px; text-align:left; color:var(--muted);">Símbolo</th>
                        <th style="padding:10px; text-align:left; color:var(--muted);">Tipo</th>
                        <th style="padding:10px; text-align:right; color:var(--muted);">Resultado ($)</th>
                        <th style="padding:10px; text-align:right; color:var(--muted);">Lotes</th>
                        <th style="padding:10px; text-align:left; color:var(--muted);">Estrategia/Setup</th>
                    </tr>
                </thead>
                <tbody id="report-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="cuentas" class="section">
        <div class="card" style="grid-column:1/-1">
            <div class="card-header">
                <div class="card-title">Gestión de Cuentas</div>
            </div>
            <div id="accounts-container"></div>
        </div>
    </section>
    
    <section id="operaciones" class="section">
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                <div class="card-title">Análisis de Volumen por Símbolo</div>
                <div id="history-filter-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn secondary active" data-range="all">Todo</button>
                    <button class="btn secondary" data-range="1y">1A</button>
                    <button class="btn secondary" data-range="6m">6M</button>
                    <button class="btn secondary" data-range="3m">3M</button>
                    <button class="btn secondary" data-range="1m">1M</button>
                    <button class="btn secondary" data-range="15d">15D</button>
                    <button class="btn secondary" data-range="1w">1S</button>
                </div>
                </div>
    
            <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; margin-top: 20px;">
                <div style="grid-column: span 12; md:grid-column: span 4; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="symbol-volume-chart"></canvas>
                </div>
    
                <div style="grid-column: span 12; md:grid-column: span 8; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="padding: 10px; text-align: left; color: var(--muted);">Símbolo</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Beneficio Neto</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Resultado Prom.</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Volumen %</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Operaciones</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Ganancias (%)</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Pérdidas (%)</th>
                            </tr>
                        </thead>
                        <tbody id="history-summary-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
            <div class="card-header">
                <div class="card-title">Historial de Operaciones Detallado</div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <th style="padding: 10px; text-align: left; color: var(--muted);">Fecha</th>
                            <th style="padding: 10px; text-align: left; color: var(--muted);">Activo</th>
                            <th style="padding: 10px; text-align: left; color: var(--muted);">Tipo</th>
                            <th style="padding: 10px; text-align: right; color: var(--muted);">Lotaje</th>
                            <th style="padding: 10px; text-align: right; color: var(--muted);">Resultado ($)</th>
                            <th style="padding: 10px; text-align: center; color: var(--muted);">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-history-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </section>
    
    <section id="analiticas" class="section">
      <div class="card" style="grid-column: 1 / -1; margin-bottom: -10px;">
        <div class="form-group">
          <label for="analytics-strategy-filter">Filtrar por Estrategia</label>
          <select id="analytics-strategy-filter" class="form-control"></select>
        </div>
      </div>
    
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Beneficio Neto</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-total-profit">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Tasa de Acierto</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-win-rate">0%</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Profit Factor</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-profit-factor">0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">R/B Promedio</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-rr">0.00</div></div>
      </div>
    
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Beneficio Promedio</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-avg-win" style="color:var(--success)">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Pérdida Promedio</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-avg-loss" style="color:var(--danger)">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Expectativa</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-expectancy">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Drawdown Máximo</div></div>
        <div class="metric-card">
          <div class="metric-val" id="analytics-max-dd" style="color: var(--warning);">$0.00</div>
          <div class="metric-lab" id="analytics-max-dd-percent">0.00%</div>
        </div>
      </div>
      
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header"><div class="card-title">Curva de Capital</div></div>
        <div class="chart" style="height: 400px;">
          <canvas id="equityCurveChart"></canvas>
        </div>
      </div>
    </section>
    
    <section id="seguimiento" class="section">
       <div class="card" style="grid-column: span 6;">
        <div class="card-header"><div class="card-title">Metas Semanales</div></div>
        <div class="form-group">
            <label>Objetivo de Beneficio ($)</label>
            <input id="weekly-goal-input" type="number" class="form-control" placeholder="Ej: 1500">
        </div>
        <div class="form-group">
            <label>Progreso Actual</label>
            <div style="height:10px;background:#334155;border-radius:6px;overflow:hidden; margin-top: 4px;">
                <div id="weekly-progress-bar" style="height:100%;width:0%;background:var(--success); transition: width 0.5s ease;"></div>
            </div>
        </div>
    </div>       
      <div class="card" style="grid-column: span 6;">
            <div class="card-header"><div class="card-title">Checklist del Trader</div></div>
            <div class="form-group">
                <label style="display:flex; align-items:center; gap: 8px;"><input type="checkbox" id="checklist-calendar" style="width: 18px; height: 18px;"> Revisé el calendario económico</label>
                <label style="display:flex; align-items:center; gap: 8px; margin-top: 8px;"><input type="checkbox" id="checklist-plan" style="width: 18px; height: 18px;"> Seguí mi plan de trading al 100%</label>
                <label style="display:flex; align-items:center; gap: 8px; margin-top: 8px;"><input type="checkbox" id="checklist-revenge" style="width: 18px; height: 18px;"> No operé por venganza (revenge trading)</label>
            </div>
        </div>
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header"><div class="card-title">Notas de la Sesión</div></div>
            <textarea id="session-note-textarea" class="form-control" placeholder="¿Cómo te sentiste hoy? ¿Qué aprendiste?"></textarea>
            <input type="hidden" id="editing-note-id" />
            <div style="text-align: right; margin-top: 10px;">
                <button id="btn-save-note" class="btn primary">Guardar Nota</button>
            </div>
        </div>
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header"><div class="card-title">Historial de Notas</div></div>
            <div id="notes-history-container" style="color: var(--muted);">
                No hay notas guardadas.
            </div>
        </div>
    </section>
    
    <section id="estrategias" class="section">
      <div class="card" style="grid-column:1/-1">
        <div class="card-header">
            <div class="card-title">Gestión de Estrategias</div>
        </div>
        <div id="strategies-container"></div>
      </div>
    </section>

    <section id="configuracion" class="section">
        <div class="card" style="grid-column:1/-1">
            <div class="card-header">
                <div class="card-title">Configuración General</div>
            </div>
            <div class="form-group">
                <label>Saldo Inicial por Defecto ($)</label>
                <input id="settings-initial-balance" type="number" class="form-control" placeholder="10000" />
                <small style="color: var(--muted); display: block; margin-top: 4px;">Este valor se usará como punto de partida para el gráfico de Saldo en el Dashboard.</small>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn primary" id="save-general-settings-btn">Guardar Configuración</button>
            </div>
        </div>

        <div class="card" style="grid-column:1/-1; margin-top: 20px;">
            <div class="card-header">
                <div class="card-title">Mi Perfil</div>
            </div>
            <div class="form-group">
                <label>Nombre a Mostrar</label>
                <input id="profile-name-input" type="text" class="form-control" placeholder="Tu nombre y apellido" />
                <small style="color: var(--muted); display: block; margin-top: 4px;">Este es el nombre que aparecerá en la esquina superior derecha.</small>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn primary" id="save-profile-btn">Guardar Cambios</button>
            </div>
        </div>

        <div class="card" style="grid-column:1/-1; margin-top: 20px;">
            <div class="card-header">
              <div class="card-title">Conexión con MT5 (API Key)</div>
            </div>
            <p style="color: var(--muted); margin-bottom: 15px;">Usa la siguiente clave en la configuración de tu bot de MT5 para registrar operaciones automáticamente.</p>
            <div id="api-key-display" style="background: var(--secondary); padding: 12px; border-radius: 8px; font-family: monospace; margin-bottom: 15px; min-height: 45px;">
              Cargando...
            </div>
            <button id="btn-generate-api-key" class="btn primary">Generar / Mostrar Clave</button>
        </div>
    </section>
    
    <section id="admin" class="section">
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div class="card-title">Panel de Administración</div>
          <button class="btn primary" id="btn-refresh-users"><i class="fa-solid fa-rotate"></i> Actualizar Usuarios</button>
        </div>
        <div class="card" style="margin-bottom:14px">
          <div class="card-title" style="margin-bottom:8px">Usuarios</div>
          <div style="overflow:auto">
            <table style="width:100%; border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Email</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Nombre</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Rol</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Acciones</th>
                </tr>
              </thead>
              <tbody id="admin-users-tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="card" style="margin-bottom:14px">
            <div class="card-header">
                <div class="card-title">Códigos de Invitación</div>
                <button class="btn primary" id="btn-generate-invite"><i class="fa-solid fa-plus"></i> Generar Nuevo Código</button>
            </div>
            <p style="color: var(--muted); margin-bottom: 15px;">Estos son los códigos de un solo uso para registrar nuevos usuarios. Una vez que se usan, se desactivan.</p>
            <div id="invite-codes-list" style="display: flex; flex-direction: column; gap: 8px;">Cargando códigos...</div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:8px">Detalle de Usuario</div>
          <div id="admin-user-detail" style="color:var(--muted)">Selecciona un usuario…</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px">
            <div class="card">
              <div class="card-title">Cuentas</div>
              <div id="admin-user-accounts" style="color:var(--muted)">—</div>
            </div>
            <div class="card">
              <div class="card-title">Trades</div>
              <div id="admin-user-trades" style="color:var(--muted)">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <button class="fab" id="floating-add-trade-btn" aria-label="Agregar operación"><i class="fa-solid fa-plus"></i></button>

  <div id="balance-chart-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Curva de Saldo</h2>
            <button class="close-modal" data-close>&times;</button>
        </div>
        <div class="modal-body" style="height: 60vh;">
            <canvas id="modalBalanceChart"></canvas>
        </div>
    </div>
  </div>

  <div id="ai-response-modal" class="modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2><i class="fa-solid fa-brain" style="margin-right: 8px;"></i> Evaluación de Estrategia con IA</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body" id="ai-response-body" style="white-space: pre-wrap; line-height: 1.6;">
        Generando evaluación...
      </div>
    </div>
  </div>

 <div id="add-trade-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trade-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="trade-title">Agregar Operación</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Fecha de Operación</label>
                <input id="trade-date-input" type="date" class="form-control" />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;"><label>Par / Activo</label>
              <select id="trade-pair-input" class="form-control">
                <optgroup label="Pares Mayores (Majors)">
                    <option value="EURUSD">EUR/USD</option>
                    <option value="GBPUSD">GBP/USD</option>
                    <option value="USDJPY">USD/JPY</option>
                    <option value="USDCAD">USD/CAD</option>
                    <option value="AUDUSD">AUD/USD</option>
                    <option value="NZDUSD">NZD/USD</option>
                    <option value="USDCHF">USD/CHF</option>
                </optgroup>
                <optgroup label="Índices">
                    <option value="US30">US30 (Dow Jones)</option>
                    <option value="NAS100">NAS100 (Nasdaq)</option>
                    <option value="SPX500">SPX500 (S&P 500)</option>
                    <option value="GER30">GER30 (DAX)</option>
                    <option value="UK100">UK100 (FTSE 100)</option>
                </optgroup>
                <optgroup label="Criptomonedas">
                    <option value="BTCUSD">BTC/USD</option>
                    <option value="ETHUSD">ETH/USD</option>
                    <option value="XRPUSD">XRP/USD</option>
                </optgroup>
                <optgroup label="Materias Primas">
                    <option value="XAUUSD">XAU/USD (Oro)</option>
                    <option value="XAGUSD">XAG/USD (Plata)</option>
                    <option value="USOIL">USOIL (Petróleo WTI)</option>
                </optgroup>
              </select>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="trade-account-input">Cuenta Asociada</label>
                <select id="trade-account-input" class="form-control">
                    </select>
            </div>
            <div class="form-group"><label>Tipo</label>
              <select id="trade-type-input" class="form-control"><option value="buy">Compra</option><option value="sell">Venta</option></select>
            </div>
            <div class="form-group"><label>Resultado ($)</label>
              <input id="trade-result-input" type="number" class="form-control" placeholder="Ej: 250.50" step="0.01" />
            </div>

            <div class="form-group"><label>Lotaje</label>
              <input id="trade-lots-input" type="number" class="form-control" placeholder="Ej: 1.50" step="0.01" />
            </div>
            <div class="form-group"><label>Precio de Entrada</label>
              <input id="trade-entry-price-input" type="number" class="form-control" placeholder="Ej: 1.07500" step="0.00001" />
            </div>
            <div class="form-group"><label>Take Profit (Precio)</label>
              <input id="trade-tp-input" type="number" class="form-control" placeholder="Ej: 1.08500" step="0.00001" />
            </div>
            <div class="form-group"><label>Stop Loss (Precio)</label>
              <input id="trade-sl-input" type="number" class="form-control" placeholder="Ej: 1.07000" step="0.00001" />
            </div>

            <div class="form-group"><label>Riesgo (% del capital)</label>
              <input id="trade-risk-input" type="number" class="form-control" placeholder="Ej: 1.0" step="0.1" min="0.1" max="10" />
            </div>
            <div class="form-group"><label>Beneficio Esperado (%)</label>
              <input id="trade-reward-input" type="number" class="form-control" placeholder="Ej: 3.0" step="0.1" min="0.1" />
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label for="trade-strategy-input">Estrategia</label>
                <select id="trade-strategy-input" class="form-control">
                    <option value="">Ninguna</option>
                </select>
            </div>
            <div class="form-group">
                <label for="trade-session-input">Sesión de Trading</label>
                <select id="trade-session-input" class="form-control">
                    <option value="N/A">N/A</option>
                    <option value="Asia">Asia</option>
                    <option value="London">Londres</option>
                    <option value="NY">New York</option>
                </select>
            </div>
        </div>
        <div class="form-group"><label>Pertenece al Challenge</label>
          <select id="trade-challenge-input" class="form-control"><option value="yes">Sí</option><option value="no">No</option></select>
        </div>
        <input type="hidden" id="editing-trade-id" />
      </div>
      <div class="modal-footer">
        <button class="btn secondary" data-close>Cancelar</button>
        <button class="btn primary" id="save-trade-btn">Guardar Operación</button>
      </div>
    </div>
</div>
  <div id="add-account-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="acc-title">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="acc-title">Agregar Nueva Cuenta</h2>
          <button class="close-modal" data-close>&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group"><label>Nombre</label><input id="account-name" class="form-control" placeholder="Ej: Cuenta Principal" /></div>
          <div class="form-group"><label>Broker</label><input id="account-broker" class="form-control" placeholder="Ej: FTMO, Pepperstone" /></div>
          <div class="form-group"><label>Saldo ($)</label><input id="account-balance" type="number" class="form-control" placeholder="Ej: 10000.00" step="0.01" /></div>
          <div class="form-group"><label>Tipo</label>
            <select id="account-type" class="form-control"><option value="principal">Principal</option><option value="challenge">Challenge</option><option value="personal">Personal</option></select>
          </div>
          <input type="hidden" id="editing-account-id" />
        </div>
        <div class="modal-footer">
          <button class="btn secondary" data-close>Cancelar</button>
          <button class="btn primary" id="save-account-btn">Guardar Cuenta</button>
        </div>
      </div>
  </div>
  <div id="add-strategy-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="strategy-title">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="strategy-title">Agregar Nueva Estrategia</h2>
          <button class="close-modal" data-close>&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Nombre de la Estrategia</label>
            <input id="strategy-name" class="form-control" placeholder="Ej: Ruptura de Resistencia" />
          </div>
          <div class="form-group">
            <label>Descripción (Opcional)</label>
            <textarea id="strategy-desc" class="form-control" placeholder="Añade notas sobre las confirmaciones, reglas, etc."></textarea>
          </div>
          <input type="hidden" id="editing-strategy-id" />
        </div>
        <div class="modal-footer">
          <button class="btn secondary" data-close>Cancelar</button>
          <button class="btn primary" id="save-strategy-btn">Guardar Estrategia</button>
        </div>
      </div>
  </div>
  <div id="challenge-settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="challenge-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="challenge-title">Configurar Challenge</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Saldo Inicial ($)</label>
          <input id="challenge-balance" type="number" class="form-control" placeholder="100000" />
        </div>
        <div class="form-group">
          <label>Objetivo de Beneficio (%)</label>
          <input id="challenge-target" type="number" class="form-control" placeholder="10" />
        </div>
        <div class="form-group">
          <label>Límite de Pérdida Máxima (%)</label>
          <input id="challenge-max-loss" type="number" class="form-control" placeholder="10" />
        </div>
        <div class="form-group">
          <label>Límite de Pérdida Diaria (%)</label>
          <input id="challenge-daily-loss" type="number" class="form-control" placeholder="5" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" data-close>Cancelar</button>
        <button class="btn primary" id="save-challenge-settings-btn">Guardar Ajustes</button>
      </div>
    </div>
  </div>
  <div id="auth-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="auth-title">Acceso</h2>
            <button class="close-modal" data-close>&times;</button>
        </div>
        <form id="auth-form">
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input id="auth-email" type="email" class="form-control" placeholder="tu@correo.com" required />
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <div style="position: relative; display: flex; align-items: center;">
                        <input id="auth-pass" type="password" class="form-control" placeholder="••••••••" required />
                        <button type="button" id="toggle-password" style="position: absolute; right: 10px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px;">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group hidden" id="auth-name-wrap">
                    <label>Nombre</label>
                    <input id="auth-name" class="form-control" placeholder="Tu nombre" />
                </div>
                <div class="form-group hidden" id="auth-invite-wrap">
                    <label>Código de Invitación</label>
                    <input id="auth-invite" class="form-control" placeholder="Código secreto" />
                </div>
                <div id="auth-error" class="hidden" style="margin-top:8px;color:var(--danger)"></div>
            </div>
            <div class="modal-footer" style="justify-content:space-between">
                <div>
                    <button type="button" class="btn-link" id="forgot-password-btn">¿Olvidaste tu contraseña?</button>
                </div>
                <div>
                    <button type="button" class="btn secondary" data-close>Cancelar</button>
                    <button class="btn primary" type="submit" id="auth-submit">Entrar</button>
                </div>
            </div>
        </form>
        <div style="text-align: center; margin-top: 15px;">
            <button type="button" class="btn-link" id="auth-toggle-mode">Crear cuenta</button>
        </div>
    </div>
</div>

<script>
// Bloque de script para inicialización y DOM (sin lógica de datos)
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

let distributionChart, balanceChart, riskChart, modalBalanceChart, equityCurveChart, symbolVolumeChart;
let currentReportData = [];

function setDate() {
    const el = $('#current-date');
    if (el) el.textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
}

function initCharts() {
    const d = $('#distributionChart'); if (d) distributionChart = new Chart(d.getContext('2d'), { type: 'bar', data: { labels: ['Win', 'Loss', 'BE'], datasets: [{ label: 'Operaciones', data: [0, 0, 0], backgroundColor: ['rgba(16,185,129,.7)', 'rgba(239,68,68,.7)', 'rgba(156,163,175,.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    const b = $('#balanceChart'); if (b) balanceChart = new Chart(b.getContext('2d'), { type: 'line', data: { datasets: [{ label: 'Saldo', data: [], borderColor: 'rgba(212,175,55,1)', backgroundColor: 'rgba(212,175,55,.15)', fill: true, tension: .3 }] }, options: { responsive: true, maintainAspectRatio: false } });
    const r = $('#riskChart'); if (r) riskChart = new Chart(r.getContext('2d'), { type: 'radar', data: { labels: ['Gestión', 'Consistencia', 'Acierto', 'R/B', 'DD', 'Beneficio'], datasets: [{ label: 'Perfil de Riesgo', data: [0, 0, 0, 0, 0, 0], backgroundColor: 'rgba(212,175,55,.2)', borderColor: 'rgba(212,175,55,1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 5, stepSize: 1 } } } });
    const mB = $('#modalBalanceChart'); if (mB) modalBalanceChart = new Chart(mB.getContext('2d'), { type: 'line', data: { datasets: [{ label: 'Saldo', data: [], borderColor: 'rgba(212,175,55,1)', backgroundColor: 'rgba(212,175,55,.15)', fill: true, tension: .3 }] }, options: { responsive: true, maintainAspectRatio: false } });
}

function setActiveSection(id) {
    $$('main > .section').forEach(section => section.classList.remove('active'));
    const targetSection = $(`#${id}`);
    if (targetSection) targetSection.classList.add('active');

    $$('.nav > a.nav-item, .submenu > a').forEach(link => {
        const isActive = link.dataset.target === id;
        link.classList.toggle('active', isActive);
        if (isActive) {
            const parentSubmenu = link.closest('.submenu');
            if (parentSubmenu) {
                const button = $(`[aria-controls="${parentSubmenu.id}"]`);
                if (button) button.setAttribute('aria-expanded', 'true');
                parentSubmenu.classList.add('open');
            }
        }
    });

    if (id === 'calendario' && window.calendar) {
        setTimeout(() => { window.calendar.updateSize() }, 50);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    setDate();
    initCharts();
});
</script>
  
<script type="module">
// ----- SCRIPT PRINCIPAL CON TODA LA LÓGICA DE LA APLICACIÓN -----

import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  signOut, updateProfile,
  sendPasswordResetEmail, createUserWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, updateDoc, deleteDoc, where
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

const firebaseConfig = {
    apiKey: "AIzaSyCuS-0g97JluGH6FTF5JBmwaW7d5aJ3WWw",
    authDomain: "journal-infiniti-kapital.firebaseapp.com",
    projectId: "journal-infiniti-kapital",
    storageBucket: "journal-infiniti-kapital.firebasestorage.app",
    messagingSenderId: "78211615687",
    appId: "1:78211615687:web:02b05ba83acd46c8c6e7e2",
    measurementId: "G-D0ERFPMLGQ"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const functions = getFunctions(app);

window.auth = auth;
window.db = db;

// --- INICIO DE FUNCIONES DE CÁLCULO Y RENDERIZADO ---

function updateRecentTrades(trades) {
    const el = $('#recent-trades-container');
    if (!el) return;
    if (!trades || !trades.length) {
        el.innerHTML = '<div style="padding: 4px 0;">Sin registros.</div>';
        return;
    }
    el.innerHTML = trades.slice(-5).reverse().map(t => {
        const sign = (t.result || 0) >= 0 ? '+' : '-';
        const col = (t.result || 0) >= 0 ? 'var(--success)' : 'var(--danger)';
        const sessionInfo = t.session && t.session !== 'N/A' ? `<span style="color: var(--muted); font-size: 12px;">(${t.session})</span>` : '';
        return `<div style="padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${t.pair} ${sessionInfo}</span>
                        <b style="color:${col}">${sign}$${Math.abs(t.result || 0).toFixed(2)}</b>
                    </div>
                    <div style="font-size: 12px; color: var(--muted); margin-top: 2px;">${t.dateStr || ''}</div>
                </div>`;
    }).join('');
}

function populateReportAccountsDropdown(accounts) {
    const reportSelect = $('#report-account-select');
    if (!reportSelect) return;
    
    const currentVal = reportSelect.value;
    reportSelect.innerHTML = '<option value="">-- Selecciona una cuenta --</option>';
    
    (accounts || []).forEach(a => {
        const option = document.createElement('option');
        option.value = a.id;
        option.textContent = a.name;
        reportSelect.appendChild(option);
    });
    
    if (currentVal) reportSelect.value = currentVal;
}

function updateAccountsUI(accounts) {
    const el = $('#accounts-container');
    if (!el) return;

    el.innerHTML = '';

    const addAccountButton = document.createElement('div');
    addAccountButton.className = 'btn primary';
    addAccountButton.style = "display:inline-flex; align-items:center; gap:8px; margin-bottom: 20px; cursor: pointer;";
    addAccountButton.innerHTML = `<i class="fa-solid fa-plus"></i> Agregar Cuenta`;
    addAccountButton.onclick = () => {
        $('#acc-title').textContent = 'Agregar Nueva Cuenta';
        $('#account-name').value = '';
        $('#account-broker').value = '';
        $('#account-balance').value = '';
        $('#account-type').value = 'principal';
        $('#editing-account-id').value = '';
        openModalById('add-account-modal');
    };
    el.appendChild(addAccountButton);
    
    if (!accounts || accounts.length === 0) {
        const noAccountsMessage = document.createElement('p');
        noAccountsMessage.textContent = 'Aún no tienes cuentas. ¡Agrega una para empezar!';
        noAccountsMessage.style.color = 'var(--muted)';
        el.appendChild(noAccountsMessage);
        return;
    }

    const trades = window.__currentTrades || [];
    accounts.forEach(a => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginTop = '10px';

        // --- Lógica de cálculo (mejorada) ---
        const initialBalance = parseFloat(a.balance) || 0;
        const accountTrades = trades.filter(t => t.accountId === a.id);
        const profit = accountTrades.reduce((sum, t) => sum + t.result, 0);
        const dynamicBalance = initialBalance + profit;

        // Calcula el porcentaje de ganancia/pérdida
        const profitPercent = initialBalance > 0 ? (profit / initialBalance) * 100 : 0;
        const profitColor = profit >= 0 ? 'var(--success)' : 'var(--danger)';
        const formattedInitialBalance = initialBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        card.innerHTML = `
          <div class="card-header">
            <div class="card-title">${a.name || 'Cuenta sin nombre'}</div>
            <div>
              <button class="btn-icon btn-edit-account" data-id="${a.id}" title="Editar Cuenta"><i class="fa-solid fa-pen"></i></button>
              <button class="btn-icon btn-delete-account" data-id="${a.id}" title="Eliminar Cuenta"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="metric-card">
            <div style="display: flex; justify-content: center; align-items: baseline; gap: 8px;">
                <div class="metric-val">$${dynamicBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <div style="font-weight: 700; color: ${profitColor};">
                    (${(profit >= 0 ? '+' : '')}${profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})})
                </div>
            </div>
            <div class="metric-lab">${a.broker || 'Sin broker'} - (${a.type || 'N/A'})</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                Inicial: $${formattedInitialBalance}
            </div>
          </div>
        `;
        el.appendChild(card);
    });
}

function calculateDrawdown(trades, initialBalance) {
    let peakEquity = initialBalance;
    let maxDrawdownValue = 0;

    let currentEquity = initialBalance;
    (trades || []).forEach(trade => {
        currentEquity += trade.result;
        if (currentEquity > peakEquity) {
            peakEquity = currentEquity;
        }
        const drawdown = peakEquity - currentEquity;
        if (drawdown > maxDrawdownValue) {
            maxDrawdownValue = drawdown;
        }
    });

    const maxDrawdownPercent = peakEquity > 0 ? (maxDrawdownValue / peakEquity) * 100 : 0;
    return { maxDrawdownValue, maxDrawdownPercent };
}


function renderAnalytics(trades) {
    const t = trades || [];
    const wins = t.filter(x => x.result > 0);
    const losses = t.filter(x => x.result < 0);
    const total = t.length;

    const totalWinsValue = wins.reduce((s, x) => s + x.result, 0);
    const totalLossValue = losses.reduce((s, x) => s + x.result, 0);

    const totalProfit = totalWinsValue + totalLossValue;
    const winRate = total ? (wins.length / total) : 0;
    const profitFactor = Math.abs(totalLossValue) ? totalWinsValue / Math.abs(totalLossValue) : 0;
    const avgRR = (wins.length && losses.length) ? (totalWinsValue / wins.length) / (Math.abs(totalLossValue) / losses.length) : 0;

    const avgWin = wins.length > 0 ? totalWinsValue / wins.length : 0;
    const avgLoss = losses.length > 0 ? totalLossValue / losses.length : 0;

    const lossRate = total > 0 ? losses.length / total : 0;
    const expectancy = (winRate * avgWin) - (lossRate * Math.abs(avgLoss));

    $('#analytics-total-profit').textContent = `$${totalProfit.toFixed(2)}`;
    $('#analytics-win-rate').textContent = `${(winRate * 100).toFixed(1)}%`;
    $('#analytics-profit-factor').textContent = profitFactor.toFixed(2);
    $('#analytics-rr').textContent = avgRR.toFixed(2);

    $('#analytics-avg-win').textContent = `$${avgWin.toFixed(2)}`;
    $('#analytics-avg-loss').textContent = `-$${Math.abs(avgLoss).toFixed(2)}`;

    const expectancyEl = $('#analytics-expectancy');
    if (expectancyEl) {
        expectancyEl.textContent = `$${expectancy.toFixed(2)}`;
        expectancyEl.style.color = expectancy >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    const initialBalance = window.__currentGeneralSettings?.initialBalance || 10000;
    const drawdown = calculateDrawdown(t, initialBalance);
    $('#analytics-max-dd').textContent = `-$${drawdown.maxDrawdownValue.toFixed(2)}`;
    $('#analytics-max-dd-percent').textContent = `${drawdown.maxDrawdownPercent.toFixed(2)}% del Pico`;

    renderEquityCurve(t);
}

 function renderEquityCurve(trades) {
    const ctx = document.getElementById('equityCurveChart')?.getContext('2d');
    if (!ctx) return;
    let cumulativeProfit = 0;
    const equityData = trades.map(trade => {
        cumulativeProfit += trade.result;
        return cumulativeProfit;
    });
    const labels = Array.from({ length: trades.length }, (_, i) => i + 1);
    if (equityCurveChart) {
        equityCurveChart.destroy();
    }
    equityCurveChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Inicio', ...labels],
            datasets: [{
                label: 'Beneficio Acumulado ($)',
                data: [0, ...equityData],
                borderColor: 'rgba(212, 175, 55, 1)',
                backgroundColor: 'rgba(212, 175, 55, 0.15)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false } }
        }
    });
}

function renderCalendar(trades) {
    const calendarEl = document.getElementById('calendar-container');
    if (!calendarEl) return;

    const dailySummary = {};
    (trades || []).forEach(trade => {
        const date = trade.dateStr;
        if (!dailySummary[date]) {
            dailySummary[date] = { profit: 0, count: 0 };
        }
        dailySummary[date].profit += trade.result;
        dailySummary[date].count++;
    });

    if (window.calendar) {
        window.calendar.destroy();
    }

    window.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
        dayCellDidMount: function(arg) {
            const dateStr = arg.date.toISOString().slice(0, 10);
            const dayData = dailySummary[dateStr];
            const frame = arg.el.querySelector('.fc-daygrid-day-frame');
            
            let contentHtml = '';
            if (dayData) {
                const isWin = dayData.profit >= 0;
                const pnlColor = isWin ? 'var(--success)' : 'var(--danger)';
                arg.el.style.backgroundColor = isWin ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';

                contentHtml = `
                    <div class="calendar-day-content">
                        <div class="calendar-day-pnl" style="color: ${pnlColor};">${isWin ? '+' : ''}$${dayData.profit.toFixed(2)}</div>
                        <div class="calendar-day-trades">${dayData.count} ${dayData.count === 1 ? 'trade' : 'trades'}</div>
                    </div>
                `;
            } else if (!arg.isOther) {
                arg.el.style.backgroundColor = 'rgba(255, 255, 255, 0.02)';
                 contentHtml = `
                    <div class="calendar-day-content">
                        <div class="calendar-day-trades">No Trades</div>
                    </div>
                `;
            }
            
            if(frame && contentHtml) {
                 frame.innerHTML = contentHtml + frame.innerHTML;
            }
        }
    });
    window.calendar.render();
}


function renderStrategiesUI(strategies) {
    const el = $('#strategies-container');
    if (!el) return;
    el.innerHTML = '';
    const addStrategyButton = document.createElement('div');
    addStrategyButton.className = 'btn primary';
    addStrategyButton.style = "display:inline-flex; align-items:center; gap:8px; margin-bottom: 20px; cursor: pointer;";
    addStrategyButton.innerHTML = `<i class="fa-solid fa-plus"></i> Agregar Estrategia`;
    addStrategyButton.onclick = () => {
        $('#strategy-title').textContent = 'Agregar Nueva Estrategia';
        $('#strategy-name').value = '';
        $('#strategy-desc').value = '';
        $('#editing-strategy-id').value = '';
        openModalById('add-strategy-modal');
    };
    el.appendChild(addStrategyButton);
    if (!strategies || strategies.length === 0) {
        const noStrategiesMessage = document.createElement('p');
        noStrategiesMessage.textContent = 'No has definido ninguna estrategia.';
        noStrategiesMessage.style.color = 'var(--muted)';
        el.appendChild(noStrategiesMessage);
        return;
    }
    strategies.forEach(s => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginTop = '10px';
        card.innerHTML = `
      <div class="card-header">
        <div class="card-title">${s.name || 'Estrategia sin nombre'}</div>
        <div>
          <button class="btn-icon btn-evaluate-ai" data-id="${s.id}" title="Evaluar con IA"><i class="fa-solid fa-brain"></i></button>
          <button class="btn-icon btn-edit-strategy" data-id="${s.id}" title="Editar Estrategia"><i class="fa-solid fa-pen"></i></button>
          <button class="btn-icon btn-delete-strategy" data-id="${s.id}" title="Eliminar Estrategia"><i class="fa-solid fa-trash"></i></button>
        </div>
      </div>
      <p style="color: var(--muted); white-space: pre-wrap;">${s.desc || 'Sin descripción.'}</p>
    `;
        el.appendChild(card);
    });
}

function updateStrategiesDropdown(strategies) {
    const select = $('#trade-strategy-input');
    if (!select) return;
    const currentVal = select.value;
    select.innerHTML = '<option value="">Ninguna</option>';
    (strategies || []).forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        select.appendChild(option);
    });
    select.value = currentVal;
}

function populateAnalyticsFilter(strategies) {
    const select = $('#analytics-strategy-filter');
    if (!select) return;
    select.innerHTML = '<option value="">Todas las Estrategias</option>';
    (strategies || []).forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        select.appendChild(option);
    });
}

  function updateChallengeTrackerUI(trades, settings) {
    const accounts = window.__currentAccounts || [];

    // --- LÓGICA MEJORADA Y MÁS ESTRICTA ---
    // 1. Busca explícitamente la cuenta designada como 'challenge'.
    const challengeAccount = accounts.find(acc => acc.type && acc.type.toLowerCase() === 'challenge');

    // 2. Si NO se encuentra NINGUNA cuenta de tipo 'challenge', reinicia la tarjeta y detiene la función.
    //    Esto evita que se muestren datos incorrectos o de otra cuenta.
    if (!challengeAccount) {
        $('#challenge-current-balance').textContent = '$0.00';
        $('#challenge-profit').textContent = `+0.0%`;
        $('#challenge-drawdown').textContent = `0.0%`;
        $('#challenge-trades').textContent = '0';
        $('#challenge-win-rate').textContent = `0%`;
        $('#challenge-progress-value').textContent = `0%`;
        $('#challenge-progress-bar').style.width = `0%`;
        $('#challenge-residual-risk').textContent = `0.00%`;
        return;
    }

    // --- El resto de la función ahora tiene la garantía de tener la cuenta correcta ---
    const initialBalance = parseFloat(challengeAccount.balance) || 0;
    const challengeTrades = (trades || []).filter(t => t.accountId === challengeAccount.id);
    const totalProfit = challengeTrades.reduce((sum, trade) => sum + trade.result, 0);
    const currentBalance = initialBalance + totalProfit;

    const profitPercent = initialBalance > 0 ? (totalProfit / initialBalance) * 100 : 0;
    const targetPercent = parseFloat(settings.profitTarget) || 10;
    const progressPercent = targetPercent > 0 ? (profitPercent / targetPercent) * 100 : 0;
    
    const { maxDrawdownValue } = calculateDrawdown(challengeTrades, initialBalance);
    const drawdownPercent = initialBalance > 0 ? (maxDrawdownValue / initialBalance) * 100 : 0;
    
    const wins = challengeTrades.filter(t => t.result > 0).length;
    const winRate = challengeTrades.length > 0 ? (wins / challengeTrades.length) * 100 : 0;

    // Actualizar la interfaz
    $('#challenge-current-balance').textContent = `$${currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    $('#challenge-profit').textContent = `${profitPercent.toFixed(2)}%`;
    $('#challenge-drawdown').textContent = `${drawdownPercent.toFixed(2)}%`;
    $('#challenge-trades').textContent = challengeTrades.length;
    $('#challenge-win-rate').textContent = `${winRate.toFixed(1)}%`;
    $('#challenge-progress-value').textContent = `${progressPercent.toFixed(1)}%`;
    $('#challenge-progress-bar').style.width = `${Math.min(100, Math.max(0, progressPercent))}%`;
    
    const dailyLimit = settings.dailyLoss || 5;
    const todayStr = new Date().toISOString().slice(0, 10);
    const todaysTrades = challengeTrades.filter(t => t.dateStr === todayStr);
    const dailyPnl = todaysTrades.reduce((sum, trade) => sum + trade.result, 0);
    const dailyDrawdown = dailyPnl < 0 ? (Math.abs(dailyPnl) / initialBalance) * 100 : 0;
    const residualRisk = dailyLimit - dailyDrawdown;
    $('#challenge-residual-risk').textContent = `${residualRisk.toFixed(2)}%`;
}

function calculateRiskMetrics(trades, initialBalance) {
    const totalProfitForPeriod = trades.reduce((sum, t) => sum + (t.result || 0), 0);
    const periodProfitPercent = initialBalance > 0 ? (totalProfitForPeriod / initialBalance) * 100 : 0;

    const riskProfitEl = $('#risk-profit-percent');
    if (riskProfitEl) {
        riskProfitEl.textContent = `${periodProfitPercent.toFixed(2)}%`;
        riskProfitEl.style.color = periodProfitPercent >= 0 ? 'var(--success)' : 'var(--danger)';
    }
    
    if (!initialBalance || initialBalance === 0) {
        $('#daily-risk').textContent = '0.0%';
        $('#weekly-risk').textContent = '0.0%';
        $('#monthly-risk').textContent = '0.0%';
        if (riskProfitEl) {
            riskProfitEl.textContent = '0.00%';
            riskProfitEl.style.color = 'var(--accent)';
        }
        if (riskChart) {
            riskChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
            riskChart.update();
        }
        return;
    }

    const now = new Date();
    const today = now.toISOString().slice(0, 10);
    const startOfWeek = new Date(new Date(now).setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))).toISOString().slice(0, 10);
    const startOfMonth = new Date(new Date(now).getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);

    const dailyLoss = trades.filter(t => t.dateStr === today && t.result < 0).reduce((sum, t) => sum + t.result, 0);
    const weeklyLoss = trades.filter(t => t.dateStr >= startOfWeek && t.result < 0).reduce((sum, t) => sum + t.result, 0);
    const monthlyLoss = trades.filter(t => t.dateStr >= startOfMonth && t.result < 0).reduce((sum, t) => sum + t.result, 0);

    $('#daily-risk').textContent = `${(Math.abs(dailyLoss) / initialBalance * 100).toFixed(1)}%`;
    $('#weekly-risk').textContent = `${(Math.abs(weeklyLoss) / initialBalance * 100).toFixed(1)}%`;
    $('#monthly-risk').textContent = `${(Math.abs(monthlyLoss) / initialBalance * 100).toFixed(1)}%`;

    const wins = trades.filter(x => x.result > 0);
    const losses = trades.filter(x => x.result < 0);
    const winRate = trades.length ? (wins.length / trades.length) * 100 : 0;
    const totalWins = wins.reduce((s, x) => s + x.result, 0);
    const totalLoss = Math.abs(losses.reduce((s, x) => s + x.result, 0));
    const avgRR = (wins.length && losses.length) ? (totalWins / wins.length) / (totalLoss / losses.length) : 0;

    const aciertoScore = Math.min(5, winRate / 15);
    const rrScore = Math.min(5, avgRR * 2);
    const beneficioScore = Math.min(5, (totalProfitForPeriod / initialBalance * 100) / 4);

    if (riskChart) {
        riskChart.data.datasets[0].data = [3, 4, aciertoScore, rrScore, 3, beneficioScore];
        riskChart.update();
    }
}
  
function calculateStreaks(trades) {
    let maxWinningStreak = 0;
    let currentWinningStreak = 0;
    let maxLosingStreak = 0;
    let currentLosingStreak = 0;

    (trades || []).forEach(trade => {
        if (trade.result > 0) {
            currentWinningStreak++;
            currentLosingStreak = 0;
        } else if (trade.result < 0) {
            currentLosingStreak++;
            currentWinningStreak = 0;
        }
        if (currentWinningStreak > maxWinningStreak) {
            maxWinningStreak = currentWinningStreak;
        }
        if (currentLosingStreak > maxLosingStreak) {
            maxLosingStreak = currentLosingStreak;
        }
    });
    return { maxWinningStreak, maxLosingStreak };
}

function recalcFromTrades(trades) {
    const getSafeTimestamp = (trade) => {
        if (!trade || !trade.createdAt) return 0;
        if (typeof trade.createdAt.toMillis === 'function') {
            return trade.createdAt.toMillis();
        }
        if (trade.createdAt instanceof Date) {
            return trade.createdAt.getTime();
        }
        if (typeof trade.createdAt === 'number') {
            return trade.createdAt;
        }
        return 0;
    };

    const t = (trades || []).sort((a, b) => getSafeTimestamp(a) - getSafeTimestamp(b));

    const wins = t.filter(x => x.result > 0), losses = t.filter(x => x.result < 0);
    const total = t.length;
    const totalWins = wins.reduce((s, x) => s + x.result, 0);
    const totalLoss = Math.abs(losses.reduce((s, x) => s + x.result, 0));
    const winRate = total ? (wins.length / total) * 100 : 0;
    const pf = totalLoss ? totalWins / totalLoss : 0;
    const rr = (wins.length && losses.length) ? (totalWins / wins.length) / (totalLoss / losses.length) : 0;

    $('#total-trades').textContent = total;
    $('#total-trades-2').textContent = total;
    $('#win-trades').textContent = wins.length;
    $('#win-rate').textContent = `${winRate.toFixed(1)}%`;
    $('#profit-factor').textContent = pf.toFixed(2);
    $('#risk-reward').textContent = rr.toFixed(2);
    const totalProfit = totalWins - totalLoss;
    $('#total-profit').textContent = `$${totalProfit.toFixed(2)}`;

    const settings = window.__currentGeneralSettings || { initialBalance: 10000 };
    const initialBalance = settings.initialBalance;
    const profitPercent = initialBalance > 0 ? (totalProfit / initialBalance) * 100 : 0;

    const profitPercentEl = $('#total-profit-percent');
    if (profitPercentEl) {
        profitPercentEl.textContent = `(${profitPercent.toFixed(1)}%)`;
        profitPercentEl.style.color = profitPercent >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    const balanceGrowthEl = $('#balance-growth-percent');
    if (balanceGrowthEl) {
        balanceGrowthEl.textContent = `${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%`;
        balanceGrowthEl.style.color = profitPercent >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    if (distributionChart) {
        distributionChart.data.datasets[0].data = [wins.length, losses.length, t.filter(x => x.result === 0).length];
        distributionChart.update();
    }
  
    if (balanceChart || modalBalanceChart) {
        const data = [];
        let bal = settings.initialBalance;
        data.push(bal);
        t.forEach(trade => {
            bal += trade.result || 0;
            data.push(bal);
        });
        const labels = ['Inicio', ...Array.from({ length: t.length }, (_, i) => i + 1)];
        if (balanceChart) {
            balanceChart.data.datasets[0].data = data;
            balanceChart.data.labels = labels;
            balanceChart.update();
        }
        if (modalBalanceChart) {
            modalBalanceChart.data.datasets[0].data = data;
            modalBalanceChart.data.labels = labels;
            modalBalanceChart.update();
        }
    }
    updateRecentTrades(t);
    calculateRiskMetrics(t, settings.initialBalance);

    const streaks = calculateStreaks(t);
    $('#max-win-streak').textContent = streaks.maxWinningStreak;
    $('#max-loss-streak').textContent = streaks.maxLosingStreak;
}

function renderHistorySummary(trades) {
    if (!trades) return;
    const summary = {};

    trades.forEach(trade => {
        const symbol = trade.pair;
        if (!summary[symbol]) {
            summary[symbol] = {
                netProfit: 0,
                tradeCount: 0,
                winCount: 0,
            };
        }
        summary[symbol].netProfit += trade.result;
        summary[symbol].tradeCount++;
        if (trade.result > 0) {
            summary[symbol].winCount++;
        }
    });

    const totalTrades = trades.length;
    const tbody = document.getElementById('history-summary-tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const chartLabels = [];
    const chartData = [];
    const chartColors = ['#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'];

    let totalNetProfit = 0;
    let totalWins = 0;

    Object.keys(summary).sort().forEach(symbol => {
        const data = summary[symbol];
        totalNetProfit += data.netProfit;
        totalWins += data.winCount;

        const lossCount = data.tradeCount - data.winCount;
        const winRate = data.tradeCount > 0 ? (data.winCount / data.tradeCount) * 100 : 0;
        const lossRate = data.tradeCount > 0 ? (lossCount / data.tradeCount) * 100 : 0;
        const avgResult = data.tradeCount > 0 ? data.netProfit / data.tradeCount : 0;
        const volumePercent = totalTrades > 0 ? (data.tradeCount / totalTrades) * 100 : 0;

        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border)';
        row.innerHTML = `
            <td style="padding: 12px; font-weight: bold;">${symbol}</td>
            <td style="padding: 12px; text-align: right; color: ${data.netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">$${data.netProfit.toFixed(2)}</td>
            <td style="padding: 12px; text-align: right;">$${avgResult.toFixed(2)}</td>
            <td style="padding: 12px; text-align: right;">${volumePercent.toFixed(2)}%</td>
            <td style="padding: 12px; text-align: right;">${data.tradeCount}</td>
            <td style="padding: 12px; text-align: right; color: var(--success);">${winRate.toFixed(2)}%</td>
            <td style="padding: 12px; text-align: right; color: var(--danger);">${lossRate.toFixed(2)}%</td>
        `;
        tbody.appendChild(row);

        chartLabels.push(symbol);
        chartData.push(data.tradeCount);
    });

    const totalLosses = totalTrades - totalWins;
    const totalWinRate = totalTrades > 0 ? (totalWins / totalTrades) * 100 : 0;
    const totalLossRate = totalTrades > 0 ? (totalLosses / totalTrades) * 100 : 0;
    const totalAvgResult = totalTrades > 0 ? totalNetProfit / totalTrades : 0;

    const footerRow = document.createElement('tr');
    footerRow.style.fontWeight = 'bold';
    footerRow.innerHTML = `
        <td style="padding: 12px;">Todos los símbolos</td>
        <td style="padding: 12px; text-align: right; color: ${totalNetProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">$${totalNetProfit.toFixed(2)}</td>
        <td style="padding: 12px; text-align: right;">$${totalAvgResult.toFixed(2)}</td>
        <td style="padding: 12px; text-align: right;">100.00%</td>
        <td style="padding: 12px; text-align: right;">${totalTrades}</td>
        <td style="padding: 12px; text-align: right; color: var(--success);">${totalWinRate.toFixed(2)}%</td>
        <td style="padding: 12px; text-align: right; color: var(--danger);">${totalLossRate.toFixed(2)}%</td>
    `;
    tbody.appendChild(footerRow);

    const ctx = document.getElementById('symbol-volume-chart')?.getContext('2d');
    if (!ctx) return;
    if (symbolVolumeChart) {
        symbolVolumeChart.destroy();
    }
    symbolVolumeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Operaciones por Símbolo',
                data: chartData,
                backgroundColor: chartColors,
                borderColor: 'var(--secondary)',
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { color: 'var(--text)' }
                }
            }
        }
    });
}

function renderDetailedHistory(trades) {
    const tbody = $('#detailed-history-tbody');
    if (!tbody) return;

    if (!trades || trades.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="padding: 12px; text-align: center; color: var(--muted);">No hay operaciones registradas.</td></tr>`;
        return;
    }

    const sortedTrades = [...trades].sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

    tbody.innerHTML = sortedTrades.map(trade => {
        const resultColor = trade.result >= 0 ? 'var(--success)' : 'var(--danger)';
        const typeText = trade.type === 'buy' ? 'Compra' : 'Venta';
        const typeColor = trade.type === 'buy' ? 'var(--success)' : 'var(--danger)';
        
        return `
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px;">${trade.dateStr || 'N/A'}</td>
                <td style="padding: 12px; font-weight: bold;">${trade.pair || 'N/A'}</td>
                <td style="padding: 12px; color: ${typeColor};">${typeText}</td>
                <td style="padding: 12px; text-align: right;">${trade.lots || '---'}</td>
                <td style="padding: 12px; text-align: right; color: ${resultColor}; font-weight: bold;">$${(trade.result || 0).toFixed(2)}</td>
                <td style="padding: 12px; text-align: center; display: flex; gap: 8px; justify-content: center;">
                    <button class="btn-icon btn-edit-trade" data-id="${trade.id}" title="Editar Operación"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon btn-delete-trade" data-id="${trade.id}" title="Eliminar Operación"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateWeeklyProgress() {
    const goal = parseFloat($('#weekly-goal-input').value) || 0;
    const progressBar = $('#weekly-progress-bar');
    if (!progressBar) return;

    if (goal <= 0) {
        progressBar.style.width = '0%';
        return;
    }

    const trades = window.__currentTrades || [];
    
    const today = new Date();
    const dayOfWeek = today.getDay(); 
    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
    const startOfWeek = new Date(new Date(today).setDate(diff)).toISOString().slice(0, 10);

    const netWeeklyProfit = trades
        .filter(t => t.dateStr >= startOfWeek)
        .reduce((sum, t) => sum + t.result, 0);

    const progress = Math.min(100, (Math.max(0, netWeeklyProfit) / goal) * 100);
    
    progressBar.style.width = `${progress}%`;
}
// --- FIN DE FUNCIONES DE CÁLCULO Y RENDERIZADO ---

let authMode = 'login';
function setAuthMode(mode){
  authMode = mode;
  $('#auth-title').textContent = mode==='login' ? 'Iniciar Sesión' : 'Crear Cuenta';
  $('#auth-toggle-mode').textContent = mode==='login' ? 'Crear cuenta' : 'Ya tengo cuenta';
  $('#auth-name-wrap').classList.toggle('hidden', mode !== 'register');
  $('#auth-invite-wrap').classList.toggle('hidden', mode !== 'register');
  $('#auth-submit').textContent = mode ==='login' ? 'Entrar' : 'Registrar';
  $('#forgot-password-btn').classList.toggle('hidden', mode !== 'login');
  $('#auth-error').classList.add('hidden');
}

let unsubscribes = [];
function cleanupListeners() {
    unsubscribes.forEach(unsub => unsub && unsub());
    unsubscribes = [];
}

function bindSelfRealtime(uid){
  cleanupListeners();

  const tradesRef = collection(db, 'users', uid, 'trades');
  const unsubTrades = onSnapshot(query(tradesRef, orderBy('createdAt','asc')), snap=>{
    window.__currentTrades = snap.docs.map(d=>({id:d.id,...d.data()}));
    (window.updateAllCalculations || (()=>{}))();
  });

  const settingsRef = doc(db, 'users', uid, 'settings', 'challenge');
  const unsubSettings = onSnapshot(settingsRef, snap => {
    window.__currentSettings = snap.data() || {};
    (window.updateAllCalculations || (()=>{}))();
  });

  const generalSettingsRef = doc(db, 'users', uid, 'settings', 'general');
  const unsubGeneralSettings = onSnapshot(generalSettingsRef, snap => {
    const settings = snap.data() || { initialBalance: 10000, weeklyGoal: '' };
    window.__currentGeneralSettings = settings;
    $('#settings-initial-balance').value = settings.initialBalance;
    $('#weekly-goal-input').value = settings.weeklyGoal || '';
    (window.updateAllCalculations || (()=>{}))();
  });      

  const accountsRef = collection(db, 'users', uid, 'accounts');
  const unsubAccounts = onSnapshot(query(accountsRef, orderBy('createdAt', 'desc')), snap=>{
    window.__currentAccounts = snap.docs.map(d=>({id:d.id,...d.data()}));
    updateAccountsUI(window.__currentAccounts);
    populateReportAccountsDropdown(window.__currentAccounts);
  });

  const strategiesRef = collection(db, 'users', uid, 'strategies');
  const unsubStrategies = onSnapshot(query(strategiesRef, orderBy('createdAt','desc')), snap=>{
    const strategies = snap.docs.map(d=>({id:d.id,...d.data()}));
    window.__currentStrategies = strategies;
    renderStrategiesUI(strategies);
    updateStrategiesDropdown(strategies);
    populateAnalyticsFilter(strategies);
  });
  
  const notesRef = collection(db, 'users', uid, 'notes');
  const unsubNotes = onSnapshot(query(notesRef, orderBy('createdAt', 'desc')), snap => {
      const notes = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderNotesHistory(notes);
  });

  unsubscribes.push(unsubTrades, unsubSettings, unsubGeneralSettings, unsubAccounts, unsubStrategies, unsubNotes);
}

onAuthStateChanged(auth, async (user) => {
    const userNameEl = $('.user-name');
    if (user) {
        await user.getIdToken(true);
        const token = await user.getIdTokenResult();
        const role = token.claims.role || 'user';
        document.body.classList.toggle('is-admin', role === 'admin');
        
        if (userNameEl) userNameEl.textContent = user.displayName || user.email;
        $('.avatar').textContent = (user.displayName || 'U').substring(0,2).toUpperCase();
        
        $('#welcome-title').textContent = `Bienvenido, ${user.displayName || 'Trader'}`;

        const profileNameInput = $('#profile-name-input');
        if (profileNameInput) {
            profileNameInput.value = user.displayName || '';
        }
        $('#btn-login').classList.add('hidden');
        $('#btn-logout').classList.remove('hidden');
        $('#btn-open-auth').classList.add('hidden');
        $('#welcome-message').textContent = "Tu sesión está activa. Tus operaciones se guardarán en la nube.";
        
        bindSelfRealtime(user.uid);
        
        if (role === 'admin') {
            loadAdminPanel();
        }
    } else {
        document.body.classList.remove('is-admin');
        cleanupListeners();
        
        if (userNameEl) userNameEl.textContent = 'Invitado';
        $('.avatar').textContent = 'AT';

        $('#welcome-title').textContent = 'Bienvenido';

        $('#btn-login').classList.remove('hidden');
        $('#btn-logout').classList.add('hidden');
        $('#btn-open-auth').classList.remove('hidden');
        $('#welcome-message').textContent = "Inicia sesión para guardar tus operaciones en la nube.";

        const empty = [];
        window.__currentTrades = empty;
        window.__currentAccounts = empty;
        window.__currentStrategies = empty;
        window.__currentSettings = {};
        window.__currentGeneralSettings = { initialBalance: 10000 };
        $('#settings-initial-balance').value = 10000;
        
        updateAccountsUI(empty);
        renderAnalytics(empty);
        renderCalendar(empty);
        renderStrategiesUI(empty);
        updateStrategiesDropdown(empty);
        populateAnalyticsFilter(empty);
        recalcFromTrades(empty);
        updateChallengeTrackerUI(empty, {});
        renderNotesHistory(empty);
        renderHistorySummary(empty);
        renderDetailedHistory(empty); 

        if ($('#admin-users-tbody')) $('#admin-users-tbody').innerHTML = '';
        if ($('#invite-codes-list')) $('#invite-codes-list').innerHTML = '';
        if ($('#admin-user-detail')) $('#admin-user-detail').textContent = 'Selecciona un usuario…';
        if ($('#admin-user-accounts')) $('#admin-user-accounts').innerHTML = '—';
        if ($('#admin-user-trades')) $('#admin-user-trades').innerHTML = '—';
    }
});
 
 window.updateAllCalculations = () => {
  const allTrades = window.__currentTrades || [];
  const settings = window.__currentSettings || {};
  const selectedStrategyId = $('#analytics-strategy-filter').value;
  const filteredTrades = selectedStrategyId ? allTrades.filter(t => t.strategyId === selectedStrategyId) : allTrades;
  
  recalcFromTrades(allTrades);
  renderHistorySummary(allTrades);
  renderDetailedHistory(allTrades); 
  renderAnalytics(filteredTrades);
  renderCalendar(allTrades);
  updateChallengeTrackerUI(allTrades, settings);
  updateAccountsUI(window.__currentAccounts);
  updateWeeklyProgress();
}

function calculateChallengeProgress(trades, settings) {
  const initialBalance = settings.initialBalance;
  if (!initialBalance) return {};
  
  let peakEquity = initialBalance;
  let currentEquity = initialBalance;
  let maxDrawdown = 0;
  
  const challengeTrades = (trades || []).filter(t => t.inChallenge);
  challengeTrades.forEach(trade => {
    currentEquity += trade.result;
    peakEquity = Math.max(peakEquity, currentEquity);
    const drawdown = peakEquity - currentEquity;
    maxDrawdown = Math.max(maxDrawdown, drawdown);
  });
  const totalProfit = currentEquity - initialBalance;
  const profitPercent = (totalProfit / initialBalance) * 100;
  const drawdownPercent = (maxDrawdown / initialBalance) * 100;
  const wins = challengeTrades.filter(t => t.result > 0).length;
  const winRate = challengeTrades.length ? (wins / challengeTrades.length) * 100 : 0;
  return {
    profitPercent, drawdownPercent, tradeCount: challengeTrades.length, winRate,
    profitTargetPercent: settings.profitTarget, maxLossPercent: settings.maxLoss
  };
}    

function openModalById(id) { $(`#${id}`)?.classList.add('show'); document.body.style.overflow = 'hidden'; }
function closeAllModals() { $$('.modal').forEach(m => m.classList.remove('show')); document.body.style.overflow = ''; }

function openNewTradeModal() {
    $('#trade-title').textContent = 'Agregar Operación';
    $('#editing-trade-id').value = '';
    $('#trade-date-input').value = new Date().toISOString().slice(0, 10);
    $('#trade-pair-input').value = 'EURUSD';
    $('#trade-type-input').value = 'buy';
    $('#trade-result-input').value = '';
    $('#trade-strategy-input').value = "";
    $('#trade-session-input').value = "N/A";
    $('#trade-risk-input').value = '';
    $('#trade-reward-input').value = '';
    $('#trade-challenge-input').value = 'yes';
    $('#trade-lots-input').value = '';
    $('#trade-entry-price-input').value = '';
    $('#trade-tp-input').value = '';
    $('#trade-sl-input').value = '';
    updateAccountsDropdown();
    openModalById('add-trade-modal');
}

function updateAccountsDropdown() {
    const select = $('#trade-account-input');
    if (!select) return;

    const accounts = window.__currentAccounts || [];
    const currentVal = select.value;

    select.innerHTML = '<option value="">-- Selecciona una Cuenta --</option>';
    
    accounts.forEach(acc => {
        const option = document.createElement('option');
        option.value = acc.id;
        option.textContent = `${acc.name} (${acc.broker})`;
        select.appendChild(option);
    });

    if (currentVal) select.value = currentVal;
}

function restoreAccordionState() {
    const state = JSON.parse(sessionStorage.getItem('nav-acc-state') || '{}');
    Object.entries(state).forEach(([id, open]) => {
        const panel = $(`#${id}`);
        const btn = $(`[aria-controls="${id}"]`);
        if (panel && btn) { panel.classList.toggle('open', !!open); btn.setAttribute('aria-expanded', !!open); }
    });
}
function persistAccordionState() {
    const state = {}; $$('.submenu').forEach(p => { state[p.id] = p.classList.contains('open'); });
    sessionStorage.setItem('nav-acc-state', JSON.stringify(state));
}
(function () {
    const burger = document.getElementById('burger');
    const backdrop = document.getElementById('drawerBackdrop');
    const open = () => { document.body.classList.add('sidebar-open'); burger?.setAttribute('aria-expanded', 'true'); document.body.style.overflow = 'hidden'; };
    const close = () => { document.body.classList.remove('sidebar-open'); burger?.setAttribute('aria-expanded', 'false'); document.body.style.overflow = ''; };
    const toggle = () => document.body.classList.contains('sidebar-open') ? close() : open();
    burger?.addEventListener('click', toggle);
    backdrop?.addEventListener('click', close);
    window.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
    $$('.nav a[data-target], .submenu a[data-target]').forEach(el => {
        el.addEventListener('click', () => { if (window.matchMedia('(max-width:860px)').matches) close(); });
    });
})();

$$('.nav a[data-target], .submenu a[data-target]').forEach(a => a.addEventListener('click', e => {
    e.preventDefault();
    const id = a.dataset.target;
    if (id) setActiveSection(id);
}));
$$('.nav button.nav-link').forEach(clickedBtn => {
    clickedBtn.addEventListener('click', () => {
        const targetPanelId = clickedBtn.getAttribute('aria-controls');
        const targetPanel = $(`#${targetPanelId}`);
        if (!targetPanel) return;
        const isAlreadyOpen = targetPanel.classList.contains('open');
        $$('.submenu.open').forEach(openPanel => {
            if (openPanel.id !== targetPanelId) {
                openPanel.classList.remove('open');
                const correspondingBtn = $(`[aria-controls="${openPanel.id}"]`);
                if (correspondingBtn) correspondingBtn.setAttribute('aria-expanded', 'false');
            }
        });
        if (!isAlreadyOpen) {
            targetPanel.classList.add('open');
            clickedBtn.setAttribute('aria-expanded', 'true');
        } else {
            targetPanel.classList.remove('open');
            clickedBtn.setAttribute('aria-expanded', 'false');
        }
        persistAccordionState();
    });
});
$$('[data-close]').forEach(x => x.addEventListener('click', closeAllModals));
window.addEventListener('click', e => { if (e.target.classList && e.target.classList.contains('modal')) closeAllModals(); });

const checklistIds = ['checklist-calendar', 'checklist-plan', 'checklist-revenge'];
function saveChecklistState() {
    const state = {};
    checklistIds.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) { state[id] = checkbox.checked; }
    });
    localStorage.setItem('traderChecklistState', JSON.stringify(state));
}
function loadChecklistState() {
    const savedState = JSON.parse(localStorage.getItem('traderChecklistState') || '{}');
    checklistIds.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox && savedState[id] !== undefined) { checkbox.checked = savedState[id]; }
    });
}
loadChecklistState();
checklistIds.forEach(id => {
    const checkbox = document.getElementById(id);
    if (checkbox) { checkbox.addEventListener('change', saveChecklistState); }
});

restoreAccordionState();
$('#analytics-strategy-filter')?.addEventListener('change', () => (window.updateAllCalculations || (() => { }))());
$('#edit-challenge')?.addEventListener('click', () => {
    const settings = window.__currentSettings || {};
    $('#challenge-balance').value = settings.initialBalance || 100000;
    $('#challenge-target').value = settings.profitTarget || 10;
    $('#challenge-max-loss').value = settings.maxLoss || 10;
    $('#challenge-daily-loss').value = settings.dailyLoss || 5;
    openModalById('challenge-settings-modal');
});
$('#save-general-settings-btn')?.addEventListener('click', () => {
    const settings = { initialBalance: parseFloat($('#settings-initial-balance').value) || 10000 };
    (window.saveGeneralSettings || (() => { }))(settings);
});

$('#save-profile-btn')?.addEventListener('click', async (e) => {
    const user = auth.currentUser;
    const newName = $('#profile-name-input').value.trim();
    const button = e.target;

    if (!user) {
        return alert('Debes iniciar sesión para cambiar tu nombre.');
    }
    if (!newName) {
        return alert('El nombre no puede estar vacío.');
    }

    button.disabled = true;
    button.textContent = 'Guardando...';

    try {
        await updateProfile(user, { displayName: newName });
        
        const userDocRef = doc(db, 'users', user.uid);
        await setDoc(userDocRef, { displayName: newName }, { merge: true });

        $('.user-name').textContent = newName;
        $('.avatar').textContent = newName.substring(0, 2).toUpperCase();
        
        alert('¡Perfil actualizado correctamente!');

    } catch (error) {
        console.error('Error al actualizar el perfil:', error);
        alert('Hubo un error al actualizar tu perfil: ' + error.message);
    } finally {
        button.disabled = false;
        button.textContent = 'Guardar Cambios';
    }
});

$('#refresh-distribution')?.addEventListener('click', () => (window.updateAllCalculations || (() => { }))());
$('#expand-balance-chart')?.addEventListener('click', () => {
    openModalById('balance-chart-modal');
    setTimeout(() => modalBalanceChart && modalBalanceChart.resize(), 50);
});
$('#add-trade-btn')?.addEventListener('click', openNewTradeModal);
$('#floating-add-trade-btn')?.addEventListener('click', openNewTradeModal);
$('#quick-add-trade')?.addEventListener('click', (e) => { e.preventDefault(); openNewTradeModal(); });

$('#weekly-goal-input')?.addEventListener('blur', async (e) => {
    const user = auth.currentUser;
    if (!user) return;

    const inputElement = e.target;
    const goalValue = parseFloat(inputElement.value);
    const settingsRef = doc(db, 'users', user.uid, 'settings', 'general');

    try {
        await setDoc(settingsRef, { 
            weeklyGoal: isNaN(goalValue) ? 0 : goalValue 
        }, { merge: true });

        inputElement.style.transition = 'border-color 0.3s ease';
        inputElement.style.borderColor = 'var(--success)';
        setTimeout(() => {
            inputElement.style.borderColor = 'var(--border)';
        }, 1500);

    } catch (error) {
        console.error("Error al guardar la meta semanal:", error);
        inputElement.style.borderColor = 'var(--danger)';
    }
});

$('#auth-toggle-mode')?.addEventListener('click', ()=> setAuthMode(authMode==='login' ? 'register' : 'login'));
$('#auth-submit')?.addEventListener('click', async ()=>{
  const email = $('#auth-email').value.trim();
  const pass  = $('#auth-pass').value.trim();
  const name  = $('#auth-name').value.trim();
  const inviteCode = $('#auth-invite').value.trim();
  const err   = $('#auth-error');
  if(!email || !pass) return;

  err.classList.add('hidden');
  try{
    if (authMode==='login'){
      await signInWithEmailAndPassword(auth, email, pass);
    } else {
      if (!name || !inviteCode) {
        err.textContent = "Nombre y código de invitación son requeridos.";
        err.classList.remove('hidden');
        return;
      }
      const createUser = httpsCallable(functions, 'createUserWithInvite');
      await createUser({ email, password: pass, displayName: name, inviteCode });
      await signInWithEmailAndPassword(auth, email, pass);
    }
    closeAllModals();
    $('#auth-email').value = '';
    $('#auth-pass').value = '';
    $('#auth-name').value = '';
    $('#auth-invite').value = '';
  } catch(e) { 
    err.textContent = e.message; 
    err.classList.remove('hidden'); 
  }
});
$('#btn-login')?.addEventListener('click', ()=> { setAuthMode('login'); openModalById('auth-modal'); });
$('#btn-open-auth')?.addEventListener('click', ()=> { setAuthMode('login'); openModalById('auth-modal'); });
$('#btn-logout')?.addEventListener('click', ()=> signOut(auth));
$('#forgot-password-btn')?.addEventListener('click', async () => {
    const email = $('#auth-email').value.trim();
    if (!email) {
        alert('Por favor, ingresa tu correo electrónico en el campo de email para restablecer la contraseña.');
        return;
    }
    try {
        await sendPasswordResetEmail(auth, email);
        alert('Se ha enviado un enlace para restablecer tu contraseña a tu correo electrónico.');
        closeAllModals();
    } catch (error) {
        alert('Error al enviar el correo: ' + error.message);
    }
});

$('#btn-save-note')?.addEventListener('click', async (e) => {
    const noteText = $('#session-note-textarea').value.trim();
    const editingId = $('#editing-note-id').value;
    const user = auth.currentUser;

    if (!noteText) return alert('La nota no puede estar vacía.');
    if (!user) return alert('Debes iniciar sesión para guardar notas.');

    const button = e.target;
    button.disabled = true;

    try {
        if (editingId) {
            const noteRef = doc(db, 'users', user.uid, 'notes', editingId);
            await updateDoc(noteRef, { text: noteText });
        } else {
            await addDoc(collection(db, 'users', user.uid, 'notes'), {
                text: noteText,
                createdAt: serverTimestamp(),
                dateStr: new Date().toISOString().slice(0, 10)
            });
        }
        $('#session-note-textarea').value = '';
        $('#editing-note-id').value = '';
        alert(editingId ? 'Nota actualizada.' : 'Nota guardada.');
    } catch (error) {
       console.error("Error guardando la nota:", error);
        alert('No se pudo guardar la nota.');
    } finally {
        button.disabled = false;
    }
});

// EN TU ARCHIVO index.html, DENTRO DEL SCRIPT
// Reemplaza la función 'saveTrade' completa con esta

async function saveTrade(tradeData) {
    const user = auth.currentUser;
    if (!user) {
        throw new Error('Debes iniciar sesión para guardar operaciones.');
    }

    // 1. OBTENER EL TOKEN DE AUTENTICACIÓN DEL USUARIO
    const token = await user.getIdToken();

    // 2. PREPARAR DATOS (esto ya lo tenías, pero nos aseguramos)
    const operationData = {
        pair: tradeData.pair,
        type: tradeData.type,
        strategy: tradeData.strategyId || "Ninguna",
        session: tradeData.session || "N/A",
        inChallenge: tradeData.inChallenge === true,
        account: tradeData.accountId || "FTMO Challenge 100K",
        dateStr: tradeData.dateStr,
        lots: parseFloat(tradeData.lots) || 0,
        result: parseFloat(tradeData.result) || 0,
        entryPrice: parseFloat(tradeData.entryPrice) || 0,
        takeProfit: parseFloat(tradeData.takeProfit) || 0,
        stopLoss: parseFloat(tradeData.stopLoss) || 0,
        risk: parseFloat(tradeData.risk) || 0,
        reward: parseFloat(tradeData.reward) || 0
    };

    console.log('Enviando datos con fetch:', operationData);

    // 3. LLAMAR A LA FUNCIÓN CON FETCH, AÑADIENDO EL TOKEN
    const response = await fetch('https://us-central1-journal-infiniti-kapital.cloudfunctions.net/addManualTrade', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // ¡Esta cabecera es la clave para la autenticación!
            'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify(operationData)
    });

    if (!response.ok) {
        const errorBody = await response.json();
        throw new Error(errorBody.message || 'El servidor devolvió un error.');
    }

    return await response.json();
}
window.saveGeneralSettings = async function(settings) {
    const user = auth.currentUser;
    if (!user) return;
    const settingsRef = doc(db, 'users', user.uid, 'settings', 'general');
    await setDoc(settingsRef, settings, { merge: true });
    alert('Configuración guardada.');
}
async function saveChallengeSettings(settings) {
    const user = auth.currentUser; if (!user) return;
    const settingsRef = doc(db, 'users', user.uid, 'settings', 'challenge');
    await setDoc(settingsRef, settings, { merge: true });
}
async function deleteItem(collectionName, id) {
  const user = auth.currentUser; if (!user || !id) return;
  if (confirm(`¿Estás seguro de que quieres eliminar este elemento?`)) {
    await deleteDoc(doc(db, 'users', user.uid, collectionName, id));
  }
}

function renderNotesHistory(notes) {
    const container = $('#notes-history-container');
    if (!container) return;

    if (!notes || notes.length === 0) {
        container.innerHTML = `<p style="color: var(--muted);">No hay notas guardadas.</p>`;
        return;
    }

    container.innerHTML = notes.map(note => `
        <div class="card" style="margin-bottom: 12px; background: var(--secondary);">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <p style="white-space: pre-wrap; margin: 0; flex-grow:1;">${note.text}</p>
                <div style="display:flex; gap: 8px; margin-left:16px;">
                    <button class="btn-icon btn-edit-note" data-id="${note.id}" title="Editar Nota"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon btn-delete-note" data-id="${note.id}" title="Eliminar Nota"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <small style="display: block; text-align: right; color: var(--muted); margin-top: 8px;">${note.dateStr}</small>
        </div>
    `).join('');
}

// EN TU index.html, DENTRO DEL <script type="module">
// Reemplaza tu addEventListener de 'main' completo con este bloque

$('main')?.addEventListener('click', (e) => {
  
  // --- LÓGICA MEJORADA PARA EDITAR OPERACIONES ---
  const editTradeBtn = e.target.closest('.btn-edit-trade');
  if (editTradeBtn) {
    const trade = window.__currentTrades?.find(t => t.id === editTradeBtn.dataset.id);
    if (trade) {
        // 1. Llenamos el dropdown de cuentas ANTES de intentar seleccionar una
        updateAccountsDropdown(); 
        
        // 2. Llenamos TODOS los campos del formulario con los datos del trade
        $('#trade-title').textContent = 'Editar Operación';
        $('#editing-trade-id').value = trade.id;
        
        // CORRECCIÓN CLAVE: Selecciona la cuenta correcta y maneja diferentes nombres de campo
        $('#trade-account-input').value = trade.account || trade.accountId || "";
        
        $('#trade-date-input').value = trade.dateStr || new Date().toISOString().slice(0, 10);
        $('#trade-pair-input').value = trade.pair || '';
        $('#trade-type-input').value = trade.type || 'buy';
        $('#trade-result-input').value = trade.result || '';
        $('#trade-strategy-input').value = trade.strategy || trade.strategyId || "";
        $('#trade-session-input').value = trade.session || "N/A";
        $('#trade-risk-input').value = trade.risk || '';
        $('#trade-reward-input').value = trade.reward || '';
        $('#trade-challenge-input').value = trade.inChallenge ? 'yes' : 'no';
        $('#trade-lots-input').value = trade.lots || '';
        $('#trade-entry-price-input').value = trade.entryPrice || '';
        $('#trade-tp-input').value = trade.takeProfit || '';
        $('#trade-sl-input').value = trade.stopLoss || '';

        openModalById('add-trade-modal');
    }
    return; // Importante para no seguir ejecutando
  }
  
  // --- TU CÓDIGO EXISTENTE PARA OTROS BOTONES (SIN CAMBIOS) ---
  
  const editAccountBtn = e.target.closest('.btn-edit-account');
  if (editAccountBtn) {
    const account = window.__currentAccounts?.find(a => a.id === editAccountBtn.dataset.id);
    if (account) {
      $('#acc-title').textContent = 'Editar Cuenta'; 
      $('#account-name').value = account.name; 
      $('#account-broker').value = account.broker || '';
      $('#account-balance').value = account.balance;
      $('#account-type').value = account.type; 
      $('#editing-account-id').value = account.id; 
      openModalById('add-account-modal');
    }
    return;
  }
  
  const deleteAccountBtn = e.target.closest('.btn-delete-account');
  if (deleteAccountBtn) { 
    deleteItem('accounts', deleteAccountBtn.dataset.id); 
    return; 
  }
  
  const deleteTradeBtn = e.target.closest('.btn-delete-trade');
  if (deleteTradeBtn) { 
    deleteItem('trades', deleteTradeBtn.dataset.id); 
    return; 
  }
  
  const editStrategyBtn = e.target.closest('.btn-edit-strategy');
  if (editStrategyBtn) {
    const strategy = window.__currentStrategies?.find(s => s.id === editStrategyBtn.dataset.id);
    if (strategy) {
        $('#strategy-title').textContent = 'Editar Estrategia'; 
        $('#strategy-name').value = strategy.name;
        $('#strategy-desc').value = strategy.desc; 
        $('#editing-strategy-id').value = strategy.id; 
        openModalById('add-strategy-modal');
    }
    return;
  }

  const deleteStrategyBtn = e.target.closest('.btn-delete-strategy');
  if (deleteStrategyBtn) { 
    deleteItem('strategies', deleteStrategyBtn.dataset.id); 
    return; 
  }
  
  const evaluateAiBtn = e.target.closest('.btn-evaluate-ai');
  if (evaluateAiBtn) {
      const strategy = window.__currentStrategies?.find(s => s.id === evaluateAiBtn.dataset.id);
      if (strategy) {
        evaluateStrategyWithAI(strategy);
      }
      return;
  }

  const deleteNoteBtn = e.target.closest('.btn-delete-note');
  if (deleteNoteBtn) {
    deleteItem('notes', deleteNoteBtn.dataset.id);
    return;
  }
  
  const editNoteBtn = e.target.closest('.btn-edit-note');
  if (editNoteBtn) {
      const noteId = editNoteBtn.dataset.id;
      const noteCard = editNoteBtn.closest('.card');
      const noteText = noteCard.querySelector('p').textContent;
      
      $('#session-note-textarea').value = noteText;
      $('#session-note-textarea').focus();
      $('#editing-note-id').value = noteId;
      return;
  }

  const openUserBtn = e.target.closest('.btn-open-user');
  if (openUserBtn) {
      openUserDetail(openUserBtn.dataset.uid);
      return;
  }
});
    
$('#save-challenge-settings-btn')?.addEventListener('click', async () => {
  const settings = {
    initialBalance: parseFloat($('#challenge-balance').value) || 100000,
    profitTarget: parseFloat($('#challenge-target').value) || 10,
    maxLoss: parseFloat($('#challenge-max-loss').value) || 10,
    dailyLoss: parseFloat($('#challenge-daily-loss').value) || 5
  };
  try {
    await saveChallengeSettings(settings);
    closeAllModals();
    alert('Ajustes del Challenge guardados correctamente.');
  } catch (error) {
    alert('Hubo un error al guardar los ajustes.');
  }
});

$('#save-account-btn')?.addEventListener('click', async () => {
  const accountData = {
    id: $('#editing-account-id').value,
    name: $('#account-name').value.trim(),
    broker: $('#account-broker').value.trim(),
    balance: parseFloat($('#account-balance').value) || 0,
    type: $('#account-type').value
  };
  if (!accountData.name) return alert('Por favor, ingresa un nombre para la cuenta.');
  try {
    await saveAccount(accountData);
    closeAllModals();
    alert('Cuenta guardada correctamente.');
  } catch (error) {
    alert('Hubo un error al guardar la cuenta.');
  }
});

// EN TU index.html, DENTRO DEL <script type="module">
// --- Reemplaza el Event Listener del botón 'save-trade-btn' ---

$('#save-trade-btn')?.addEventListener('click', async () => {
    const button = $('#save-trade-btn');
    button.disabled = true;
    button.textContent = 'Guardando...';

    try {
        const editingId = $('#editing-trade-id').value;
        const selectedAccountId = $('#trade-account-input').value;

        // Validación clave para la cuenta
        if (!selectedAccountId) {
            throw new Error('Por favor, selecciona la cuenta asociada a esta operación.');
        }

        // 1. Recolectamos TODOS los datos del formulario con los nombres correctos
        const tradeData = {
            account: selectedAccountId, // El ID de la cuenta
            dateStr: $('#trade-date-input').value,
            pair: $('#trade-pair-input').value,
            type: $('#trade-type-input').value,
            result: $('#trade-result-input').value,
            strategy: $('#trade-strategy-input').value, // Usamos 'strategy'
            session: $('#trade-session-input').value,
            risk: $('#trade-risk-input').value,
            reward: $('#trade-reward-input').value,
            inChallenge: $('#trade-challenge-input').value === 'yes',
            lots: $('#trade-lots-input').value,
            entryPrice: $('#trade-entry-price-input').value,
            takeProfit: $('#trade-tp-input').value,
            stopLoss: $('#trade-sl-input').value
        };

        // 2. Decidimos si llamar a la función de editar o de crear
        if (editingId) {
            // --- LÓGICA DE EDICIÓN ---
            tradeData.tradeId = editingId; // Añadimos el ID para que el backend sepa cuál editar
            
            const token = await auth.currentUser.getIdToken();
            const response = await fetch('https://us-central1-journal-infiniti-kapital.cloudfunctions.net/editManualTrade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(tradeData)
            });
            if (!response.ok) throw new Error((await response.json()).message || 'Error al actualizar.');
            alert('¡Operación actualizada con éxito!');

        } else {
            // --- LÓGICA DE CREACIÓN ---
            const token = await auth.currentUser.getIdToken();
            const response = await fetch('https://us-central1-journal-infiniti-kapital.cloudfunctions.net/addManualTrade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(tradeData)
            });
            if (!response.ok) throw new Error((await response.json()).message || 'Error al guardar.');
            alert('¡Operación guardada con éxito!');
        }
        
        closeAllModals();

    } catch (error) {
        console.error("Error detallado al guardar:", error);
        alert('Hubo un error: ' + error.message);
    } finally {
        button.disabled = false;
        button.textContent = 'Guardar Operación';
    }
});
    
$('#save-strategy-btn')?.addEventListener('click', async () => {
    const name = $('#strategy-name').value.trim();
    if(!name) return alert('El nombre de la estrategia es requerido.');
    const strategyData = {
        id: $('#editing-strategy-id').value,
        name: name,
        desc: $('#strategy-desc').value.trim()
    };
    try {
        await saveStrategy(strategyData);
        closeAllModals();
    } catch (error) {
        alert('Hubo un error al guardar la estrategia.');
    }
});
    
$('#btn-generate-api-key')?.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return alert('Debes iniciar sesión para generar una clave de API.');
    const apiKeyDisplay = $('#api-key-display');
    apiKeyDisplay.textContent = 'Generando...';
    const userDocRef = doc(db, 'users', user.uid);
    try {
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists() && userDoc.data().apiKey) {
            apiKeyDisplay.textContent = userDoc.data().apiKey;
        } else {
            const newKey = 'ik_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
            await setDoc(userDocRef, { apiKey: newKey }, { merge: true });
            apiKeyDisplay.textContent = newKey;
        }
    } catch (error) {
        console.error("Error al generar clave API:", error);
        apiKeyDisplay.textContent = 'Error al generar la clave.';
    }
});

async function evaluateStrategyWithAI(strategy) {
    const modalBody = $('#ai-response-body');
    modalBody.textContent = 'Contactando a la IA de Gemini...';
    openModalById('ai-response-modal');
    try {
        const evaluateStrategy = httpsCallable(functions, 'evaluateStrategy');
        const result = await evaluateStrategy({ name: strategy.name, desc: strategy.desc });
        modalBody.textContent = result.data.text;
    } catch (error) {
        modalBody.textContent = 'Hubo un error al contactar el servicio de IA.\n\nError: ' + error.message;
    }
}

async function updateUserRole(uid, newRole) {
  try {
    const setRoleFunction = httpsCallable(functions, 'setAdminRole');
    await setRoleFunction({ uid: uid, role: newRole });
    alert(`Rol del usuario actualizado a "${newRole}" correctamente.`);
  } catch (error) {
    alert('Error al actualizar el rol: ' + error.message);
    loadUsersTable();
  }
}

let unsubInvites = null;
async function loadAdminPanel() {
loadUsersTable();
unsubInvites && unsubInvites();
const invitesRef = collection(db, 'invitations');
const q = query(invitesRef, where('isUsed', '==', false));
unsubInvites = onSnapshot(q, snap => {
    const listEl = $('#invite-codes-list');
    if (!listEl) return;
    if (snap.empty) {
        listEl.textContent = 'No hay códigos de invitación activos.';
        return;
    }
    listEl.innerHTML = snap.docs.map(d => `<div style="background: var(--secondary); padding: 8px 12px; border-radius: 8px; font-family: monospace;">${d.id}</div>`).join('');
});
unsubscribes.push(unsubInvites);
}
$('#btn-generate-invite')?.addEventListener('click', async () => {
    try {
        const generateCode = httpsCallable(functions, 'generateInviteCode');
        const result = await generateCode();
        alert(`Código generado: ${result.data.code}`);
    } catch (error) {
        alert('Error al generar código: ' + error.message);
    }
});

async function loadUsersTable(){
  if (!auth.currentUser) return;
  const token = await auth.currentUser.getIdTokenResult(true);
  if (token.claims.role !== 'admin') return;
  
  const tbody = $('#admin-users-tbody'); 
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="4">Cargando…</td></tr>';
  
  try {
    const usersSnap = await getDocs(collection(db, 'users'));
    tbody.innerHTML = usersSnap.docs.map(d => {
        const u = d.data();
        return `<tr>
        <td style="padding:8px;border-bottom:1px solid var(--border)">${u.email||'—'}</td>
        <td style="padding:8px;border-bottom:1px solid var(--border)">${u.displayName||'—'}</td>
        <td style="padding:8px;border-bottom:1px solid var(--border)">
            <select class="form-control admin-role-select" data-uid="${d.id}" style="padding: 6px;">
            <option value="user" ${u.role !== 'admin' ? 'selected' : ''}>Usuario</option>
            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
        </td>
        <td style="padding:8px;border-bottom:1px solid var(--border)">
            <button class="btn secondary btn-open-user" data-uid="${d.id}">Ver Detalles</button>
        </td>
        </tr>`;
    }).join('') || '<tr><td colspan="4">Sin usuarios.</td></tr>';
  } catch (error) {
    tbody.innerHTML = `<tr><td colspan="4" style="color:var(--danger)">Error al cargar usuarios: ${error.message}</td></tr>`;
  }
}
    
async function openUserDetail(uid){
  $('#admin-user-detail').textContent = `Usuario: ${uid}`;
  $('#admin-user-accounts').textContent = 'Cargando…';
  $('#admin-user-trades').textContent   = 'Cargando…';
  try {
    const accSnap = await getDocs(collection(db, 'users', uid, 'accounts'));
    const trdSnap = await getDocs(query(collection(db, 'users', uid, 'trades'), orderBy('createdAt','desc')));

    $('#admin-user-accounts').innerHTML = accSnap.docs.map(d => `<div><b>${d.data().name||'Cuenta'}</b> · $${(d.data().balance||0).toFixed(2)}</div>`).join('') || 'Sin cuentas';
    $('#admin-user-trades').innerHTML = trdSnap.docs.map(d => `<div>${d.data().dateStr||''} · ${d.data().pair||'—'} · $${(d.data().result||0).toFixed(2)}</div>`).join('') || 'Sin trades';

  } catch(error) {
    console.error("Error al obtener detalles del usuario:", error);
    $('#admin-user-accounts').textContent = 'Error al cargar.';
    $('#admin-user-trades').textContent = 'Error al cargar.';
  }
}

const adminTbody = $('#admin-users-tbody');
if(adminTbody) {
    const observer = new MutationObserver((mutationsList) => {
        for(const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                $$('.admin-role-select').forEach(select => {
                    if (!select.dataset.listenerAttached) {
                        select.addEventListener('change', (e) => {
                            const uid = e.target.dataset.uid;
                            const newRole = e.target.value;
                            if (uid && newRole) {
                                updateUserRole(uid, newRole);
                            }
                        });
                        select.dataset.listenerAttached = 'true';
                    }
                });
            }
        }
    });
    observer.observe(adminTbody, { childList: true, subtree: true });
}

$('#btn-refresh-users')?.addEventListener('click', loadUsersTable);

const filterButtons = document.querySelectorAll('#history-filter-buttons button');
filterButtons.forEach(button => {
    button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const range = button.dataset.range;
        const allTrades = window.__currentTrades || [];
        if (range === 'all') {
            renderHistorySummary(allTrades);
            return;
        }
        
        const now = new Date();
        const startDate = new Date(now);
        
        if (range === '1w') {
            const dayOfWeek = now.getDay();
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            startDate.setDate(diff);
        } else if (range === '15d') {
            startDate.setDate(now.getDate() - 15);
        } else if (range === '1m') {
            startDate.setMonth(now.getMonth() - 1);
        } else if (range === '3m') {
            startDate.setMonth(now.getMonth() - 3);
        } else if (range === '6m') {
            startDate.setMonth(now.getMonth() - 6);
        } else if (range === '1y') {
            startDate.setFullYear(now.getFullYear() - 1);
        }
        
        const startDateStr = startDate.toISOString().slice(0, 10);
        const filteredTrades = allTrades.filter(t => t.dateStr >= startDateStr);
        renderHistorySummary(filteredTrades);
    });
});

let lastReportData = [];
$('#generate-report-btn').addEventListener('click', async () => {
    const startDate = $('#report-start-date').value;
    const endDate = $('#report-end-date').value;
    const user = auth.currentUser;

    if (!startDate || !endDate) { return alert('Por favor, selecciona un rango de fechas.'); }
    if (!$('#report-account-select').value) { return alert('Por favor, selecciona una cuenta para el reporte.'); }
    if (!user) { return alert('Debes iniciar sesión para generar reportes.'); }

    const tradesRef = collection(db, 'users', user.uid, 'trades');
    const q = query(tradesRef, where('dateStr', '>=', startDate), where('dateStr', '<=', endDate));
    
    const reportResults = $('#report-results');
    const tbody = $('#report-table-body');
    const reportButtons = $$('#download-csv-btn, #download-excel-btn, #download-pdf-btn');
    
    tbody.innerHTML = '';
    reportResults.classList.add('hidden');
    reportButtons.forEach(btn => btn.disabled = true);

    try {
        const snapshot = await getDocs(q);
        const trades = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        lastReportData = trades; 

        if (trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 12px;">No se encontraron operaciones en este rango de fechas.</td></tr>';
        } else {
            const wins = trades.filter(t => t.result > 0);
            const totalProfit = trades.reduce((sum, t) => sum + t.result, 0);
            const totalWinsValue = wins.reduce((sum, t) => sum + t.result, 0);
            const totalLossValue = Math.abs(trades.filter(t => t.result < 0).reduce((sum, t) => sum + t.result, 0));

            $('#report-total-profit').textContent = `$${totalProfit.toFixed(2)}`;
            $('#report-total-trades').textContent = trades.length;
            $('#report-win-rate').textContent = `${((wins.length / trades.length) * 100).toFixed(1)}%`;
            $('#report-profit-factor').textContent = (totalLossValue > 0 ? (totalWinsValue / totalLossValue) : 0).toFixed(2);
            
            tbody.innerHTML = trades.map(t => `
                <tr>
                    <td style="padding:8px;">${t.dateStr}</td>
                    <td style="padding:8px;">${t.pair}</td>
                    <td style="padding:8px;">${t.type === 'buy' ? 'Compra' : 'Venta'}</td>
                    <td style="padding:8px; text-align:right; color: ${t.result >= 0 ? 'var(--success)' : 'var(--danger)'};">$${t.result.toFixed(2)}</td>
                    <td style="padding:8px; text-align:right;">${t.lots || '--'}</td>
                    <td style="padding:8px;">${t.strategyId ? (window.__currentStrategies.find(s=>s.id === t.strategyId)?.name || 'N/A') : 'N/A'}</td>
                </tr>
            `).join('');
            
            reportButtons.forEach(btn => btn.disabled = false);
        }
        reportResults.classList.remove('hidden');

    } catch (error) {
        console.error("Error generando el reporte: ", error);
        alert('Hubo un error al generar el reporte.');
    }
});

async function generateSHA256(str) {
    const textAsBuffer = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function exportToCSV() {
    if (lastReportData.length === 0) { return alert('Primero genera un reporte con datos.'); }
    const headers = ['Fecha', 'Simbolo', 'Tipo', 'Resultado ($)', 'Lotes', 'Estrategia'];
    const rows = lastReportData.map(t => [ t.dateStr, t.pair, t.type, t.result, t.lots || '', t.strategyId ? (window.__currentStrategies.find(s=>s.id === t.strategyId)?.name || '') : '' ]);
    let csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(e => e.join(','))].join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `reporte_journal_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportToExcel() {
    if (lastReportData.length === 0) { return alert('Primero genera un reporte con datos.'); }
    const data = lastReportData.map(t => ({
        Fecha: t.dateStr, Simbolo: t.pair, Tipo: t.type, 'Resultado ($)': t.result,
        Lotes: t.lots || '', Estrategia: t.strategyId ? (window.__currentStrategies.find(s=>s.id === t.strategyId)?.name || '') : ''
    }));
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Reporte");
    XLSX.writeFile(workbook, `reporte_journal_${new Date().toISOString().slice(0,10)}.xlsx`);
}

async function exportToPDF() {
    if (lastReportData.length === 0) { return alert('Primero genera un reporte con datos.'); }
    const accountId = $('#report-account-select').value;
    if (!accountId) { return alert('Por favor, selecciona una cuenta para el reporte.'); }

    const account = window.__currentAccounts.find(a => a.id === accountId);
    const user = auth.currentUser;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageHeight = doc.internal.pageSize.height;
    
    const reportId = `REP-${user.uid.slice(0, 4)}-${Date.now()}`;
    const dataString = JSON.stringify(lastReportData);
    const reportHash = await generateSHA256(dataString);

    doc.setFontSize(20);
    doc.text("Reporte de Operaciones", 14, 22);
    doc.setFontSize(10);
    doc.text(`Cuenta: ${account.name}`, 14, 30);
    doc.text(`Broker: ${account.broker || 'No especificado'}`, 14, 35);
    doc.text(`Balance Inicial: $${account.balance.toFixed(2)}`, 14, 40);
    
    doc.text(`Desde: ${$('#report-start-date').value}`, 140, 30);
    doc.text(`Hasta: ${$('#report-end-date').value}`, 140, 35);

    // --- Preparar Firma Digital (SHA-256) ---
  const resumen = `${account.name}|${stats.finalBalance}|${stats.netProfit}|${stats.totalTrades}|${stats.profitFactor}|${stats.winRate.toFixed(1)}|${stats.maxDrawdownPercent.toFixed(2)}|${dateFrom}-${dateTo}`;
  let shaSignature = '';
  try { shaSignature = await window.generateSHA256(resumen); } catch(e) { console.error('SHA256 error', e); }

  doc.autoTable({

        head: [['Fecha', 'Simbolo', 'Tipo', 'Resultado ($)', 'Lotes', 'Estrategia']],
        body: lastReportData.map(t => [
            t.dateStr, t.pair, t.type, t.result.toFixed(2), t.lots || '',
            t.strategyId ? (window.__currentStrategies.find(s=>s.id === t.strategyId)?.name || '') : ''
        ]),
        startY: 50,
        didDrawPage: function (data) {
            doc.setFontSize(8);
            doc.text(`Report ID: ${reportId}`, 14, pageHeight - 15);
            doc.text(`Firma Digital (SHA-256): ${reportHash.slice(0,32)}...`, 14, pageHeight - 10);
            doc.text('Página ' + doc.internal.getNumberOfPages(), doc.internal.pageSize.width - 14, pageHeight - 10, { align: 'right' ,
    didDrawPage: function (data) {
      doc.setFontSize(8);
      const pageW = doc.internal.pageSize.width;
      const pageH = doc.internal.pageSize.height;
      // Firma a la izquierda
      doc.text(`Firma (SHA-256): ${shaSignature}`, 14, pageH - 10);
      // Número de página a la derecha
      doc.text('Página ' + doc.internal.getNumberOfPages(), pageW - 14, pageH - 10, { align: 'right' });
    }
  });
}
    });
    
    doc.save(`reporte_${account.name}_${new Date().toISOString().slice(0,10)}.pdf`);
}


$('#download-csv-btn').addEventListener('click', exportToCSV);
$('#download-excel-btn').addEventListener('click', exportToExcel);
$('#download-pdf-btn').addEventListener('click', exportToPDF);
</script>

<style>
  #dashboard .card.risk {
    display: flex;
    flex-direction: column;
  }

  #dashboard .card.risk .chart {
    height: 180px !important;
    max-height: 180px !important;
  }

  .card.news .card-body {
    padding: 0 !important;
    height: 100%;
    width: 100%;
  }
  
  .card.news .tradingview-widget-container,
  .card.news .tradingview-widget-container__widget {
      height: 100%;
  }
</style>
   
 <script type="module">
// === Bloque integrado: Exportar a PDF + Login helpers (no cambia tu lógica existente) ===

// Modo de auth (para alternar texto del modal)
let authMode = 'login';

// Utilidades DOM
const $ = (sel) => document.querySelector(sel);

// Cerrar modales genérico (usa tu misma convención [data-close])
const closeAllModals = () => {
  document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
  // fallback si hay estilos inline (compatibilidad)
  document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
};

// Wiring básico de botones del modal auth
document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', closeAllModals));
$('#auth-toggle-mode')?.addEventListener('click', () => {
  authMode = authMode === 'login' ? 'register' : 'login';
  $('#auth-title').textContent = authMode === 'login' ? 'Acceso' : 'Crear Cuenta';
  $('#auth-submit').textContent = authMode === 'login' ? 'Entrar' : 'Registrar';
  $('#auth-toggle-mode').textContent = authMode === 'login' ? 'Crear cuenta' : 'Ya tengo cuenta';
  $('#auth-name-wrap')?.classList.toggle('hidden', authMode === 'login');
  $('#auth-invite-wrap')?.classList.toggle('hidden', authMode === 'login');
});

// Ver/ocultar contraseña
$('#toggle-password')?.addEventListener('click', () => {
  const passInput = $('#auth-pass');
  const icon = $('#toggle-password i');
  if (!passInput || !icon) return;
  const isPassword = passInput.type === 'password';
  passInput.type = isPassword ? 'text' : 'password';
  icon.className = isPassword ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
});

// Handler de submit (delegado para que no choque con tu auth real)
// Si tienes lógica de Firebase ya activa, este bloque solo gestiona UI de errores y cierra modal tras submit exitoso.
$('#auth-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const err = $('#auth-error');
  try {
    // No hacemos signIn aquí para no interferir con tu flujo actual.
    // Si quieres, puedes disparar un CustomEvent para que lo capture tu lógica:
    const detail = {
      mode: authMode,
      email: $('#auth-email')?.value?.trim(),
      password: $('#auth-pass')?.value?.trim(),
      displayName: $('#auth-name')?.value?.trim(),
      inviteCode: $('#auth-invite')?.value?.trim(),
    };
    document.dispatchEvent(new CustomEvent('auth:submit', { detail }));
    closeAllModals();
    $('#auth-form')?.reset();
    err?.classList.add('hidden');
  } catch (error) {
    if (err) {
      err.textContent = error?.message || 'Error de autenticación';
      err.classList.remove('hidden');
    }
  }
});

// === Cálculos para PDF (idénticos al bloque original, pero usando tus datos si existen) ===
function calculateStreaks(trades) {
  let maxWinning = 0, currentWinning = 0, maxLosing = 0, currentLosing = 0;
  (trades || []).forEach(trade => {
    if ((trade.result ?? 0) > 0) { currentWinning++; currentLosing = 0; }
    else if ((trade.result ?? 0) < 0) { currentLosing++; currentWinning = 0; }
    if (currentWinning > maxWinning) maxWinning = currentWinning;
    if (currentLosing > maxLosing) maxLosing = currentLosing;
  });
  return { maxWinning, maxLosing };
}

function calculateDrawdown(trades, initialBalance) {
  let peakEquity = initialBalance;
  let maxDrawdownValue = 0;
  let currentEquity = initialBalance;
  (trades || []).forEach(trade => {
    currentEquity += (trade.result ?? 0);
    if (currentEquity > peakEquity) peakEquity = currentEquity;
    const dd = peakEquity - currentEquity;
    if (dd > maxDrawdownValue) maxDrawdownValue = dd;
  });
  const maxDrawdownPercent = initialBalance > 0 ? (maxDrawdownValue / initialBalance) * 100 : 0;
  return { maxDrawdownValue, maxDrawdownPercent };
}

function calculateReportStats(trades, initialBalance) {
  const t = trades || [];
  const wins = t.filter(x => (x.result ?? 0) > 0);
  const losses = t.filter(x => (x.result ?? 0) < 0);
  const grossProfit = wins.reduce((s, x) => s + (x.result ?? 0), 0);
  const grossLoss = losses.reduce((s, x) => s + (x.result ?? 0), 0);
  const netProfit = grossProfit + grossLoss;
  const profitFactor = Math.abs(grossLoss) > 0 ? grossProfit / Math.abs(grossLoss) : 0;
  const streaks = calculateStreaks(t);
  const drawdown = calculateDrawdown(t, initialBalance);

  return {
    netProfit,
    finalBalance: initialBalance + netProfit,
    totalTrades: t.length,
    winRate: t.length > 0 ? (wins.length / t.length) * 100 : 0,
    grossProfit,
    grossLoss,
    profitFactor,
    maxWinningStreak: streaks.maxWinning,
    maxLosingStreak: streaks.maxLosing,
    maxDrawdownValue: drawdown.maxDrawdownValue,
    maxDrawdownPercent: drawdown.maxDrawdownPercent,
  };
}

// Exportar a PDF (usa jsPDF/xAutoTable ya incluidos en tu <head>)
async function exportToPDF() {
  // Fuente de datos: usa el resultado actual de tu app si existe
  const trades = (window.currentReportData && Array.isArray(window.currentReportData) ? window.currentReportData : (window.__currentTrades || [])).slice();
  if (!trades.length) { alert('Primero genera un reporte con datos.'); return; }

  const accSelect = document.querySelector('#report-account-select');
  if (!accSelect || !accSelect.value) { alert('Por favor, selecciona una cuenta para el reporte.'); return; }

  // Buscar la cuenta seleccionada en el modelo actual
  const accounts = window.__currentAccounts || window.currentAccounts || [];
  const account = accounts.find(a => (a.id === accSelect.value)) || { name: accSelect.value, balance: 0 };
  const initialBalance = parseFloat(account.balance || 0);

  const stats = calculateReportStats(trades, initialBalance);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const pageHeight = doc.internal.pageSize.height;

  // Encabezado
  doc.setFontSize(20); doc.text("Reporte de Rendimiento", 14, 22);
  doc.setFontSize(10);
  const dateFrom = (document.querySelector('#report-start-date')?.value) || '';
  const dateTo   = (document.querySelector('#report-end-date')?.value)   || '';
  doc.text(`Cuenta: ${account.name || '—'}`, 14, 30);
  doc.text(`Desde: ${dateFrom} | Hasta: ${dateTo}`, 14, 35);

  // Resumen
  doc.setFontSize(12); doc.text("Resumen de Rendimiento", 14, 50); doc.setFontSize(10);
  let y = 58, yCol2 = 58;
  doc.text("Beneficio Neto:", 14, y); doc.text(`$${stats.netProfit.toFixed(2)}`, 80, y); y += 6;
  doc.text("Balance Final:", 14, y); doc.text(`$${stats.finalBalance.toFixed(2)}`, 80, y); y += 6;
  doc.text("Total de Operaciones:", 14, y); doc.text(`${stats.totalTrades}`, 80, y); y += 6;
  doc.text("Tasa de Acierto:", 14, y); doc.text(`${stats.winRate.toFixed(1)}%`, 80, y); y += 6;
  doc.text("Profit Factor:", 14, y); doc.text(`${stats.profitFactor.toFixed(2)}`, 80, y); y += 6;

  doc.text("Beneficio Bruto:", 110, yCol2); doc.text(`$${stats.grossProfit.toFixed(2)}`, 170, yCol2); yCol2 += 6;
  doc.text("Pérdida Bruta:", 110, yCol2); doc.text(`-$${Math.abs(stats.grossLoss).toFixed(2)}`, 170, yCol2); yCol2 += 6;
  doc.text("Racha Ganadora Máx.:", 110, yCol2); doc.text(`${stats.maxWinningStreak} trades`, 170, yCol2); yCol2 += 6;
  doc.text("Racha Perdedora Máx.:", 110, yCol2); doc.text(`${stats.maxLosingStreak} trades`, 170, yCol2); yCol2 += 6;
  doc.text("Drawdown Máximo:", 110, yCol2); doc.text(`-$${stats.maxDrawdownValue.toFixed(2)} (${stats.maxDrawdownPercent.toFixed(2)}%)`, 170, yCol2); yCol2 += 6;

  // Tabla
  const strategies = (window.__currentStrategies || []).reduce((m, s) => { m[s.id] = s.name || s.id; return m; }, {});
  const body = trades.map(t => [
    t.dateStr || '', t.pair || t.symbol || '', (t.type === 'buy' ? 'Compra' : (t.type === 'sell' ? 'Venta' : (t.type || ''))),
    ((t.result ?? 0).toFixed ? (t.result ?? 0).toFixed(2) : Number(t.result ?? 0).toFixed(2)),
    (t.lots ?? t.lot ?? ''), (t.strategyId ? (strategies[t.strategyId] || t.strategyId) : (t.strategy || ''))
  ]);

  doc.autoTable({
    head: [['Fecha', 'Símbolo', 'Tipo', 'Resultado ($)', 'Lotes', 'Estrategia']],
    body,
    startY: Math.max(y, yCol2) + 4,
    didDrawPage: function () {
      doc.setFontSize(8);
      doc.text('Página ' + doc.internal.getNumberOfPages(), doc.internal.pageSize.width - 14, pageHeight - 10, { align: 'right' });
    }
  });

  const fileName = `reporte_${(account.name || 'cuenta')}_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(fileName);
}

// Exponer para que puedas llamarlo desde cualquier botón existente
window.exportToPDF = exportToPDF;
</script>

<script type="module">
// --- FIXES: Auth modal open, Enter submit, toggle password, PDF button wiring, quick date filters ---
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// Open auth modal from existing buttons if present
function openAuthModal() {
  const m = $('#auth-modal');
  if (!m) return;
  m.classList.add('show');
  m.style.display = 'flex';
  const email = $('#auth-email');
  if (email) setTimeout(()=> email.focus(), 50);
}
$('#btn-login')?.addEventListener('click', openAuthModal);
$('#btn-open-auth')?.addEventListener('click', openAuthModal);

// Ensure submit works with Enter on the form
const authForm = $('#auth-form');
if (authForm) {
  authForm.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      // let default submit run
    }
  });
}

// Toggle password visibility; prevent default to avoid form submit
$('#toggle-password')?.addEventListener('click', (e) => {
  e.preventDefault();
  const passInput = $('#auth-pass');
  const icon = $('#toggle-password i');
  if (!passInput || !icon) return;
  const isPassword = passInput.type === 'password';
  passInput.type = isPassword ? 'text' : 'password';
  icon.className = isPassword ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
});

// Wire PDF button if present
$('#download-pdf-btn')?.addEventListener('click', (e)=>{
  e.preventDefault();
  if (typeof window.exportToPDF === 'function') window.exportToPDF();
});

// --- Quick Date Filters for Reportes ---
function setDateInputs(range) {
  const start = $('#report-start-date');
  const end = $('#report-end-date');
  if (!start || !end) return;
  const today = new Date();
  const toISO = (d)=> d.toISOString().slice(0,10);

  let from = new Date(today);
  switch(range){
    case '1w': from.setDate(today.getDate()-7); break;
    case '15d': from.setDate(today.getDate()-15); break;
    case '1m': from.setMonth(today.getMonth()-1); break;
    case '3m': from.setMonth(today.getMonth()-3); break;
    case '6m': from.setMonth(today.getMonth()-6); break;
    case '1y': from.setFullYear(today.getFullYear()-1); break;
    case 'ytd':
      from = new Date(today.getFullYear(), 0, 1);
      break;
    default:
      from.setFullYear(today.getFullYear()-5); // all
  }
  start.value = toISO(from);
  end.value = toISO(today);
}

// Create buttons if not present
(function ensureQuickFilters(){
  const toolbarHost = document.querySelector('#reportes .card .card-header .card-title');
  // Add buttons row under the main filters card
  const filtersCard = document.querySelector('#reportes .card');
  if (!filtersCard) return;
  if (document.getElementById('report-quick-filters')) return;

  const bar = document.createElement('div');
  bar.id = 'report-quick-filters';
  bar.style = 'display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;';
  bar.innerHTML = `
    <button class="btn secondary" data-range="all">Todo</button>
    <button class="btn secondary" data-range="ytd">YTD</button>
    <button class="btn secondary" data-range="1w">1S</button>
    <button class="btn secondary" data-range="15d">15D</button>
    <button class="btn secondary" data-range="1m">1M</button>
    <button class="btn secondary" data-range="3m">3M</button>
    <button class="btn secondary" data-range="6m">6M</button>
    <button class="btn secondary" data-range="1y">1A</button>
    <button class="btn primary" id="apply-quick-range">Aplicar</button>
  `;
  // Insert after the inputs container (same first card)
  const inputsGrid = filtersCard.querySelector('[style*="grid"]');
  if (inputsGrid && inputsGrid.parentElement === filtersCard) {
    inputsGrid.insertAdjacentElement('afterend', bar);
  } else {
    filtersCard.appendChild(bar);
  }

  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-range]');
    if (!btn) return;
    // visual active state
    bar.querySelectorAll('button[data-range]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    setDateInputs(btn.getAttribute('data-range'));
  });

  document.getElementById('apply-quick-range')?.addEventListener('click', ()=>{
    // If your app has a "Generar" button, click it to refresh
    document.getElementById('generate-report-btn')?.click();
  });
})();
</script>


<script type="module">
// --- Single delegated listener for eye toggle (prevents double toggles) ---
document.addEventListener('click', (e) => {
  const btn = e.target.closest('#toggle-password');
  if (!btn) return;
  e.preventDefault();
  const passInput = document.querySelector('#auth-pass');
  const icon = btn.querySelector('i');
  if (!passInput || !icon) return;
  const isPassword = passInput.type === 'password';
  passInput.type = isPassword ? 'text' : 'password';
  icon.className = isPassword ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
});
</script>

</body>
</html>
