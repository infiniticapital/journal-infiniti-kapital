<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INFINITI KAPITAL - Journal Profesional</title>

  <meta property="og:title" content="Infiniti Kapital - Journal de Trading Profesional" />
  <meta property="og:description" content="Una herramienta profesional para registrar y analizar tus operaciones de trading." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://journal-infiniti-kapital.netlify.app/" />
  <meta property="og:image" content="https://journal-infiniti-kapital.netlify.app/logo-infiniti-kapital.jpg" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --primary:#0f172a; --secondary:#1e293b; --accent:#d4af37;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --card-bg:rgba(15,23,42,.86); --border:rgba(255,255,255,.12);
      --text:#f1f5f9; --muted:#94a3b8; --backdrop:rgba(0,0,0,.5);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      display:grid; grid-template-columns:260px 1fr; grid-template-rows:64px 1fr;
      grid-template-areas:"sidebar header" "sidebar main";
      font-family: sans-serif;
    }
    header{
      grid-area:header; display:flex; align-items:center; justify-content:space-between;
      background:var(--secondary); border-bottom:1px solid var(--border); padding:0 16px; z-index:20;
      position:sticky; top:0;
    }
    .left-h{display:flex; align-items:center; gap:12px}
    .date{color:var(--muted)}
    .user{display:flex; align-items:center; gap:12px}
    .avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#111;display:grid;place-items:center;font-weight:800}
    .burger{display:none; background:none; border:0; color:var(--text); font-size:22px; padding:8px; cursor:pointer}

    .sidebar{
      grid-area:sidebar; background:rgba(15,23,42,.96); border-right:1px solid var(--border);
      display:flex; flex-direction:column; height:100%; position:relative; z-index:30;
      transition:transform .3s ease;
    }
    .logo{padding:16px 18px; border-bottom:1px solid var(--border)}
    .logo img {
      width: 90%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .nav{padding:10px}
    .nav a,.nav button.nav-link{
      width:100%; display:flex; align-items:center; gap:12px;
      padding:12px; border-radius:10px; color:var(--muted);
      text-decoration:none; background:none; border:0; cursor:pointer;
      font-size: 15px;
    }
    .nav a:hover,.nav a.active,.nav button.nav-link[aria-expanded="true"]{
      color:var(--accent); background:rgba(212,175,55,.12);
    }
    .nav .icon{width:22px; text-align:center}

    .submenu{display:grid; gap:6px; padding:6px 0 6px 34px; max-height:0; overflow:hidden; transition:max-height .25s ease}
    .submenu a{padding:10px 12px; font-size: 14px;}
    .nav button.nav-link{justify-content:space-between}
    .caret{transform:rotate(-90deg); transition:transform .2s}
    .nav button.nav-link[aria-expanded="true"] .caret{transform:rotate(0deg)}
    .submenu.open{max-height:500px}

    main{
      grid-area:main; padding:20px; overflow:auto;
      display:grid; grid-template-columns:repeat(12,1fr); gap:18px; grid-auto-rows:minmax(100px,auto);
    }
    .card{background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.15)}
    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:14px}
    .card-title{font-size:1.1rem;font-weight:700}
    .btn-icon{background:none;border:0;color:var(--accent);cursor:pointer; font-size: 16px;}

    main > .section{
        display:none; 
        grid-column:1/-1; 
        grid-template-columns:inherit; 
        gap:inherit;
    }
    main > .section.active{
        display:grid;
    }
    .welcome{grid-column:span 8}
    .metrics{grid-column:span 4}
    .factor,.rr,.wins{grid-column:span 4}
    .dist{grid-column:span 6; grid-row:span 2}
    .recent{grid-column:span 6}
    .balance{grid-column:span 6}
    .risk{grid-column:span 6; grid-row:span 2}
    .news{grid-column:span 6}
    .challenge{grid-column:span 6}
    .chart{height:300px; margin-top:10px}

    .metric-card{background:rgba(30,41,59,.5); border-radius:10px; padding:12px; text-align:center}
    .metric-val{font-size:22px; font-weight:800; color:var(--accent)}
    .metric-lab{color:var(--muted); font-size:13px}

    .fab{
      position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:50%;
      background:var(--accent); color:#111; border:0; font-size:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:25;
    }

    .modal{
      display:none; position:fixed; inset:0; padding:20px; background:var(--backdrop);
      z-index:1000; align-items:center; justify-content:center;
    }
    .modal.show{display:flex!important}
    .modal-content{
      width:min(92vw,560px); max-height:85vh; overflow:auto;
      background:var(--card-bg); border:1px solid var(--accent); border-radius:16px; padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .modal-content.modal-lg{
      width: min(92vw, 900px);
    }
    .modal-header{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--accent); padding-bottom:10px; margin-bottom:14px}
    .modal-header h2{margin:0; color:var(--accent)}
    .close-modal{background:none;border:0;color:var(--muted);font-size:22px;cursor:pointer}
    .close-modal:hover{color:#fff}
    .form-group{margin-bottom:12px}
    .form-group label{display:block; margin-bottom: 4px; font-size: 14px; color: var(--muted);}
    .form-control, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:rgba(15,23,42,.6); color:var(--text); font-family: inherit; font-size: 1rem;
    }
    textarea{min-height: 80px;}
    .modal-footer{display:flex; justify-content:flex-end; gap:8px; margin-top:10px}
    .btn{border:0; border-radius:10px; padding:10px 14px; cursor:pointer}
    .btn:disabled {
        background-color: #334155;
        color: #64748b;
        cursor: not-allowed;
    }
    .btn.primary{background:var(--accent); color:#111}
    .btn.secondary{background:#334155; color:#fff}
    .btn-link{background:none; border:none; color:var(--accent); padding:0; text-decoration:underline; cursor:pointer;}
    .btn.secondary.active { background-color: var(--accent); color: var(--primary); }

    .drawer-backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:25}
    @media (max-width: 1024px){
      .welcome,.metrics,.dist,.recent,.balance,.risk,.news,.challenge,.factor,.rr,.wins { grid-column:1/-1 }
    }
    @media (max-width: 860px){
      body{ grid-template-columns:1fr; grid-template-areas:"header" "main"; }
      .sidebar{ position:fixed; left:0; top:0; bottom:0; transform:translateX(-100%); width:280px; max-width:85vw; }
      .burger{ display:inline-flex }
      body.sidebar-open .sidebar{ transform:translateX(0) }
      body.sidebar-open .drawer-backdrop{ display:block }
      main{ padding:16px }
    }
    @media (min-width: 768px) {
      [style*="md:grid-column: span 4"] { grid-column: span 4; }
      [style*="md:grid-column: span 8"] { grid-column: span 8; }
    }

    #calendar-container .fc-daygrid-day-frame {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 8px;
        height: 100%;
        position: relative;
    }
    #calendar-container .fc-daygrid-day-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 4px;
        text-align: right;
    }
    #calendar-container .fc-daygrid-day-number {
       font-size: 12px;
       padding-right: 4px;
    }
    .calendar-day-content {
        text-align: center;
    }
    .calendar-day-pnl {
        font-size: 1.2rem;
        font-weight: 700;
    }
    .calendar-day-trades {
        font-size: 0.8rem;
        color: var(--muted);
    }
    .fc-day-other .calendar-day-content, .fc-day-other .fc-daygrid-day-top {
        opacity: 0.3;
    }
    .fc .fc-toolbar.fc-header-toolbar {
        margin-bottom: 1.2em;
    }

    .hidden{display:none!important}
    .only-admin{display:none}
    body.is-admin .only-admin{display:block !important}
  </style>
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <img src="logo-infiniti-kapital.jpg" alt="Logo Infiniti Kapital">
    </div>
    <nav class="nav" id="nav">
      <a href="#" class="nav-item active" data-target="dashboard">
        <span class="icon"><i class="fa-solid fa-chart-line"></i></span>Dashboard</a>
      <button class="nav-link" aria-expanded="false" aria-controls="sm-cal">
        <span><span class="icon"><i class="fa-solid fa-calendar"></i></span> Calendario</span>
        <i class="fa-solid fa-caret-right caret" aria-hidden="true"></i>
      </button>
      <div id="sm-cal" class="submenu">
        <a href="#" data-target="calendario">Vista general</a>
        <a href="#" data-target="reportes">Reportes</a>
      </div>
      <button class="nav-link" aria-expanded="false" aria-controls="sm-acc">
        <span><span class="icon"><i class="fa-solid fa-wallet"></i></span> Cuentas</span>
        <i class="fa-solid fa-caret-right caret"></i>
      </button>
      <div id="sm-acc" class="submenu">
        <a href="#" data-target="cuentas">Gestión</a>
      </div>
      <button class="nav-link" aria-expanded="false" aria-controls="sm-op">
        <span><span class="icon"><i class="fa-solid fa-exchange-alt"></i></span> Operaciones</span>
        <i class="fa-solid fa-caret-right caret"></i>
      </button>
      <div id="sm-op" class="submenu">
        <a href="#" data-target="operaciones">Historial</a>
        <a href="#" id="quick-add-trade">Agregar operación</a>
      </div>
      <a href="#" class="nav-item" data-target="analiticas"><span class="icon"><i class="fa-solid fa-chart-bar"></i></span>Analíticas</a>
      <a href="#" class="nav-item" data-target="seguimiento"><span class="icon"><i class="fa-solid fa-tasks"></i></span>Seguimiento</a>
      <a href="#" class="nav-item" data-target="estrategias"><span class="icon"><i class="fa-solid fa-chess-knight"></i></span>Estrategias</a>
      <a href="#" class="nav-item" data-target="configuracion"><span class="icon"><i class="fa-solid fa-cog"></i></span>Configuración</a>
      <a href="#" class="nav-item only-admin" data-target="admin">
        <span class="icon"><i class="fa-solid fa-shield-halved"></i></span> Admin
      </a>
    </nav>
  </aside>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <header>
    <div class="left-h">
      <button class="burger" id="burger" aria-label="Abrir menú" aria-expanded="false"><i class="fa-solid fa-bars"></i></button>
      <div class="date"><i class="fa-solid fa-calendar"></i> <span id="current-date"></span></div>
    </div>
    <div class="user">
      <div class="avatar">AT</div>
      <div class="user-name">Invitado</div>
      <button class="btn-icon" id="btn-login" title="Iniciar sesión"><i class="fa-regular fa-user"></i></button>
      <button class="btn-icon hidden" id="btn-logout" title="Cerrar sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
  </header>

  <main id="app">
    <section id="dashboard" class="section active">
     <div class="card welcome">
        <div class="card-header"><div class="card-title" id="welcome-title">Bienvenido</div></div>
        <p id="welcome-message" style="color:var(--muted)">Inicia sesión para guardar tus operaciones en la nube.</p>
        <button class="btn primary" style="margin-top:10px" id="btn-open-auth"><i class="fa-solid fa-right-to-bracket"></i> Acceder</button>
      </div>
      <div class="card metrics">
        <div class="card-header"><div class="card-title">Resumen</div></div>
        <div class="metric-card">
            <div style="display: flex; justify-content: center; align-items: baseline; gap: 8px;">
                <div class="metric-val" id="total-profit">$0.00</div>
                <div id="total-profit-percent" style="font-weight: 700; font-size: 1.1rem; color: var(--muted);">(0.0%)</div>
            </div>
            <div class="metric-lab">Beneficio Total</div>
        </div>
        <div class="metric-card" style="margin-top:10px"><div class="metric-val" id="win-rate">0%</div><div class="metric-lab">Tasa de Acierto</div></div>
      </div>
      <div class="card factor"><div class="card-header"><div class="card-title">Factor</div></div><div class="metric-card"><div class="metric-val" id="profit-factor">0.00</div><div class="metric-lab">Operaciones: <span id="total-trades">0</span></div></div></div>
      <div class="card rr"><div class="card-header"><div class="card-title">R/B</div></div><div class="metric-card"><div class="metric-val" id="risk-reward">0.00</div><div class="metric-lab">Promedio</div></div></div>
      <div class="card wins"><div class="card-header"><div class="card-title">Ganadoras</div></div><div class="metric-card"><div class="metric-val" id="win-trades">0</div><div class="metric-lab">de <span id="total-trades-2">0</span></div></div></div>
      <div class="card dist">
        <div class="card-header"><div class="card-title">Distribución</div><button class="btn-icon" id="refresh-distribution"><i class="fa-solid fa-rotate"></i></button></div>
        <div class="chart"><canvas id="distributionChart"></canvas></div>
      </div>
      <div class="card recent">
        <div class="card-header"><div class="card-title">Recientes</div><button class="btn-icon" id="add-trade-btn"><i class="fa-solid fa-plus"></i></button></div>
        <div id="recent-trades-container" style="color:var(--muted)">Sin registros.</div>
      </div>
      <div class="card balance">
        <div class="card-header">
            <div class="card-title">Saldo</div>
            <div>
                <span id="balance-growth-percent" style="font-weight:700; margin-right: 10px;">+0.00%</span>
                <button class="btn-icon" id="expand-balance-chart"><i class="fa-solid fa-expand"></i></button>
            </div>
        </div>
        <div class="chart"><canvas id="balanceChart"></canvas></div>
      </div>
      <div class="card risk">
        <div class="card-header">
            <div class="card-title">Riesgo</div>
            <button class="btn-icon" id="export-risk"><i class="fa-solid fa-file-export"></i></button>
        </div>
        <div class="metric-card" style="margin-bottom: 14px;">
            <div class="metric-val" id="risk-profit-percent">0.00%</div>
            <div class="metric-lab">Beneficio / Pérdida (Periodo)</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
            <div class="metric-card">
                <div class="metric-val" id="daily-risk">0.0%</div>
                <div class="metric-lab">Diario</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="weekly-risk">0.0%</div>
                <div class="metric-lab">Semanal</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="monthly-risk">0.0%</div>
                <div class="metric-lab">Mensual</div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px">
            <div class="metric-card">
                <div class="metric-val" id="max-win-streak" style="color: var(--success);">0</div>
                <div class="metric-lab">Máx. Racha Ganadora</div>
            </div>
            <div class="metric-card">
                <div class="metric-val" id="max-loss-streak" style="color: var(--danger);">0</div>
                <div class="metric-lab">Máx. Racha Perdedora</div>
            </div>
        </div>
        <div class="chart" style="height: 200px;"><canvas id="riskChart"></canvas></div>
      </div>
      <div class="card news" style="height: 450px; padding: 0; overflow: hidden;">
        <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
          <div id="tradingview_f928c" style="height: 100%; width: 100%;"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
          new TradingView.widget(
          {
            "autosize": true,
            "symbol": "FX:EURUSD",
            "interval": "60",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "es",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_f928c"
          }
          );
          </script>
        </div>
      </div>
      <div class="card news">
        <div class="card-header">
          <div class="card-title">Calendario Económico</div>
        </div>
        <div class="card-body" style="padding: 0; height: 450px;">
          <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
            <div class="tradingview-widget-container__widget" style="height: 100%; width: 100%;"></div>
            <script async src="https://s3.tradingview.com/external-embedding/embed-widget-events.js">
            {
              "width": "100%",
              "height": "100%",
              "locale": "es",
              "colorTheme": "dark",
              "isTransparent": true,
              "importanceFilter": "0,1"
            }
            </script>
          </div>
        </div>
      </div>
      <div class="card challenge"><div class="card-header"><div class="card-title">FTMO Challenge</div><button class="btn-icon" id="edit-challenge"><i class="fa-solid fa-pen"></i></button></div>
        <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <span>Progreso</span><span id="challenge-progress-value">0%</span>
            </div>
            <div style="height:10px;background:#334155;border-radius:6px;overflow:hidden"><div id="challenge-progress-bar" style="height:100%;width:0%;background:var(--success)"></div></div>

            <div class="metric-card" style="margin-top: 10px;">
           <div class="metric-val" id="challenge-current-balance">$0.00</div>
           <div class="metric-lab">Saldo Actual</div>
        </div>

            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
                <div class="metric-card"><div class="metric-val" id="challenge-profit">+0.0%</div><div class="metric-lab">Beneficio</div></div>
                <div class="metric-card"><div class="metric-val" id="challenge-drawdown">0.0%</div><div class="metric-lab">Drawdown Total</div></div>
                <div class="metric-card"><div class="metric-val" id="challenge-trades">0</div><div class="metric-lab">Operaciones</div></div>
                <div class="metric-card"><div class="metric-val" id="challenge-win-rate">0%</div><div class="metric-lab">Acierto</div></div>
            </div>
            
            <div class="metric-card" style="margin-top: 10px; border: 1px solid var(--warning);">
                <div class="metric-val" id="challenge-residual-risk">0.00%</div>
                <div class="metric-lab">Riesgo Residual Diario</div>
            </div>
        </div>
      </div> 
    
    </section>

    <section id="calendario" class="section">
      <div class="card" style="grid-column:1/-1">
        <div class="card-header">
          <div class="card-title">Calendario de Operaciones</div>
        </div>
        <div id='calendar-container' style="min-height: 600px;"></div>
      </div>
    </section>
    
    <section id="reportes" class="section">
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div class="card-title">Generador de Reportes</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; align-items: flex-end;">
          <div class="form-group">
            <label for="report-account-select">Seleccionar Cuenta</label>
            <select id="report-account-select" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="report-start-date">Fecha de Inicio</label>
            <input type="date" id="report-start-date" class="form-control">
          </div>
          <div class="form-group">
            <label for="report-end-date">Fecha de Fin</label>
            <input type="date" id="report-end-date" class="form-control">
          </div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn primary" id="generate-report-btn" style="flex-grow: 1;">Generar</button>
            <button class="btn secondary" id="download-csv-btn" title="Descargar CSV" disabled><i class="fa-solid fa-file-csv"></i> CSV</button>
            <button class="btn secondary" id="download-excel-btn" title="Descargar Excel" disabled><i class="fa-solid fa-file-excel"></i> Excel</button>
            <button class="btn secondary" id="download-pdf-btn" title="Descargar PDF" disabled><i class="fa-solid fa-file-pdf"></i> PDF</button>
        </div>
        <div id="report-loader" class="hidden" style="margin-top: 15px; text-align: center; color: var(--muted);">
          <i class="fa-solid fa-spinner fa-spin"></i> Generando reporte...
        </div>
      </div>
      <div id="report-results" class="hidden" style="grid-column: 1 / -1; display:contents;">
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-total-profit" class="metric-val">$0.00</div><div class="metric-lab">Beneficio Neto</div></div></div>
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-total-trades" class="metric-val">0</div><div class="metric-lab">Operaciones</div></div></div>
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-win-rate" class="metric-val">0%</div><div class="metric-lab">Tasa de Acierto</div></div></div>
        <div class="card" style="grid-column: span 3;"><div class="metric-card"><div id="report-profit-factor" class="metric-val">0.00</div><div class="metric-lab">Profit Factor</div></div></div>
        <div class="card" style="grid-column: 1 / -1;">
          <div class="card-header"><div class="card-title">Detalle de Operaciones</div></div>
          <div style="overflow-x:auto;">
            <table id="report-table" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="padding:10px; text-align:left; color:var(--muted);">Fecha</th>
                        <th style="padding:10px; text-align:left; color:var(--muted);">Símbolo</th>
                        <th style="padding:10px; text-align:left; color:var(--muted);">Tipo</th>
                        <th style="padding:10px; text-align:right; color:var(--muted);">Resultado ($)</th>
                        <th style="padding:10px; text-align:right; color:var(--muted);">Lotes</th>
                        <th style="padding:10px; text-align:left; color:var(--muted);">Estrategia/Setup</th>
                    </tr>
                </thead>
                <tbody id="report-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="cuentas" class="section">
        <div class="card" style="grid-column:1/-1">
            <div class="card-header">
                <div class="card-title">Gestión de Cuentas</div>
            </div>
            <div id="accounts-container"></div>
        </div>
    </section>
    
    <section id="operaciones" class="section">
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                <div class="card-title">Análisis de Volumen por Símbolo</div>
                <div id="history-filter-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn secondary active" data-range="all">Todo</button>
                    <button class="btn secondary" data-range="1y">1A</button>
                    <button class="btn secondary" data-range="6m">6M</button>
                    <button class="btn secondary" data-range="3m">3M</button>
                    <button class="btn secondary" data-range="1m">1M</button>
                    <button class="btn secondary" data-range="15d">15D</button>
                    <button class="btn secondary" data-range="1w">1S</button>
                </div>
                </div>
    
            <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; margin-top: 20px;">
                <div style="grid-column: span 12; md:grid-column: span 4; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="symbol-volume-chart"></canvas>
                </div>
    
                <div style="grid-column: span 12; md:grid-column: span 8; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="padding: 10px; text-align: left; color: var(--muted);">Símbolo</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Beneficio Neto</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Resultado Prom.</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Volumen %</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Operaciones</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Ganancias (%)</th>
                                <th style="padding: 10px; text-align: right; color: var(--muted);">Pérdidas (%)</th>
                            </tr>
                        </thead>
                        <tbody id="history-summary-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
            <div class="card-header">
                <div class="card-title">Historial de Operaciones Detallado</div>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <th style="padding: 10px; text-align: left; color: var(--muted);">Fecha</th>
                            <th style="padding: 10px; text-align: left; color: var(--muted);">Activo</th>
                            <th style="padding: 10px; text-align: left; color: var(--muted);">Tipo</th>
                            <th style="padding: 10px; text-align: right; color: var(--muted);">Lotaje</th>
                            <th style="padding: 10px; text-align: right; color: var(--muted);">Resultado ($)</th>
                            <th style="padding: 10px; text-align: center; color: var(--muted);">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-history-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </section>
    
    <section id="analiticas" class="section">
      <div class="card" style="grid-column: 1 / -1; margin-bottom: -10px;">
        <div class="form-group">
          <label for="analytics-strategy-filter">Filtrar por Estrategia</label>
          <select id="analytics-strategy-filter" class="form-control"></select>
        </div>
      </div>
    
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Beneficio Neto</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-total-profit">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Tasa de Acierto</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-win-rate">0%</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Profit Factor</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-profit-factor">0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">R/B Promedio</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-rr">0.00</div></div>
      </div>
    
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Beneficio Promedio</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-avg-win" style="color:var(--success)">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Pérdida Promedio</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-avg-loss" style="color:var(--danger)">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Expectativa</div></div>
        <div class="metric-card"><div class="metric-val" id="analytics-expectancy">$0.00</div></div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div class="card-header"><div class="card-title">Drawdown Máximo</div></div>
        <div class="metric-card">
          <div class="metric-val" id="analytics-max-dd" style="color: var(--warning);">$0.00</div>
          <div class="metric-lab" id="analytics-max-dd-percent">0.00%</div>
        </div>
      </div>
      
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header"><div class="card-title">Curva de Capital</div></div>
        <div class="chart" style="height: 400px;">
          <canvas id="equityCurveChart"></canvas>
        </div>
      </div>
    </section>
    
    <section id="seguimiento" class="section">
       <div class="card" style="grid-column: span 6;">
        <div class="card-header"><div class="card-title">Metas Semanales</div></div>
        <div class="form-group">
            <label>Objetivo de Beneficio ($)</label>
            <input id="weekly-goal-input" type="number" class="form-control" placeholder="Ej: 1500">
        </div>
        <div class="form-group">
            <label>Progreso Actual</label>
            <div style="height:10px;background:#334155;border-radius:6px;overflow:hidden; margin-top: 4px;">
                <div id="weekly-progress-bar" style="height:100%;width:0%;background:var(--success); transition: width 0.5s ease;"></div>
            </div>
        </div>
    </div>       
      <div class="card" style="grid-column: span 6;">
            <div class="card-header"><div class="card-title">Checklist del Trader</div></div>
            <div class="form-group">
                <label style="display:flex; align-items:center; gap: 8px;"><input type="checkbox" id="checklist-calendar" style="width: 18px; height: 18px;"> Revisé el calendario económico</label>
                <label style="display:flex; align-items:center; gap: 8px; margin-top: 8px;"><input type="checkbox" id="checklist-plan" style="width: 18px; height: 18px;"> Seguí mi plan de trading al 100%</label>
                <label style="display:flex; align-items:center; gap: 8px; margin-top: 8px;"><input type="checkbox" id="checklist-revenge" style="width: 18px; height: 18px;"> No operé por venganza (revenge trading)</label>
            </div>
        </div>
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header"><div class="card-title">Notas de la Sesión</div></div>
            <textarea id="session-note-textarea" class="form-control" placeholder="¿Cómo te sentiste hoy? ¿Qué aprendiste?"></textarea>
            <input type="hidden" id="editing-note-id" />
            <div style="text-align: right; margin-top: 10px;">
                <button id="btn-save-note" class="btn primary">Guardar Nota</button>
            </div>
        </div>
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header"><div class="card-title">Historial de Notas</div></div>
            <div id="notes-history-container" style="color: var(--muted);">
                No hay notas guardadas.
            </div>
        </div>
    </section>
    
    <section id="estrategias" class="section">
      <div class="card" style="grid-column:1/-1">
        <div class="card-header">
            <div class="card-title">Gestión de Estrategias</div>
        </div>
        <div id="strategies-container"></div>
      </div>
    </section>

    <section id="configuracion" class="section">
        <div class="card" style="grid-column:1/-1">
            <div class="card-header">
                <div class="card-title">Configuración General</div>
            </div>
            <div class="form-group">
                <label>Saldo Inicial por Defecto ($)</label>
                <input id="settings-initial-balance" type="number" class="form-control" placeholder="10000" />
                <small style="color: var(--muted); display: block; margin-top: 4px;">Este valor se usará como punto de partida para el gráfico de Saldo en el Dashboard.</small>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn primary" id="save-general-settings-btn">Guardar Configuración</button>
            </div>
        </div>

        <div class="card" style="grid-column:1/-1; margin-top: 20px;">
            <div class="card-header">
                <div class="card-title">Mi Perfil</div>
            </div>
            <div class="form-group">
                <label>Nombre a Mostrar</label>
                <input id="profile-name-input" type="text" class="form-control" placeholder="Tu nombre y apellido" />
                <small style="color: var(--muted); display: block; margin-top: 4px;">Este es el nombre que aparecerá en la esquina superior derecha.</small>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn primary" id="save-profile-btn">Guardar Cambios</button>
            </div>
        </div>

        <div class="card" style="grid-column:1/-1; margin-top: 20px;">
            <div class="card-header">
              <div class="card-title">Conexión con MT5 (API Key)</div>
            </div>
            <p style="color: var(--muted); margin-bottom: 15px;">Usa la siguiente clave en la configuración de tu bot de MT5 para registrar operaciones automáticamente.</p>
            <div id="api-key-display" style="background: var(--secondary); padding: 12px; border-radius: 8px; font-family: monospace; margin-bottom: 15px; min-height: 45px;">
              Cargando...
            </div>
            <button id="btn-generate-api-key" class="btn primary">Generar / Mostrar Clave</button>
        </div>
    </section>
    
    <section id="admin" class="section">
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div class="card-title">Panel de Administración</div>
          <button class="btn primary" id="btn-refresh-users"><i class="fa-solid fa-rotate"></i> Actualizar Usuarios</button>
        </div>
        <div class="card" style="margin-bottom:14px">
          <div class="card-title" style="margin-bottom:8px">Usuarios</div>
          <div style="overflow:auto">
            <table style="width:100%; border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Email</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Nombre</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Rol</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Acciones</th>
                </tr>
              </thead>
              <tbody id="admin-users-tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="card" style="margin-bottom:14px">
            <div class="card-header">
                <div class="card-title">Códigos de Invitación</div>
                <button class="btn primary" id="btn-generate-invite"><i class="fa-solid fa-plus"></i> Generar Nuevo Código</button>
            </div>
            <p style="color: var(--muted); margin-bottom: 15px;">Estos son los códigos de un solo uso para registrar nuevos usuarios. Una vez que se usan, se desactivan.</p>
            <div id="invite-codes-list" style="display: flex; flex-direction: column; gap: 8px;">Cargando códigos...</div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:8px">Detalle de Usuario</div>
          <div id="admin-user-detail" style="color:var(--muted)">Selecciona un usuario…</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px">
            <div class="card">
              <div class="card-title">Cuentas</div>
              <div id="admin-user-accounts" style="color:var(--muted)">—</div>
            </div>
            <div class="card">
              <div class="card-title">Trades</div>
              <div id="admin-user-trades" style="color:var(--muted)">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <button class="fab" id="floating-add-trade-btn" aria-label="Agregar operación"><i class="fa-solid fa-plus"></i></button>

  <div id="balance-chart-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Curva de Saldo</h2>
            <button class="close-modal" data-close>&times;</button>
        </div>
        <div class="modal-body" style="height: 60vh;">
            <canvas id="modalBalanceChart"></canvas>
        </div>
    </div>
  </div>

  <div id="ai-response-modal" class="modal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h2><i class="fa-solid fa-brain" style="margin-right: 8px;"></i> Evaluación de Estrategia con IA</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body" id="ai-response-body" style="white-space: pre-wrap; line-height: 1.6;">
        Generando evaluación...
      </div>
    </div>
  </div>

 <div id="add-trade-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trade-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="trade-title">Agregar Operación</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Fecha de Operación</label>
                <input id="trade-date-input" type="date" class="form-control" />
            </div>

            <div class="form-group" style="grid-column: 1 / -1;"><label>Par / Activo</label>
              <select id="trade-pair-input" class="form-control">
                <optgroup label="Pares Mayores (Majors)">
                    <option value="EURUSD">EUR/USD</option>
                    <option value="GBPUSD">GBP/USD</option>
                    <option value="USDJPY">USD/JPY</option>
                    <option value="USDCAD">USD/CAD</option>
                    <option value="AUDUSD">AUD/USD</option>
                    <option value="NZDUSD">NZD/USD</option>
                    <option value="USDCHF">USD/CHF</option>
                </optgroup>
                <optgroup label="Índices">
                    <option value="US30">US30 (Dow Jones)</option>
                    <option value="NAS100">NAS100 (Nasdaq)</option>
                    <option value="SPX500">SPX500 (S&P 500)</option>
                    <option value="GER30">GER30 (DAX)</option>
                    <option value="UK100">UK100 (FTSE 100)</option>
                </optgroup>
                <optgroup label="Criptomonedas">
                    <option value="BTCUSD">BTC/USD</option>
                    <option value="ETHUSD">ETH/USD</option>
                    <option value="XRPUSD">XRP/USD</option>
                </optgroup>
                <optgroup label="Materias Primas">
                    <option value="XAUUSD">XAU/USD (Oro)</option>
                    <option value="XAGUSD">XAG/USD (Plata)</option>
                    <option value="USOIL">USOIL (Petróleo WTI)</option>
                </optgroup>
              </select>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="trade-account-input">Cuenta Asociada</label>
                <select id="trade-account-input" class="form-control">
                    </select>
            </div>
            <div class="form-group"><label>Tipo</label>
              <select id="trade-type-input" class="form-control"><option value="buy">Compra</option><option value="sell">Venta</option></select>
            </div>
            <div class="form-group"><label>Resultado ($)</label>
              <input id="trade-result-input" type="number" class="form-control" placeholder="Ej: 250.50" step="0.01" />
            </div>

            <div class="form-group"><label>Lotaje</label>
              <input id="trade-lots-input" type="number" class="form-control" placeholder="Ej: 1.50" step="0.01" />
            </div>
            <div class="form-group"><label>Precio de Entrada</label>
              <input id="trade-entry-price-input" type="number" class="form-control" placeholder="Ej: 1.07500" step="0.00001" />
            </div>
            <div class="form-group"><label>Take Profit (Precio)</label>
              <input id="trade-tp-input" type="number" class="form-control" placeholder="Ej: 1.08500" step="0.00001" />
            </div>
            <div class="form-group"><label>Stop Loss (Precio)</label>
              <input id="trade-sl-input" type="number" class="form-control" placeholder="Ej: 1.07000" step="0.00001" />
            </div>

            <div class="form-group"><label>Riesgo (% del capital)</label>
              <input id="trade-risk-input" type="number" class="form-control" placeholder="Ej: 1.0" step="0.1" min="0.1" max="10" />
            </div>
            <div class="form-group"><label>Beneficio Esperado (%)</label>
              <input id="trade-reward-input" type="number" class="form-control" placeholder="Ej: 3.0" step="0.1" min="0.1" />
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label for="trade-strategy-input">Estrategia</label>
                <select id="trade-strategy-input" class="form-control">
                    <option value="">Ninguna</option>
                </select>
            </div>
            <div class="form-group">
                <label for="trade-session-input">Sesión de Trading</label>
                <select id="trade-session-input" class="form-control">
                    <option value="N/A">N/A</option>
                    <option value="Asia">Asia</option>
                    <option value="London">Londres</option>
                    <option value="NY">New York</option>
                </select>
            </div>
        </div>
        <div class="form-group"><label>Pertenece al Challenge</label>
          <select id="trade-challenge-input" class="form-control"><option value="yes">Sí</option><option value="no">No</option></select>
        </div>
        <input type="hidden" id="editing-trade-id" />
      </div>
      <div class="modal-footer">
        <button class="btn secondary" data-close>Cancelar</button>
        <button class="btn primary" id="save-trade-btn">Guardar Operación</button>
      </div>
    </div>
</div>
  <div id="add-account-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="acc-title">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="acc-title">Agregar Nueva Cuenta</h2>
          <button class="close-modal" data-close>&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group"><label>Nombre</label><input id="account-name" class="form-control" placeholder="Ej: Cuenta Principal" /></div>
          <div class="form-group"><label>Broker</label><input id="account-broker" class="form-control" placeholder="Ej: FTMO, Pepperstone" /></div>
          <div class="form-group"><label>Saldo ($)</label><input id="account-balance" type="number" class="form-control" placeholder="Ej: 10000.00" step="0.01" /></div>
          <div class="form-group"><label>Tipo</label>
            <select id="account-type" class="form-control"><option value="principal">Principal</option><option value="challenge">Challenge</option><option value="personal">Personal</option></select>
          </div>
          <input type="hidden" id="editing-account-id" />
        </div>
        <div class="modal-footer">
          <button class="btn secondary" data-close>Cancelar</button>
          <button class="btn primary" id="save-account-btn">Guardar Cuenta</button>
        </div>
      </div>
  </div>
  <div id="add-strategy-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="strategy-title">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="strategy-title">Agregar Nueva Estrategia</h2>
          <button class="close-modal" data-close>&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Nombre de la Estrategia</label>
            <input id="strategy-name" class="form-control" placeholder="Ej: Ruptura de Resistencia" />
          </div>
          <div class="form-group">
            <label>Descripción (Opcional)</label>
            <textarea id="strategy-desc" class="form-control" placeholder="Añade notas sobre las confirmaciones, reglas, etc."></textarea>
          </div>
          <input type="hidden" id="editing-strategy-id" />
        </div>
        <div class="modal-footer">
          <button class="btn secondary" data-close>Cancelar</button>
          <button class="btn primary" id="save-strategy-btn">Guardar Estrategia</button>
        </div>
      </div>
  </div>
  <div id="challenge-settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="challenge-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="challenge-title">Configurar Challenge</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Saldo Inicial ($)</label>
          <input id="challenge-balance" type="number" class="form-control" placeholder="100000" />
        </div>
        <div class="form-group">
          <label>Objetivo de Beneficio (%)</label>
          <input id="challenge-target" type="number" class="form-control" placeholder="10" />
        </div>
        <div class="form-group">
          <label>Límite de Pérdida Máxima (%)</label>
          <input id="challenge-max-loss" type="number" class="form-control" placeholder="10" />
        </div>
        <div class="form-group">
          <label>Límite de Pérdida Diaria (%)</label>
          <input id="challenge-daily-loss" type="number" class="form-control" placeholder="5" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" data-close>Cancelar</button>
        <button class="btn primary" id="save-challenge-settings-btn">Guardar Ajustes</button>
      </div>
    </div>
  </div>
  <div id="auth-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="auth-title">Acceso</h2>
            <button class="close-modal" data-close>&times;</button>
        </div>
        <form id="auth-form">
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input id="auth-email" type="email" class="form-control" placeholder="tu@correo.com" required />
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <div style="position: relative; display: flex; align-items: center;">
                        <input id="auth-pass" type="password" class="form-control" placeholder="••••••••" required />
                        <button type="button" id="toggle-password" style="position: absolute; right: 10px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px;">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group hidden" id="auth-name-wrap">
                    <label>Nombre</label>
                    <input id="auth-name" class="form-control" placeholder="Tu nombre" />
                </div>
                <div class="form-group hidden" id="auth-invite-wrap">
                    <label>Código de Invitación</label>
                    <input id="auth-invite" class="form-control" placeholder="Código secreto" />
                </div>
                <div id="auth-error" class="hidden" style="margin-top:8px;color:var(--danger)"></div>
            </div>
            <div class="modal-footer" style="justify-content:space-between">
                <div>
                    <button type="button" class="btn-link" id="forgot-password-btn">¿Olvidaste tu contraseña?</button>
                </div>
                <div>
                    <button type="button" class="btn secondary" data-close>Cancelar</button>
                    <button class="btn primary" type="submit" id="auth-submit">Entrar</button>
                </div>
            </div>
        </form>
        <div style="text-align: center; margin-top: 15px;">
            <button type="button" class="btn-link" id="auth-toggle-mode">Crear cuenta</button>
        </div>
    </div>
</div>

<script>
// Bloque de script para inicialización y DOM (sin lógica de datos)
document.addEventListener('DOMContentLoaded', () => {
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let distributionChart, balanceChart, riskChart, modalBalanceChart, equityCurveChart, symbolVolumeChart;
    
    function setDate() {
        const el = $('#current-date');
        if (el) el.textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    }

    function initCharts() {
        const d = $('#distributionChart'); if (d) distributionChart = new Chart(d.getContext('2d'), { type: 'bar', data: { labels: ['Win', 'Loss', 'BE'], datasets: [{ label: 'Operaciones', data: [0, 0, 0], backgroundColor: ['rgba(16,185,129,.7)', 'rgba(239,68,68,.7)', 'rgba(156,163,175,.7)'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        const b = $('#balanceChart'); if (b) balanceChart = new Chart(b.getContext('2d'), { type: 'line', data: { datasets: [{ label: 'Saldo', data: [], borderColor: 'rgba(212,175,55,1)', backgroundColor: 'rgba(212,175,55,.15)', fill: true, tension: .3 }] }, options: { responsive: true, maintainAspectRatio: false } });
        const r = $('#riskChart'); if (r) riskChart = new Chart(r.getContext('2d'), { type: 'radar', data: { labels: ['Gestión', 'Consistencia', 'Acierto', 'R/B', 'DD', 'Beneficio'], datasets: [{ label: 'Perfil de Riesgo', data: [0, 0, 0, 0, 0, 0], backgroundColor: 'rgba(212,175,55,.2)', borderColor: 'rgba(212,175,55,1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 5, stepSize: 1 } } } });
        const mB = $('#modalBalanceChart'); if (mB) modalBalanceChart = new Chart(mB.getContext('2d'), { type: 'line', data: { datasets: [{ label: 'Saldo', data: [], borderColor: 'rgba(212,175,55,1)', backgroundColor: 'rgba(212,175,55,.15)', fill: true, tension: .3 }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function setActiveSection(id) {
        $$('main > .section').forEach(section => section.classList.remove('active'));
        const targetSection = $(`#${id}`);
        if (targetSection) targetSection.classList.add('active');

        $$('.nav > a.nav-item, .submenu > a').forEach(link => {
            const isActive = link.dataset.target === id;
            link.classList.toggle('active', isActive);
            if (isActive) {
                const parentSubmenu = link.closest('.submenu');
                if (parentSubmenu) {
                    const button = $(`[aria-controls="${parentSubmenu.id}"]`);
                    if (button) button.setAttribute('aria-expanded', 'true');
                    parentSubmenu.classList.add('open');
                }
            }
        });

        if (id === 'calendario' && window.calendar) {
            setTimeout(() => { window.calendar.updateSize() }, 50);
        }
    }

    setDate();
    initCharts();

    // Eventos de navegación (reubicados aquí para claridad)
    $$('.nav a[data-target], .submenu a[data-target]').forEach(a => a.addEventListener('click', e => {
        e.preventDefault();
        const id = a.dataset.target;
        if (id) setActiveSection(id);
    }));
});
</script>
  
<script type="module">
// ----- SCRIPT PRINCIPAL CON TODA LA LÓGICA DE LA APLICACIÓN -----

import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  signOut, updateProfile,
  sendPasswordResetEmail, createUserWithEmailAndPassword
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, updateDoc, deleteDoc, where
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

document.addEventListener('DOMContentLoaded', () => {

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    
    const firebaseConfig = {
        apiKey: "AIzaSyCuS-0g97JluGH6FTF5JBmwaW7d5aJ3WWw",
        authDomain: "journal-infiniti-kapital.firebaseapp.com",
        projectId: "journal-infiniti-kapital",
        storageBucket: "journal-infiniti-kapital.firebasestorage.app",
        messagingSenderId: "78211615687",
        appId: "1:78211615687:web:02b05ba83acd46c8c6e7e2",
        measurementId: "G-D0ERFPMLGQ"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app);

    window.auth = auth;
    window.db = db;
    let lastReportData = [];
    let authMode = 'login';

    async function saveAccount(accountData) {
        const user = auth.currentUser;
        if (!user) throw new Error("Debes iniciar sesión para guardar una cuenta.");
        const dataToSave = {
            name: accountData.name || "Cuenta sin nombre",
            broker: accountData.broker || "",
            balance: parseFloat(accountData.balance) || 0,
            type: accountData.type || "personal"
        };
        if (accountData.id) {
            await updateDoc(doc(db, "users", user.uid, "accounts", accountData.id), dataToSave);
        } else {
            dataToSave.createdAt = serverTimestamp();
            await addDoc(collection(db, "users", user.uid, "accounts"), dataToSave);
        }
    }

    async function saveStrategy(strategyData) {
        const user = auth.currentUser;
        if (!user) throw new Error("Debes iniciar sesión para guardar una estrategia.");
        const dataToSave = { name: strategyData.name || "Estrategia sin nombre", desc: strategyData.desc || "" };
        if (strategyData.id) {
            dataToSave.updatedAt = serverTimestamp();
            await updateDoc(doc(db, "users", user.uid, "strategies", strategyData.id), dataToSave);
        } else {
            dataToSave.createdAt = serverTimestamp();
            await addDoc(collection(db, "users", user.uid, "strategies"), dataToSave);
        }
    }

    window.saveGeneralSettings = async function(settings) {
        const user = auth.currentUser; if (!user) return;
        await setDoc(doc(db, 'users', user.uid, 'settings', 'general'), settings, { merge: true });
        alert('Configuración guardada.');
    }

    async function deleteItem(collectionName, id) {
      const user = auth.currentUser; if (!user || !id) return;
      if (confirm(`¿Estás seguro de que quieres eliminar este elemento?`)) {
        await deleteDoc(doc(db, 'users', user.uid, collectionName, id));
      }
    }

    function calculateStreaks(trades) {
        let maxWinningStreak = 0, currentWinningStreak = 0, maxLosingStreak = 0, currentLosingStreak = 0;
        (trades || []).forEach(trade => {
            const r = Number(trade?.result ?? 0);
            if (r > 0) { currentWinningStreak++; currentLosingStreak = 0; }
            else if (r < 0) { currentLosingStreak++; currentWinningStreak = 0; }
            if (currentWinningStreak > maxWinningStreak) maxWinningStreak = currentWinningStreak;
            if (currentLosingStreak > maxLosingStreak) maxLosingStreak = currentLosingStreak;
        });
        return { maxWinningStreak, maxLosingStreak };
    }

    function calculateDrawdown(trades, initialBalance) {
        let peakEquity = initialBalance || 0, currentEquity = initialBalance || 0, maxDrawdownValue = 0;
        (trades || []).forEach(t => {
          currentEquity += Number(t?.result ?? 0);
          if (currentEquity > peakEquity) peakEquity = currentEquity;
          const dd = peakEquity - currentEquity;
          if (dd > maxDrawdownValue) maxDrawdownValue = dd;
        });
        const maxDrawdownPercent = (initialBalance > 0) ? (maxDrawdownValue / initialBalance) * 100 : 0;
        return { maxDrawdownValue, maxDrawdownPercent };
    }

    function calculateReportStats(trades, initialBalance) {
        const t = trades || [], wins = t.filter(x => Number(x?.result ?? 0) > 0), losses = t.filter(x => Number(x?.result ?? 0) < 0);
        const grossProfit = wins.reduce((s, x) => s + Number(x?.result ?? 0), 0);
        const grossLoss = losses.reduce((s, x) => s + Number(x?.result ?? 0), 0);
        const netProfit = grossProfit + grossLoss, profitFactor = Math.abs(grossLoss) > 0 ? (grossProfit / Math.abs(grossLoss)) : 0;
        const streaks = calculateStreaks(t), drawdown = calculateDrawdown(t, initialBalance || 0);
        return {
          netProfit, finalBalance: (initialBalance || 0) + netProfit, totalTrades: t.length,
          winRate: t.length ? (wins.length / t.length) * 100 : 0,
          grossProfit, grossLoss, profitFactor,
          maxWinningStreak: streaks.maxWinningStreak, maxLosingStreak: streaks.maxLosingStreak,
          maxDrawdownValue: drawdown.maxDrawdownValue, maxDrawdownPercent: drawdown.maxDrawdownPercent
        };
    }

    function updateAccountsUI(accounts) {
        const el = $('#accounts-container'); if (!el) return;
        el.innerHTML = '';
        const addAccountButton = document.createElement('div');
        addAccountButton.className = 'btn primary';
        addAccountButton.style = "display:inline-flex; align-items:center; gap:8px; margin-bottom: 20px; cursor: pointer;";
        addAccountButton.innerHTML = `<i class="fa-solid fa-plus"></i> Agregar Cuenta`;
        addAccountButton.onclick = () => {
            $('#acc-title').textContent = 'Agregar Nueva Cuenta';
            $('#add-account-modal form')?.reset();
            $('#editing-account-id').value = '';
            openModalById('add-account-modal');
        };
        el.appendChild(addAccountButton);
        if (!accounts || accounts.length === 0) {
            el.innerHTML += '<p style="color: var(--muted);">Aún no tienes cuentas.</p>';
            return;
        }
        const trades = window.__currentTrades || [];
        accounts.forEach(a => {
            const card = document.createElement('div'); card.className = 'card'; card.style.marginTop = '10px';
            const initialBalance = parseFloat(a.balance) || 0;
            const accountTrades = trades.filter(t => t.accountId === a.id || t.account === a.id);
            const profit = accountTrades.reduce((sum, t) => sum + (t.result || 0), 0);
            const dynamicBalance = initialBalance + profit, profitColor = profit >= 0 ? 'var(--success)' : 'var(--danger)';
            card.innerHTML = `<div class="card-header"><div class="card-title">${a.name||'Cuenta'}</div><div><button class="btn-icon btn-edit-account" data-id="${a.id}"><i class="fa-solid fa-pen"></i></button><button class="btn-icon btn-delete-account" data-id="${a.id}"><i class="fa-solid fa-trash"></i></button></div></div><div class="metric-card"><div style="display:flex;justify-content:center;align-items:baseline;gap:8px;"><div class="metric-val">$${dynamicBalance.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div><div style="font-weight:700;color:${profitColor};">(${(profit>=0?'+':'')}${profit.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})})</div></div><div class="metric-lab">${a.broker||'N/A'} - (${a.type||'N/A'})</div><div style="font-size:12px;color:var(--muted);margin-top:4px;">Inicial: $${initialBalance.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>`;
            el.appendChild(card);
        });
    }

    // (El resto de tus funciones de renderizado, cálculo, etc., van aquí...)

    window.updateAllCalculations = () => {
        const allTrades = window.__currentTrades || [], settings = window.__currentSettings || {};
        const selectedStrategyId = $('#analytics-strategy-filter').value;
        const filteredTrades = selectedStrategyId ? allTrades.filter(t => t.strategyId === selectedStrategyId) : allTrades;
        // Llama a todas tus funciones de actualización aquí...
        updateAccountsUI(window.__currentAccounts);
    };

    let unsubscribes = [];
    function cleanupListeners() { unsubscribes.forEach(unsub => unsub && unsub()); unsubscribes = []; }
    function bindSelfRealtime(uid) {
        cleanupListeners();
        const tradesRef = collection(db, 'users', uid, 'trades');
        const unsubTrades = onSnapshot(query(tradesRef, orderBy('createdAt','asc')), snap => {
            window.__currentTrades = snap.docs.map(d=>({id:d.id,...d.data()}));
            window.updateAllCalculations();
        });
        const accountsRef = collection(db, 'users', uid, 'accounts');
        const unsubAccounts = onSnapshot(query(accountsRef, orderBy('createdAt', 'desc')), snap => {
            window.__currentAccounts = snap.docs.map(d=>({id:d.id,...d.data()}));
            updateAccountsUI(window.__currentAccounts);
            // ... y poblar otros dropdowns
        });
        unsubscribes.push(unsubTrades, unsubAccounts);
    }
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            $('.user-name').textContent = user.displayName || user.email;
            $('.avatar').textContent = (user.displayName || 'U').substring(0,2).toUpperCase();
            $('#btn-login, #btn-open-auth').forEach(el => el.classList.add('hidden'));
            $('#btn-logout').classList.remove('hidden');
            bindSelfRealtime(user.uid);
        } else {
            cleanupListeners();
            $('.user-name').textContent = 'Invitado';
            $('.avatar').textContent = 'AT';
            $('#btn-login, #btn-open-auth').forEach(el => el.classList.remove('hidden'));
            $('#btn-logout').classList.add('hidden');
            window.__currentTrades = []; window.__currentAccounts = [];
            updateAccountsUI([]);
            // ... (resetear más UI)
        }
    });
    
    function openModalById(id) { $(`#${id}`)?.classList.add('show'); document.body.style.overflow = 'hidden'; }
    function closeAllModals() { $$('.modal').forEach(m => m.classList.remove('show')); document.body.style.overflow = ''; }
    function updateAccountsDropdown() {
        const select = $('#trade-account-input'); if(!select) return;
        select.innerHTML = '<option value="">-- Selecciona una Cuenta --</option>';
        (window.__currentAccounts||[]).forEach(acc => {
            const opt = document.createElement('option');
            opt.value = acc.id;
            opt.textContent = `${acc.name} (${acc.broker})`;
            select.appendChild(opt);
        });
    }

    document.body.addEventListener('click', async (e) => {
        if (e.target.matches('[data-close]') || e.target.classList.contains('modal')) closeAllModals();

        if (e.target.closest('#add-trade-btn, #floating-add-trade-btn, #quick-add-trade')) {
            e.preventDefault();
            $('#trade-title').textContent = 'Agregar Operación';
            $('#add-trade-modal form')?.reset();
            $('#editing-trade-id').value = '';
            $('#trade-date-input').value = new Date().toISOString().slice(0, 10);
            updateAccountsDropdown();
            openModalById('add-trade-modal');
        }

        const editTradeBtn = e.target.closest('.btn-edit-trade');
        if (editTradeBtn) {
            const trade = window.__currentTrades?.find(t => t.id === editTradeBtn.dataset.id);
            if (trade) {
                updateAccountsDropdown();
                $('#trade-title').textContent = 'Editar Operación';
                $('#editing-trade-id').value = trade.id;
                $('#trade-account-input').value = trade.account || trade.accountId || "";
                $('#trade-date-input').value = trade.dateStr || '';
                // ... (llenar todos los demás campos)
                openModalById('add-trade-modal');
            }
        }
        
        const deleteTradeBtn = e.target.closest('.btn-delete-trade');
        if (deleteTradeBtn) deleteItem('trades', deleteTradeBtn.dataset.id);

        const editAccountBtn = e.target.closest('.btn-edit-account');
        if (editAccountBtn) {
            const account = window.__currentAccounts?.find(a => a.id === editAccountBtn.dataset.id);
            if(account) {
                 $('#acc-title').textContent = 'Editar Cuenta'; 
                 $('#account-name').value = account.name;
                 $('#account-broker').value = account.broker;
                 $('#account-balance').value = account.balance;
                 $('#account-type').value = account.type;
                 $('#editing-account-id').value = account.id; 
                 openModalById('add-account-modal');
            }
        }
        
        const deleteAccountBtn = e.target.closest('.btn-delete-account');
        if (deleteAccountBtn) deleteItem('accounts', deleteAccountBtn.dataset.id);

        if (e.target.closest('#btn-login, #btn-open-auth')) {
             setAuthMode('login'); openModalById('auth-modal');
        }
        if (e.target.matches('#auth-toggle-mode')) {
             authMode = authMode === 'login' ? 'register' : 'login';
             setAuthMode(authMode);
        }
        if(e.target.closest('#toggle-password')) {
            e.preventDefault();
            const passInput = $('#auth-pass'); const icon = $('#toggle-password i');
            const isPassword = passInput.type === 'password';
            passInput.type = isPassword ? 'text' : 'password';
            icon.className = `fa-solid ${isPassword ? 'fa-eye-slash' : 'fa-eye'}`;
        }
    });
    
    function setAuthMode(mode){
      $('#auth-title').textContent = mode==='login' ? 'Iniciar Sesión' : 'Crear Cuenta';
      $('#auth-toggle-mode').textContent = mode==='login' ? 'Crear cuenta' : 'Ya tengo cuenta';
      $('#auth-name-wrap').classList.toggle('hidden', mode !== 'register');
      $('#auth-invite-wrap').classList.toggle('hidden', mode !== 'register');
      $('#auth-submit').textContent = mode ==='login' ? 'Entrar' : 'Registrar';
    }

    $('#auth-form').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const email = $('#auth-email').value, pass = $('#auth-pass').value;
      const name = $('#auth-name').value, inviteCode = $('#auth-invite').value;
      const errEl = $('#auth-error'); errEl.classList.add('hidden');
      try {
        if (authMode === 'login') {
          await signInWithEmailAndPassword(auth, email, pass);
        } else {
          if (!name || !inviteCode) throw new Error("Nombre y código son requeridos.");
          const createUser = httpsCallable(functions, 'createUserWithInvite');
          await createUser({ email, password: pass, displayName: name, inviteCode });
          await signInWithEmailAndPassword(auth, email, pass);
        }
        closeAllModals();
      } catch (err) {
        errEl.textContent = err.message;
        errEl.classList.remove('hidden');
      }
    });

    $('#save-trade-btn')?.addEventListener('click', async (e) => {
        const button = e.currentTarget; button.disabled = true; button.textContent = 'Guardando...';
        try {
            const editingId = $('#editing-trade-id').value;
            const selectedAccountId = $('#trade-account-input').value;
            if (!selectedAccountId) throw new Error('Por favor, selecciona una cuenta.');
            const tradeData = {
                account: selectedAccountId, dateStr: $('#trade-date-input').value,
                pair: $('#trade-pair-input').value, type: $('#trade-type-input').value,
                result: $('#trade-result-input').value, strategy: $('#trade-strategy-input').value,
                // ... (recolectar todos los demás campos)
            };
            const token = await auth.currentUser.getIdToken();
            const endpoint = editingId ? 'editManualTrade' : 'addManualTrade';
            if(editingId) tradeData.tradeId = editingId;

            const response = await fetch(`https://us-central1-journal-infiniti-kapital.cloudfunctions.net/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(tradeData)
            });
            if (!response.ok) throw new Error((await response.json()).message || 'Error del servidor.');
            alert(`Operación ${editingId ? 'actualizada' : 'guardada'} con éxito.`);
            closeAllModals();
        } catch (error) {
            alert('Hubo un error: ' + error.message);
        } finally {
            button.disabled = false; button.textContent = 'Guardar Operación';
        }
    });

    $('#save-account-btn')?.addEventListener('click', async () => {
        const data = {
            id: $('#editing-account-id').value, name: $('#account-name').value.trim(),
            broker: $('#account-broker').value.trim(), balance: $('#account-balance').value,
            type: $('#account-type').value
        };
        if (!data.name) return alert('El nombre es requerido.');
        try { await saveAccount(data); closeAllModals(); } 
        catch (e) { alert('Error: ' + e.message); }
    });

    // ... (El resto de tus listeners para guardar estrategia, settings, etc.)

    $('#download-pdf-btn').addEventListener('click', async () => {
        const trades = lastReportData;
        if (!trades.length) { return alert('Primero genera un reporte.'); }
        const accountId = $('#report-account-select').value;
        const account = window.__currentAccounts?.find(a => a.id === accountId);
        if(!account) { return alert('Selecciona una cuenta válida.'); }
        
        const initialBalance = parseFloat(account.balance) || 0;
        const stats = calculateReportStats(trades, initialBalance);
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); doc.text("Reporte de Rendimiento", 14, 22);
        // ... (Tu lógica completa para construir el PDF va aquí)
        
        const body = trades.map(t => [ t.dateStr, t.pair, t.type, t.result.toFixed(2) ]);
        doc.autoTable({ head: [['Fecha', 'Símbolo', 'Tipo', 'Resultado ($)']], body, startY: 60 });
        doc.save(`reporte_${account.name}.pdf`);
    });

}); // Fin del DOMContentLoaded
</script>

</body>
</html>
