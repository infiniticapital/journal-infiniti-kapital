<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>INFINITI KAPITAL - Journal Profesional</title>

  <!-- Iconos y Chart.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#0f172a; --secondary:#1e293b; --accent:#d4af37;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --card-bg:rgba(15,23,42,.86); --border:rgba(255,255,255,.12);
      --text:#f1f5f9; --muted:#94a3b8; --backdrop:rgba(0,0,0,.5);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      display:grid; grid-template-columns:260px 1fr; grid-template-rows:64px 1fr;
      grid-template-areas:"sidebar header" "sidebar main";
    }

    /* Header */
    header{
      grid-area:header; display:flex; align-items:center; justify-content:space-between;
      background:var(--secondary); border-bottom:1px solid var(--border); padding:0 16px; z-index:20;
      position:sticky; top:0;
    }
    .left-h{display:flex; align-items:center; gap:12px}
    .date{color:var(--muted)}
    .user{display:flex; align-items:center; gap:12px}
    .avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);color:#111;display:grid;place-items:center;font-weight:800}
    .burger{display:none; background:none; border:0; color:var(--text); font-size:22px; padding:8px; cursor:pointer}

    /* Sidebar */
    .sidebar{
      grid-area:sidebar; background:rgba(15,23,42,.96); border-right:1px solid var(--border);
      display:flex; flex-direction:column; height:100%; position:relative; z-index:30;
      transition:transform .3s ease;
    }
    .logo{padding:16px 18px; border-bottom:1px solid var(--border)}
    .logo .inf{font-size:20px;font-weight:800;letter-spacing:.5px}
    .logo .kap{font-size:18px;font-weight:800;color:var(--accent)}

    .nav{padding:10px}
    .nav a,.nav button.nav-link{
      width:100%; display:flex; align-items:center; gap:12px;
      padding:12px; border-radius:10px; color:var(--muted);
      text-decoration:none; background:none; border:0; cursor:pointer;
    }
    .nav a:hover,.nav a.active,.nav button.nav-link[aria-expanded="true"]{
      color:var(--accent); background:rgba(212,175,55,.12);
    }
    .nav .icon{width:22px; text-align:center}

    /* Submenús */
    .submenu{display:grid; gap:6px; padding:6px 0 6px 34px; max-height:0; overflow:hidden; transition:max-height .25s ease}
    .submenu a{padding:10px 12px}
    .nav button.nav-link{justify-content:space-between}
    .caret{transform:rotate(-90deg); transition:transform .2s}
    .nav button.nav-link[aria-expanded="true"] .caret{transform:rotate(0deg)}
    .submenu.open{max-height:500px}

    /* Main */
    main{
      grid-area:main; padding:20px; overflow:auto;
      display:grid; grid-template-columns:repeat(12,1fr); gap:18px; grid-auto-rows:minmax(100px,auto);
    }
    .card{background:var(--card-bg); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.15)}
    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:14px}
    .card-title{font-size:1.1rem;font-weight:700}
    .btn-icon{background:none;border:0;color:var(--accent);cursor:pointer}

    .section{display:none; grid-column:1/-1; grid-template-columns:repeat(12,1fr); gap:18px}
    .section.active{display:grid}
    .welcome{grid-column:span 8}
    .metrics{grid-column:span 4}
    .factor,.rr,.wins{grid-column:span 4}
    .dist{grid-column:span 6; grid-row:span 2}
    .recent{grid-column:span 6}
    .balance{grid-column:span 6}
    .risk{grid-column:span 6; grid-row:span 2}
    .news{grid-column:span 6}
    .challenge{grid-column:span 6}
    .chart{height:300px; margin-top:10px}

    .metric-card{background:rgba(30,41,59,.5); border-radius:10px; padding:12px; text-align:center}
    .metric-val{font-size:22px; font-weight:800; color:var(--accent)}
    .metric-lab{color:var(--muted); font-size:13px}

    /* Floating */
    .fab{
      position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:50%;
      background:var(--accent); color:#111; border:0; font-size:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:25;
    }

    /* MODALES */
    .modal{
      display:none; position:fixed; inset:0; padding:20px; background:var(--backdrop);
      z-index:1000; align-items:center; justify-content:center;
    }
    .modal.show{display:flex!important}
    .modal-content{
      width:min(92vw,560px); max-height:85vh; overflow:auto;
      background:var(--card-bg); border:1px solid var(--accent); border-radius:16px; padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .modal-header{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--accent); padding-bottom:10px; margin-bottom:14px}
    .modal-header h2{margin:0; color:var(--accent)}
    .close-modal{background:none;border:0;color:var(--muted);font-size:22px;cursor:pointer}
    .close-modal:hover{color:#fff}
    .form-group{margin:10px 0}
    .form-control, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:rgba(15,23,42,.6); color:var(--text)
    }
    .modal-footer{display:flex; justify-content:flex-end; gap:8px; margin-top:10px}
    .btn{border:0; border-radius:10px; padding:10px 14px; cursor:pointer}
    .btn.primary{background:var(--accent); color:#111}
    .btn.secondary{background:#334155; color:#fff}

    /* Drawer móvil */
    .drawer-backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:25}
    @media (max-width: 1024px){
      .welcome,.metrics,.dist,.recent,.balance,.risk,.news,.challenge,.factor,.rr,.wins { grid-column:1/-1 }
    }
    @media (max-width: 860px){
      body{ grid-template-columns:1fr; grid-template-areas:"header" "main"; }
      .sidebar{ position:fixed; left:0; top:0; bottom:0; transform:translateX(-100%); width:280px; max-width:85vw; }
      .burger{ display:inline-flex }
      body.sidebar-open .sidebar{ transform:translateX(0) }
      body.sidebar-open .drawer-backdrop{ display:block }
      main{ padding:16px }
    }

    /* Multiusuario/Admin */
    .hidden{display:none!important}
    .only-admin{display:none}
    .is-admin .only-admin{display:block}
  </style>
</head>
<body>

  <!-- Sidebar / Drawer -->
  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <div class="inf">INFINITI</div>
      <div class="kap">KAPITAL</div>
    </div>

    <nav class="nav" id="nav">
      <a href="#" class="nav-item active" data-target="dashboard">
        <span class="icon"><i class="fa-solid fa-chart-line"></i></span>Dashboard</a>

      <!-- Submenú Calendario -->
      <button class="nav-link" aria-expanded="false" aria-controls="sm-cal">
        <span><span class="icon"><i class="fa-solid fa-calendar"></i></span> Calendario</span>
        <i class="fa-solid fa-caret-right caret" aria-hidden="true"></i>
      </button>
      <div id="sm-cal" class="submenu">
        <a href="#" data-target="calendario">Vista general</a>
        <a href="#" data-target="reportes">Reportes</a>
      </div>

      <!-- Submenú Cuentas -->
      <button class="nav-link" aria-expanded="false" aria-controls="sm-acc">
        <span><span class="icon"><i class="fa-solid fa-wallet"></i></span> Cuentas</span>
        <i class="fa-solid fa-caret-right caret"></i>
      </button>
      <div id="sm-acc" class="submenu">
        <a href="#" data-target="cuentas">Gestión</a>
      </div>

      <!-- Submenú Operaciones -->
      <button class="nav-link" aria-expanded="false" aria-controls="sm-op">
        <span><span class="icon"><i class="fa-solid fa-exchange-alt"></i></span> Operaciones</span>
        <i class="fa-solid fa-caret-right caret"></i>
      </button>
      <div id="sm-op" class="submenu">
        <a href="#" data-target="operaciones">Historial</a>
        <a href="#" id="quick-add-trade">Agregar operación</a>
      </div>

      <a href="#" class="nav-item" data-target="analiticas"><span class="icon"><i class="fa-solid fa-chart-bar"></i></span>Analíticas</a>
      <a href="#" class="nav-item" data-target="seguimiento"><span class="icon"><i class="fa-solid fa-tasks"></i></span>Seguimiento</a>
      <a href="#" class="nav-item" data-target="estrategias"><span class="icon"><i class="fa-solid fa-chess-knight"></i></span>Estrategias</a>
      <a href="#" class="nav-item" data-target="configuracion"><span class="icon"><i class="fa-solid fa-cog"></i></span>Configuración</a>

      <!-- Link Panel Admin -->
      <a href="#" class="nav-item only-admin" data-target="admin">
        <span class="icon"><i class="fa-solid fa-shield-halved"></i></span> Admin
      </a>
    </nav>
  </aside>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <!-- Header -->
  <header>
    <div class="left-h">
      <button class="burger" id="burger" aria-label="Abrir menú" aria-expanded="false"><i class="fa-solid fa-bars"></i></button>
      <div class="date"><i class="fa-solid fa-calendar"></i> <span id="current-date"></span></div>
    </div>
    <div class="user">
      <div class="avatar">AT</div>
      <div class="user-name">Invitado</div>
      <button class="btn-icon" id="btn-login" title="Iniciar sesión"><i class="fa-regular fa-user"></i></button>
      <button class="btn-icon hidden" id="btn-logout" title="Cerrar sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
  </header>

  <!-- Main -->
  <main id="app">
    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="card welcome">
        <div class="card-header"><div class="card-title">Bienvenido</div></div>
        <p id="welcome-message" style="color:var(--muted)">Inicia sesión para guardar tus operaciones en la nube.</p>
        <button class="btn primary" style="margin-top:10px" id="btn-open-auth"><i class="fa-solid fa-right-to-bracket"></i> Acceder</button>
      </div>

      <div class="card metrics">
        <div class="card-header"><div class="card-title">Resumen</div></div>
        <div class="metric-card"><div class="metric-val" id="total-profit">$0.00</div><div class="metric-lab">Beneficio Total</div></div>
        <div class="metric-card" style="margin-top:10px"><div class="metric-val" id="win-rate">0%</</div><div class="metric-lab">Tasa de Acierto</div></div>
      </div>

      <div class="card factor"><div class="card-header"><div class="card-title">Factor</div></div><div class="metric-card"><div class="metric-val" id="profit-factor">0.00</div><div class="metric-lab">Operaciones: <span id="total-trades">0</span></div></div></div>
      <div class="card rr"><div class="card-header"><div class="card-title">R/B</div></div><div class="metric-card"><div class="metric-val" id="risk-reward">0.00</div><div class="metric-lab">Promedio</div></div></div>
      <div class="card wins"><div class="card-header"><div class="card-title">Ganadoras</div></div><div class="metric-card"><div class="metric-val" id="win-trades">0</div><div class="metric-lab">de <span id="total-trades-2">0</span></div></div></div>

      <div class="card dist">
        <div class="card-header"><div class="card-title">Distribución</div><button class="btn-icon" id="refresh-distribution"><i class="fa-solid fa-rotate"></i></button></div>
        <div class="chart"><canvas id="distributionChart"></canvas></div>
      </div>

      <div class="card recent">
        <div class="card-header"><div class="card-title">Recientes</div><button class="btn-icon" id="add-trade-btn"><i class="fa-solid fa-plus"></i></button></div>
        <div id="recent-trades-container" style="color:var(--muted)">Sin registros.</div>
      </div>

      <div class="card balance">
        <div class="card-header"><div class="card-title">Saldo</div><button class="btn-icon"><i class="fa-solid fa-expand"></i></button></div>
        <div class="chart"><canvas id="balanceChart"></canvas></div>
      </div>

      <div class="card risk">
        <div class="card-header"><div class="card-title">Riesgo</div><button class="btn-icon" id="export-risk"><i class="fa-solid fa-file-export"></i></button></div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
          <div class="metric-card"><div class="metric-val" id="daily-risk">0.0%</div><div class="metric-lab">Diario</div></div>
          <div class="metric-card"><div class="metric-val" id="weekly-risk">0.0%</div><div class="metric-lab">Semanal</div></div>
          <div class="metric-card"><div class="metric-val" id="monthly-risk">0.0%</div><div class="metric-lab">Mensual</div></div>
        </div>
        <div class="chart"><canvas id="riskChart"></canvas></div>
      </div>

      <div class="card news"><div class="card-header"><div class="card-title">Calendario Económico</div></div><p style="color:var(--muted)">Próximos eventos...</p></div>
      <div class="card challenge"><div class="card-header"><div class="card-title">FTMO Challenge</div><button class="btn-icon" id="edit-challenge"><i class="fa-solid fa-pen"></i></button></div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <span>Progreso</span><span id="challenge-progress-value">0%</span>
          </div>
          <div style="height:10px;background:#334155;border-radius:6px;overflow:hidden"><div id="challenge-progress-bar" style="height:100%;width:0%;background:var(--success)"></div></div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
            <div class="metric-card"><div class="metric-val" id="challenge-profit">+0.0%</div><div class="metric-lab">Beneficio</div></div>
            <div class="metric-card"><div class="metric-val" id="challenge-drawdown">0.0%</div><div class="metric-lab">Drawdown</div></div>
            <div class="metric-card"><div class="metric-val" id="challenge-trades">0</div><div class="metric-lab">Operaciones</div></div>
            <div class="metric-card"><div class="metric-val" id="challenge-win-rate">0%</div><div class="metric-lab">Acierto</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- OTRAS SECCIONES -->
    <section id="calendario" class="section"><div class="card" style="grid-column:1/-1"><div class="card-title">Calendario</div><div class="chart"><canvas id="calendarioChart"></canvas></div></div></section>
    <section id="cuentas" class="section"><div class="card" style="grid-column:1/-1"><div class="card-header"><div class="card-title">Gestión de Cuentas</div><button class="btn-icon" id="add-account-btn"><i class="fa-solid fa-plus"></i></button></div><div id="accounts-container" style="color:var(--muted)">Sin cuentas.</div></div></section>
    <section id="operaciones" class="section"><div class="card" style="grid-column:1/-1"><div class="card-title">Historial</div><div class="chart"><canvas id="operacionesChart"></canvas></div></div></section>
    <section id="analiticas" class="section"><div class="card" style="grid-column:1/-1"><div class="card-title">Analíticas</div><div class="chart"><canvas id="analiticasChart"></canvas></div></div></section>
    <section id="seguimiento" class="section"><div class="card" style="grid-column:1/-1"><div class="card-title">Seguimiento</div><div class="chart"><canvas id="seguimientoChart"></canvas></div></div></section>
    <section id="estrategias" class="section"><div class="card" style="grid-column:1/-1"><div class="card-title">Estrategias</div></section>
    <section id="configuracion" class="section"><div class="card" style="grid-column:1/-1"><div class="card-title">Configuración</div><p style="color:var(--muted)">Preferencias...</p></div></section>

    <!-- PANEL ADMIN -->
    <section id="admin" class="section only-admin">
      <div class="card" style="grid-column:1/-1">
        <div class="card-header">
          <div class="card-title">Panel de Administración</div>
          <div><button class="btn primary" id="btn-refresh-users"><i class="fa-solid fa-rotate"></i> Actualizar</button></div>
        </div>

        <div class="card" style="margin-bottom:14px">
          <div class="card-title" style="margin-bottom:8px">Usuarios</div>
          <div style="overflow:auto">
            <table style="width:100%; border-collapse:collapse">
              <thead style="color:var(--muted)">
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">UID</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Nombre</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Email</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Rol</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Acciones</th>
                </tr>
              </thead>
              <tbody id="admin-users-tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-title" style="margin-bottom:8px">Detalle de Usuario</div>
          <div id="admin-user-detail" style="color:var(--muted)">Selecciona un usuario…</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px">
            <div class="card">
              <div class="card-title">Cuentas</div>
              <div id="admin-user-accounts" style="color:var(--muted)">—</div>
            </div>
            <div class="card">
              <div class="card-title">Trades</div>
              <div id="admin-user-trades" style="color:var(--muted)">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FAB -->
  <button class="fab" id="floating-add-trade-btn" aria-label="Agregar operación"><i class="fa-solid fa-plus"></i></button>

  <!-- MODAL: OPERACIÓN -->
  <div id="add-trade-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trade-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="trade-title">Agregar Operación</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label>Par</label>
          <select id="trade-pair-input" class="form-control">
            <option value="EURUSD">EUR/USD</option><option value="GBPUSD">GBP/USD</option><option value="USDJPY">USD/JPY</option>
          </select></div>
        <div class="form-group"><label>Tipo</label>
          <select id="trade-type-input" class="form-control"><option value="buy">Compra</option><option value="sell">Venta</option></select></div>
        <div class="form-group"><label>Resultado ($)</label><input id="trade-result-input" type="number" class="form-control" placeholder="Ej: 250.50" step="0.01" /></div>
        <div class="form-group"><label>Riesgo (% del capital)</label><input id="trade-risk-input" type="number" class="form-control" placeholder="Ej: 1.0" step="0.1" min="0.1" max="10" /></div>
        <div class="form-group"><label>Beneficio Esperado (%)</label><input id="trade-reward-input" type="number" class="form-control" placeholder="Ej: 3.0" step="0.1" min="0.1" /></div>
        <div class="form-group"><label>Pertenece al Challenge</label>
          <select id="trade-challenge" class="form-control"><option value="yes">Sí</option><option value="no">No</option></select></div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" data-close>Cancelar</button>
        <button class="btn primary" id="save-trade-btn">Guardar Operación</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CUENTA -->
  <div id="add-account-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="acc-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="acc-title">Agregar Nueva Cuenta</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label>Nombre</label><input id="account-name" class="form-control" placeholder="Ej: Cuenta Principal" /></div>
        <div class="form-group"><label>Saldo ($)</label><input id="account-balance" type="number" class="form-control" placeholder="Ej: 10000.00" step="0.01" /></div>
        <div class="form-group"><label>Tipo</label>
          <select id="account-type" class="form-control"><option value="principal">Principal</option><option value="challenge">Challenge</option><option value="personal">Personal</option></select>
        </div>
        <input type="hidden" id="editing-account-id" />
      </div>
      <div class="modal-footer">
        <button class="btn secondary" data-close>Cancelar</button>
        <button class="btn primary" id="save-account-btn">Guardar Cuenta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: AUTH -->
  <div id="auth-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="auth-title">Acceso</h2>
        <button class="close-modal" data-close>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Email</label>
          <input id="auth-email" type="email" class="form-control" placeholder="tu@correo.com" />
        </div>
        <div class="form-group">
          <label>Contraseña</label>
          <input id="auth-pass" type="password" class="form-control" placeholder="••••••••" />
        </div>
        <div class="form-group" id="auth-name-wrap" style="display:none">
          <label>Nombre</label>
          <input id="auth-name" class="form-control" placeholder="Tu nombre" />
        </div>
        <div id="auth-error" class="hidden" style="margin-top:8px;color:var(--danger)"></div>
      </div>
      <div class="modal-footer" style="justify-content:space-between">
        <div>
          <button class="btn secondary" id="auth-toggle-mode">Crear cuenta</button>
        </div>
        <div>
          <button class="btn secondary" data-close>Cancelar</button>
          <button class="btn primary" id="auth-submit">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== JS UI (no-module) ===== -->
  <script>
    // Helpers
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // Fecha
    function setDate(){ $('#current-date').textContent = new Date().toLocaleDateString('es-ES',{weekday:'long',day:'2-digit',month:'long',year:'numeric'}) }

    // Charts
    let distributionChart, balanceChart, riskChart;
    function initCharts(){
      const d = $('#distributionChart'); if (d) distributionChart = new Chart(d.getContext('2d'),{type:'bar',
        data:{labels:['Win','Loss','BE'],datasets:[{data:[0,0,0],backgroundColor:['rgba(16,185,129,.7)','rgba(239,68,68,.7)','rgba(156,163,175,.7)']}]},
        options:{responsive:true,maintainAspectRatio:false}});
      const b = $('#balanceChart'); if (b) balanceChart = new Chart(b.getContext('2d'),{type:'line',
        data:{labels:['D1','D2','D3','D4','D5','D6','Hoy'],datasets:[{data:[10000,10000,10000,10000,10000,10000,10000],borderColor:'rgba(212,175,55,1)',backgroundColor:'rgba(212,175,55,.15)',fill:true,tension:.3}]} ,
        options:{responsive:true,maintainAspectRatio:false}});
      const r = $('#riskChart'); if (r) riskChart = new Chart(r.getContext('2d'),{type:'radar',
        data:{labels:['Gestión','Consistencia','Acierto','R/B','DD','Beneficio'],datasets:[{data:[0,0,0,0,0,0],backgroundColor:'rgba(212,175,55,.2)',borderColor:'rgba(212,175,55,1)'}]},
        options:{responsive:true,maintainAspectRatio:false}});
    }

    // Drawer móvil
    (function(){
      const burger = document.getElementById('burger');
      const backdrop = document.getElementById('drawerBackdrop');
      const open = ()=>{ document.body.classList.add('sidebar-open'); burger?.setAttribute('aria-expanded','true'); document.body.style.overflow='hidden'; };
      const close= ()=>{ document.body.classList.remove('sidebar-open'); burger?.setAttribute('aria-expanded','false'); document.body.style.overflow=''; };
      const toggle=()=> document.body.classList.contains('sidebar-open') ? close() : open();
      burger?.addEventListener('click', toggle);
      backdrop?.addEventListener('click', close);
      window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      // Cerrar al navegar desde sidebar
      document.querySelectorAll('.nav a,[data-target]').forEach(el=>{
        el.addEventListener('click', ()=>{ if (window.matchMedia('(max-width:860px)').matches) close(); });
      });
    })();

    // Navegación/secciones + submenús
    function setActiveSection(id){
      $$('.section').forEach(s=>s.classList.remove('active'));
      const tgt = document.getElementById(id); if (tgt) tgt.classList.add('active');
      $$('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.target===id));
    }
    function restoreAccordionState(){
      const state = JSON.parse(sessionStorage.getItem('nav-acc-state') || '{}');
      Object.entries(state).forEach(([id,open])=>{
        const panel = document.getElementById(id);
        const btn = document.querySelector('[aria-controls="'+id+'"]');
        if (panel && btn){ panel.classList.toggle('open', !!open); btn.setAttribute('aria-expanded', !!open); }
      });
    }
    function persistAccordionState(){
      const state = {}; $$('.submenu').forEach(p => { state[p.id] = p.classList.contains('open'); });
      sessionStorage.setItem('nav-acc-state', JSON.stringify(state));
    }

    // Modales util
    function openModalById(id){ document.getElementById(id)?.classList.add('show'); document.body.style.overflow='hidden'; }
    function closeAllModals(){ $$('.modal').forEach(m=>m.classList.remove('show')); document.body.style.overflow=''; }

    // Estado demo local (si no hay login)
    window.__local = {
      tradingData:{ totalProfit:0, winRate:0, profitFactor:0, riskRewardRatio:0, winTrades:0, totalTrades:0,
        dailyRisk:0, weeklyRisk:0, monthlyRisk:0, challenge:{progress:0,profit:0,drawdown:0,trades:0,winRate:0}, trades:[] },
      accounts:[]
    };

    function updateRecentTrades(trades){
      const el = $('#recent-trades-container');
      if (!el) return;
      if (!trades || !trades.length){ el.textContent='Sin registros.'; return; }
      el.innerHTML = trades.slice(0,4).map(t=>{
        const sign = (t.result||0)>=0?'+':'-';
        const col  = (t.result||0)>=0? 'var(--success)' : 'var(--danger)';
        return `<div>${t.pair} · ${String(t.type||'').toUpperCase()} · <b style="color:${col}">${sign}$${Math.abs(t.result||0).toFixed(2)}</b> · ${t.dateStr||''}</div>`;
      }).join('');
    }
    function updateAccountsUI(accounts){
      const el = $('#accounts-container'); if (!el) return;
      let html = `<div class="btn primary" id="add-account-card" style="display:inline-flex;align-items:center;gap:8px"><i class="fa-solid fa-plus"></i> Agregar Cuenta</div>`;
      (accounts||[]).forEach(a=>{
        html += `<div class="card" style="margin-top:10px">
          <div class="card-header"><div class="card-title">${a.name||'Cuenta'}</div></div>
          <div class="metric-card"><div class="metric-val">$${(a.balance||0).toFixed(2)}</div><div class="metric-lab">${a.type||'—'}</div></div></div>`;
      });
      el.innerHTML = html;
      $('#add-account-card')?.addEventListener('click',()=>openModalById('add-account-modal'));
    }

    // Recalcula tarjetas top a partir de trades
    function recalcFromTrades(trades){
      const t = trades||[];
      const wins = t.filter(x=>x.result>0), losses = t.filter(x=>x.result<0);
      const total = t.length;
      const totalWins = wins.reduce((s,x)=>s+x.result,0);
      const totalLoss = Math.abs(losses.reduce((s,x)=>s+x.result,0));
      const winRate = total? (wins.length/total)*100 : 0;
      const pf = totalLoss? totalWins/totalLoss : 0;
      const rr = (wins.length && losses.length)? (totalWins/wins.length)/(totalLoss/losses.length) : 0;

      $('#total-trades').textContent = total;
      $('#total-trades-2').textContent = total;
      $('#win-trades').textContent = wins.length;
      $('#win-rate').textContent = `${winRate.toFixed(1)}%`;
      $('#profit-factor').textContent = pf.toFixed(2);
      $('#risk-reward').textContent = rr.toFixed(2);
      $('#total-profit').textContent = `$${(totalWins-totalLoss).toFixed(2)}`;

      if (distributionChart){
        distributionChart.data.datasets[0].data = [wins.length, losses.length, t.filter(x=>x.result===0).length];
        distributionChart.update();
      }
      if (balanceChart){
        const data = []; let bal = 10000;
        for (let i=0;i<7;i++){ if (i<t.length) bal += t[t.length-1-i]?.result||0; data.unshift(bal) }
        balanceChart.data.datasets[0].data = data; balanceChart.update();
      }
      updateRecentTrades(t);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      setDate(); initCharts(); restoreAccordionState();

      // Nav simple
      $$('.nav a').forEach(a=>a.addEventListener('click', e=>{
        e.preventDefault(); const id = a.dataset.target; if (id) setActiveSection(id);
      }));
      // Submenús
      $$('.nav button.nav-link').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('aria-controls'); const panel = document.getElementById(id);
          const isOpen = btn.getAttribute('aria-expanded')==='true';
          btn.setAttribute('aria-expanded', String(!isOpen)); panel.classList.toggle('open', !isOpen); persistAccordionState();
        });
      });

      // Abrir modales
      $('#add-trade-btn')?.addEventListener('click', ()=>openModalById('add-trade-modal'));
      $('#floating-add-trade-btn')?.addEventListener('click', ()=>openModalById('add-trade-modal'));
      $('#quick-add-trade')?.addEventListener('click', (e)=>{ e.preventDefault(); openModalById('add-trade-modal'); });
      $('#add-account-btn')?.addEventListener('click', ()=>openModalById('add-account-modal'));
      $('#btn-open-auth')?.addEventListener('click', ()=>openModalById('auth-modal'));
      $$('[data-close]').forEach(x=>x.addEventListener('click', closeAllModals));
      window.addEventListener('click', e=>{ if (e.target.classList && e.target.classList.contains('modal')) closeAllModals(); });

      // Demo local (sin login): que no reviente
      updateAccountsUI(window.__local.accounts);
      recalcFromTrades(window.__local.tradingData.trades);
    });
  </script>

  <!-- ===== Firebase/Firestore + Auth + Admin (module) ===== -->
  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, updateProfile
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "TU_API_KEY_AQUI",                // <-- pon tu API key real
      authDomain: "journal-infiniti-kapital.firebaseapp.com",
      projectId: "journal-infiniti-kapital",
      storageBucket: "journal-infiniti-kapital.appspot.com",
      appId: "1:78211615687:web:82b05b3ad3dcd6c8e7e2",
      measurementId: "G-D0E8FPMLGQ"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // ---- Auth modal ----
    let authMode = 'login'; // login | register
    function setAuthMode(mode){
      authMode = mode;
      $('#auth-title').textContent = mode==='login' ? 'Iniciar Sesión' : 'Crear Cuenta';
      $('#auth-toggle-mode').textContent = mode==='login' ? 'Crear cuenta' : 'Ya tengo cuenta';
      $('#auth-name-wrap').style.display = mode==='register' ? 'block' : 'none';
      $('#auth-error').classList.add('hidden');
    }
    $('#auth-toggle-mode')?.addEventListener('click', ()=> setAuthMode(authMode==='login' ? 'register' : 'login'));
    $('#auth-submit')?.addEventListener('click', async ()=>{
      const email = $('#auth-email').value.trim();
      const pass  = $('#auth-pass').value.trim();
      const name  = $('#auth-name').value.trim() || 'Trader';
      const err   = $('#auth-error');
      try{
        err.classList.add('hidden');
        if (authMode==='login'){
          await signInWithEmailAndPassword(auth, email, pass);
        } else {
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(cred.user, { displayName: name });
          await setDoc(doc(db, 'users', cred.user.uid), {
            displayName: name, email, role: 'user', createdAt: Date.now()
          });
        }
        document.getElementById('auth-modal')?.classList.remove('show'); document.body.style.overflow='';
      }catch(e){ err.textContent = e.message; err.classList.remove('hidden'); }
    });

    $('#btn-login')?.addEventListener('click', ()=>{ document.getElementById('auth-modal')?.classList.add('show'); document.body.style.overflow='hidden'; });
    $('#btn-logout')?.addEventListener('click', ()=> signOut(auth));

    // ---- Realtime propio ----
    let unsubTrades=null, unsubAccounts=null;
    function bindSelfRealtime(uid){
      unsubTrades && unsubTrades(); unsubAccounts && unsubAccounts();

      const tRef = collection(db, 'users', uid, 'trades');
      unsubTrades = onSnapshot(query(tRef, orderBy('createdAt','desc')), snap=>{
        const trades = snap.docs.map(d=>({id:d.id,...d.data()}));
        window.__currentTrades = trades;
        // Recalcula
        (window.recalcFromTrades || window._noop || (()=>{}))(trades);
      });

      const aRef = collection(db, 'users', uid, 'accounts');
      unsubAccounts = onSnapshot(aRef, snap=>{
        const accounts = snap.docs.map(d=>({id:d.id,...d.data()}));
        window.__currentAccounts = accounts;
        (window.updateAccountsUI || window._noop || (()=>{}))(accounts);
      });
    }

    // Exponer helpers UI globales del primer script
    window.recalcFromTrades = (trades)=>{ 
      // usa la función ya definida en el primer script
      const f = window.eval?.('recalcFromTrades') || window.recalcFromTrades;
      if (f && f !== window.recalcFromTrades) f(trades); else {
        // fallback (si algún navegador bloquea eval)
        const t = trades||[];
        const wins = t.filter(x=>x.result>0), losses = t.filter(x=>x.result<0);
        $('#win-trades').textContent = wins.length;
        $('#total-trades').textContent = t.length;
        $('#total-trades-2').textContent = t.length;
      }
    };

    // ---- Guardar Trade / Account (usa Firestore si hay login, local si no) ----
    async function saveTrade({ pair, type, result, risk, reward, inChallenge }){
      const now = new Date();
      const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
      const user = auth.currentUser;
      if (user){
        await addDoc(collection(db, 'users', user.uid, 'trades'), {
          pair, type, result: Number(result||0), risk: Number(risk||0), reward: Number(reward||0),
          inChallenge: !!inChallenge, createdAt: Date.now(), dateStr
        });
      } else {
        // local (no persistente)
        window.__local.tradingData.trades.unshift({pair,type,result:Number(result||0),risk:Number(risk||0),reward:Number(reward||0),inChallenge:!!inChallenge,dateStr});
        window.recalcFromTrades(window.__local.tradingData.trades);
      }
    }
    async function saveAccount({ name, balance, type }){
      const user = auth.currentUser;
      if (user){
        await addDoc(collection(db, 'users', user.uid, 'accounts'), {
          name, balance: Number(balance||0), type, createdAt: Date.now()
        });
      } else {
        window.__local.accounts.push({name, balance:Number(balance||0), type});
        window.updateAccountsUI(window.__local.accounts);
      }
    }

    // Botones guardar
    $('#save-trade-btn')?.addEventListener('click', async ()=>{
      const data = {
        pair: $('#trade-pair-input').value,
        type: $('#trade-type-input').value,
        result: parseFloat($('#trade-result-input').value)||0,
        risk: parseFloat($('#trade-risk-input').value)||0,
        reward: parseFloat($('#trade-reward-input').value)||0,
        inChallenge: $('#trade-challenge').value==='yes'
      };
      await saveTrade(data);
      // limpiar + cerrar
      $('#trade-result-input').value=''; $('#trade-risk-input').value=''; $('#trade-reward-input').value='';
      document.getElementById('add-trade-modal')?.classList.remove('show'); document.body.style.overflow='';
    });

    $('#save-account-btn')?.addEventListener('click', async ()=>{
      const data = {
        name: $('#account-name').value.trim(),
        balance: parseFloat($('#account-balance').value)||0,
        type: $('#account-type').value
      };
      await saveAccount(data);
      $('#account-name').value=''; $('#account-balance').value=''; $('#account-type').value='principal';
      document.getElementById('add-account-modal')?.classList.remove('show'); document.body.style.overflow='';
    });

    // ---- Panel Admin ----
    async function loadUsersTable(){
      if (!auth.currentUser) return;
      const token = await auth.currentUser.getIdTokenResult(true);
      const role = token.claims.role || 'user';
      if (role !== 'admin') return;

      const tbody = $('#admin-users-tbody'); if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;color:var(--muted)">Cargando…</td></tr>';
      const snap = await getDocs(collection(db, 'users'));
      const rows = [];
      snap.forEach(d=>{
        const u = d.data();
        rows.push(`<tr>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${d.id}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${u.displayName||'—'}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${u.email||'—'}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">${u.role||'user'}</td>
          <td style="padding:8px;border-bottom:1px solid var(--border)">
            <button class="btn secondary btn-open-user" data-uid="${d.id}"><i class="fa-regular fa-folder-open"></i> Abrir</button>
          </td>
        </tr>`);
      });
      tbody.innerHTML = rows.join('') || '<tr><td colspan="5" style="padding:8px;color:var(--muted)">Sin usuarios.</td></tr>';
      $$('.btn-open-user').forEach(btn=> btn.addEventListener('click', ()=> openUserDetail(btn.dataset.uid)) );
    }
    async function openUserDetail(uid){
      $('#admin-user-detail').textContent = `Usuario: ${uid}`;
      $('#admin-user-accounts').textContent = 'Cargando…';
      $('#admin-user-trades').textContent   = 'Cargando…';

      const accSnap = await getDocs(collection(db, 'users', uid, 'accounts'));
      const trdSnap = await getDocs(query(collection(db, 'users', uid, 'trades'), orderBy('createdAt','desc')));
      const accHtml = []; accSnap.forEach(d=>{ const a=d.data(); accHtml.push(`<div style="padding:8px;border-bottom:1px solid var(--border)"><b>${a.name||'Cuenta'}</b> · $${(a.balance||0).toFixed(2)} · ${a.type||'—'}</div>`); });
      $('#admin-user-accounts').innerHTML = accHtml.join('') || '<span style="color:var(--muted)">Sin cuentas</span>';

      const trdHtml = []; trdSnap.forEach(d=>{ const t=d.data(); const sign=(t.result||0)>=0?'+':'-'; const col=(t.result||0)>=0?'var(--success)':'var(--danger)';
        trdHtml.push(`<div style="padding:8px;border-bottom:1px solid var(--border)">${t.dateStr||''} · ${t.pair||'—'} · ${String(t.type||'').toUpperCase()} · <b style="color:${col}">${sign}$${Math.abs(t.result||0).toFixed(2)}</b></div>`); });
      $('#admin-user-trades').innerHTML = trdHtml.join('') || '<span style="color:var(--muted)">Sin trades</span>';
    }
    $('#btn-refresh-users')?.addEventListener('click', loadUsersTable);

    // ---- Sesión ----
    onAuthStateChanged(auth, async (user)=>{
      if (user){
        const token = await user.getIdTokenResult(true);
        const role  = token.claims.role || 'user';
        document.body.classList.toggle('is-admin', role==='admin');
        $('.user-name') && ($('.user-name').textContent = user.displayName || user.email);
        $('#btn-login')?.classList.add('hidden'); $('#btn-logout')?.classList.remove('hidden');
        $('#welcome-message').textContent = "Tu sesión está activa. Tus operaciones se guardarán en la nube.";
        bindSelfRealtime(user.uid);
        if (role==='admin') await loadUsersTable();
      } else {
        document.body.classList.remove('is-admin');
        $('.user-name') && ($('.user-name').textContent = 'Invitado');
        $('#btn-login')?.classList.remove('hidden'); $('#btn-logout')?.classList.add('hidden');
        $('#welcome-message').textContent = "Inicia sesión para guardar tus operaciones en la nube.";
        // Limpia panel admin
        $('#admin-users-tbody') && ($('#admin-users-tbody').innerHTML='');
        $('#admin-user-detail') && ($('#admin-user-detail').textContent='Selecciona un usuario…');
        $('#admin-user-accounts') && ($('#admin-user-accounts').textContent='—');
        $('#admin-user-trades') && ($('#admin-user-trades').textContent='—');
      }
    });
  </script>
</body>
</html>
